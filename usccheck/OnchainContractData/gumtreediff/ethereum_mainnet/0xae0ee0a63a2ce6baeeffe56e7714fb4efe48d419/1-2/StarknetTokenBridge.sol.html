<html lang="en"><head><meta charset="utf8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>GumTree</title><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"><style type="text/css">/*
 * This file is part of GumTree.
 *
 * GumTree is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * GumTree is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with GumTree.  If not, see <http://www.gnu.org/licenses/>.
 *
 * Copyright 2011-2015 Jean-Rémy Falleri <jr.falleri@gmail.com>
 * Copyright 2011-2015 Floréal Morandat <florealm@gmail.com>
 */

.add {
	border: 1px solid black;
	background-color: MediumSeaGreen;
}

.del {
	border: 1px solid black;
	background-color: IndianRed;
}

.mv {
	border: 1px solid black;
	background-color: Plum;
}

.upd {
	border: 1px solid black;
	background-color: DarkOrange;
	font-weight: bold;
}

.cupd {
	font-weight: normal;
	color: DimGray;
}

.selected {
	background-color: Gold;
}

.marker {
	margin: 0;
	padding: 0;
}

div {
	margin: 0px;
	padding: 0px;
}

.pre-scrollable {
	margin: 0px;
	padding: 0px;
	font-size: 10pt;
	color: black;
	max-height: 90vh;
	background-color: white;
	border: 1px solid black;
	font-family: "Hack, Inconsolata", "Consolas", "Liberation Sans Regular", "DejaVu Sans Mono", monospace;
}

.tooltip-inner {
    max-width: none;
}
</style><script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script><script type="text/javascript">/*
 * This file is part of GumTree.
 *
 * GumTree is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * GumTree is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with GumTree.  If not, see <http://www.gnu.org/licenses/>.
 *
 * Copyright 2011-2015 Jean-Rémy Falleri <jr.falleri@gmail.com>
 * Copyright 2011-2015 Floréal Morandat <florealm@gmail.com>
 */

$(function(){
    let popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
    let popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
      return new bootstrap.Popover(popoverTriggerEl)
    })

    $("body").keypress(function (event) {
        switch (event.which) {
            case 116:
                $('html, body').animate({scrollTop: 0}, 100);
                break;
            case 98:
                $("html, body").animate({ scrollTop: $(document).height() }, 100);
                break;
            case 113:
                window.location = "/quit";
                break;
            case 108:
                window.location = "/list";
                break;
        }
    });
});
</script><script type="text/javascript">/*
 * This file is part of GumTree.
 *
 * GumTree is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * GumTree is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with GumTree.  If not, see <http://www.gnu.org/licenses/>.
 *
 * Copyright 2011-2015 Jean-Rémy Falleri <jr.falleri@gmail.com>
 * Copyright 2011-2015 Floréal Morandat <florealm@gmail.com>
 */

currentMapping = 0;

if (typeof String.prototype.startsWith != 'function') {
  String.prototype.startsWith = function (str){
    return this.slice(0, str.length) == str;
  };
}

function getMappedElement(eltId) {
	if (eltId.startsWith("move-src")) {
		return eltId.replace("src","dst");  	 	
  	}
  	else {
  		return eltId.replace("dst","src");
  	}
}

function nextMapping() {
	if (currentMapping == 0) {
		currentMapping = 1;
		return "#mapping-" + currentMapping.toString();
	} else {
		currentMapping++;
		
		if ($("#mapping-" + currentMapping.toString()).length > 0) {
			return "#mapping-" + currentMapping.toString();
		} else {
			currentMapping = 1;
			return "#mapping-" + currentMapping.toString();		
		}		
	}
}

function isSrc(eltId) {
	return eltId.startsWith("move-src");
}

$(function() {
    $("body").keypress(function (event) {
        switch(event.which) {
            case 110:
                const mapping = $(nextMapping());
                const pre = mapping.closest("pre");
                pre.animate({scrollTop: pre.scrollTop() + mapping.position().top - 200}, 100);
                break;
        }
    });

    // highlight
    $("span.mv.token, span.token.upd").click(function(event) {
        if ($(this).hasClass("selected")) {
            $("span.mv.token, span.token.upd").removeClass("selected");
        } else {
            $("span.mv.token, span.token.upd").removeClass("selected");
            const refElt = $("#" + getMappedElement($(this).attr("id")));
            $(this).addClass("selected");
            refElt.addClass("selected");
            const pre = refElt.closest("pre");
            console.log(pre);
            pre.animate({scrollTop: pre.scrollTop() + refElt.position().top - 200}, 100);
        }
        event.stopPropagation();
    });
    
    $("span.add.token, span.token.del").click(function(event) {
        $("span.mv.token, span.token.upd").removeClass("selected");
        event.stopPropagation();
    });

    // tooltip
    $("span.token").hover(
    	function (event) {
    		$(this).tooltip('show');
    		event.stopPropagation();
    	},
    	function (event) {
    		$(this).tooltip('hide');
    		event.stopPropagation();
    	}
    );
});
</script></head><body><div class="container-fluid"><div class="row"><div class="col"><div class="btn-toolbar justify-content-end"><div class="btn-group mr-2"><button class="btn btn-primary btn-sm" id="legend" data-bs-toggle="popover" data-bs-placement="bottom" data-bs-html="true" data-bs-content="<span class='del'>&nbsp;&nbsp;</span> deleted<br><span class='add'>&nbsp;&nbsp;</span> added<br><span class='mv'>&nbsp;&nbsp;</span> moved<br><span class='upd';>&nbsp;&nbsp;</span> updated<br>">Legend</button><button class="btn btn-primary btn-sm" id="shortcuts" data-bs-toggle="popover" data-bs-placement="bottom" data-bs-html="true" data-bs-content="<b>q</b> quit<br><b>l</b> list<br><b>n</b> next<br><b>t</b> top<br><b>b</b> bottom">Shortcuts</button></div><div class="btn-group"><a href="/list" class="btn btn-default btn-sm btn-primary">Back</a><a href="/quit" class="btn btn-default btn-sm btn-danger">Quit</a></div></div></div></div><div class="row"><div class="col-6"><h5>StarknetTokenBridge.sol</h5><pre class="pre-scrollable"><span class="marker" id="mapping-1"></span><span class="token upd" id="move-src-1" data-title="source_file/comment"><span class="cupd">/*
  Copyright 2019-202</span>2<span class="cupd"> StarkWare Industries Ltd.

  Licensed under the Apache License, Version 2.0 (the "License").
  You may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  https://www.starkware.co/open-source-license/

  Unless required by applicable law or agreed to in writing,
  software distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions
  and limitations under the License.
*/</span></span>
// SPDX-License-Identifier: Apache-2.0.
pragma solidity ^0.6.12;

import "GenericGovernance.sol";
import "ContractInitializer.sol";
import "ProxySupport.sol";
import "CairoConstants.sol";
import "StarknetBridgeConstatns.sol";
import "StarknetTokenStorage.sol";
import "IStarknetMessaging.sol";

abstract contract StarknetTokenBridge is
    <span class="marker" id="mapping-2"></span><span class="token mv" id="move-src-2" data-title="contract_declaration/inheritance_specifier">StarknetTokenStorage</span><span class="marker" id="mapping-3"></span><span class="token mv" id="move-src-3" data-title="contract_declaration/,">,</span>
    <span class="marker" id="mapping-4"></span><span class="token upd" id="move-src-4" data-title="user_defined_type/identifier">StarknetBri<span class="cupd">d</span>g<span class="cupd">e</span>Co<span class="cupd">n</span>s<span class="cupd">t</span>atns</span>,
    <span class="marker" id="mapping-5"></span><span class="token mv" id="move-src-5" data-title="contract_declaration/inheritance_specifier">GenericGovernance</span><span class="marker" id="mapping-6"></span><span class="token mv" id="move-src-6" data-title="contract_declaration/,">,</span>
    <span class="marker" id="mapping-7"></span><span class="token upd" id="move-src-7" data-title="user_defined_type/identifier"><span class="cupd">Con</span><span class="cupd">t</span>r<span class="cupd">a</span>ctI<span class="cupd">n</span>itializer</span>,
    ProxySupport
{
    event LogDeposit(address indexed sender, uint256 amount, uint256 indexed l2Recipient);
    event LogDepositCancelRequest(
        address indexed sender,
        uint256 amount,
        uint256 indexed l2Recipient,
        uint256 nonce
    );
    event LogDepositReclaimed(
        address indexed sender,
        uint256 amount,
        uint256 indexed l2Recipient,
        uint256 nonce
    );
    event LogWithdrawal(address indexed recipient, uint256 amount);
    event LogSetL2TokenBridge(uint256 value);
    event LogSetMaxTotalBalance(uint256 value);
    event LogSetMaxDeposit(uint256 value);

    <span class="marker" id="mapping-8"></span><span class="token del" data-title="contract_body/function_definition">function withdraw(<span class="marker" id="mapping-9"></span><span class="token mv" id="move-src-8" data-title="function_definition/parameter">uint256 amount</span>, <span class="marker" id="mapping-10"></span><span class="token mv" id="move-src-9" data-title="function_definition/parameter">address recipient</span>) <span class="marker" id="mapping-11"></span><span class="token mv" id="move-src-10" data-title="function_definition/visibility">public</span> virtual;</span>

    function transferOutFunds(uint256 amount, address recipient) internal virtual;

    /*
      The constructor is in use here only to set the immutable tag in GenericGovernance.
    */
    constructor() internal GenericGovernance(GOVERNANCE_TAG) {}

    function <span class="marker" id="mapping-12"></span><span class="token upd" id="move-src-11" data-title="function_definition/identifier"><span class="cupd">is</span>I<span class="cupd">n</span>i<span class="cupd">t</span>i<span class="cupd">a</span>l<span class="cupd">i</span>z<span class="cupd">ed</span></span>() internal <span class="marker" id="mapping-13"></span><span class="token mv" id="move-src-12" data-title="function_definition/state_mutability">view</span> <span class="marker" id="mapping-14"></span><span class="token mv" id="move-src-13" data-title="function_definition/override_specifier">override</span> returns (bool) <span class="marker" id="mapping-15"></span><span class="token mv" id="move-src-14" data-title="function_definition/function_body">{
        return <span class="marker" id="mapping-16"></span><span class="token mv" id="move-src-15" data-title="return_statement/binary_expression">messagingContract() != IStarknetMessaging(0)</span>;
    }</span>

    function numOfSubContracts() internal pure override returns (uint256) {
        return 0;
    }

    function validateInitData(bytes calldata data) internal <span class="marker" id="mapping-17"></span><span class="token mv" id="move-src-16" data-title="function_definition/state_mutability">pure</span> override {
        require(data.length == 64, "ILLEGAL_DATA_SIZE");
    }

    /*
      No processing needed, as there are no sub-contracts to this contract.
    */
    function processSubContractAddresses(bytes calldata subContractAddresses) internal override {}

    /*
      Gets the addresses of bridgedToken &amp; messagingContract from the ProxySupport initialize(),
      and sets the storage slot accordingly.
    */
    function initializeContractState(bytes calldata data) internal override {
        (address bridgedToken_, <span class="marker" id="mapping-18"></span><span class="token del" data-title="type_name/user_defined_type">IStarknetMessaging</span> messagingContract_) = abi.decode(
            data,
            (address, <span class="marker" id="mapping-19"></span><span class="token del" data-title="tuple_expression/identifier">IStarknetMessaging</span>)
        );
        bridgedToken(bridgedToken_);
        messagingContract(messagingContract_);
    }

    <span class="marker" id="mapping-20"></span><span class="token del" data-title="contract_body/modifier_definition">modifier isValidL2Address(<span class="marker" id="mapping-21"></span><span class="token mv" id="move-src-17" data-title="modifier_definition/parameter">uint256 l2Address</span>) <span class="marker" id="mapping-22"></span><span class="token mv" id="move-src-18" data-title="modifier_definition/function_body">{
        require(<span class="marker" id="mapping-23"></span><span class="token del" data-title="call_argument/binary_expression">l2Address != 0</span>, "L2_ADDRESS_OUT_OF_RANGE");
        <span class="marker" id="mapping-24"></span><span class="token mv" id="move-src-19" data-title="function_body/expression_statement">require(<span class="marker" id="mapping-25"></span><span class="token mv" id="move-src-20" data-title="call_argument/binary_expression">l2Address &lt; CairoConstants.FIELD_PRIME</span>, "L2_ADDRESS_OUT_OF_RANGE");</span>
        <span class="marker" id="mapping-26"></span><span class="token del" data-title="function_body/expression_statement">_;</span>
    }</span></span>

    <span class="marker" id="mapping-27"></span><span class="token mv" id="move-src-21" data-title="contract_body/modifier_definition">modifier <span class="marker" id="mapping-28"></span><span class="token upd" id="move-src-22" data-title="modifier_definition/identifier">l2T<span class="cupd">o</span>ke<span class="cupd">n</span>Bridg<span class="cupd">e</span>N<span class="cupd">o</span>tSet</span>() {
        require(<span class="marker" id="mapping-29"></span><span class="token del" data-title="binary_expression/call_expression">l2TokenBridge()</span> <span class="marker" id="mapping-30"></span><span class="token del" data-title="binary_expression/==">==</span> <span class="marker" id="mapping-31"></span><span class="token del" data-title="binary_expression/number_literal">0</span>, "L2_TOKEN_CONTRACT_ALREADY_SET");
        _;
    }</span>

    modifier <span class="marker" id="mapping-32"></span><span class="token upd" id="move-src-23" data-title="modifier_definition/identifier">l2T<span class="cupd">o</span>ke<span class="cupd">n</span>Br<span class="cupd">i</span>dgeSet</span>() {
        require(<span class="marker" id="mapping-33"></span><span class="token del" data-title="call_argument/binary_expression">l2TokenBridge() != 0</span>, "L2_TOKEN_CONTRACT_NOT_SET");
        _;
    }

    <span class="marker" id="mapping-34"></span><span class="token del" data-title="contract_body/function_definition">function onlyDepositor(<span class="marker" id="mapping-35"></span><span class="token mv" id="move-src-24" data-title="function_definition/parameter">uint256 nonce</span>) <span class="marker" id="mapping-36"></span><span class="token mv" id="move-src-25" data-title="function_definition/visibility">internal</span> <span class="marker" id="mapping-37"></span><span class="token del" data-title="function_definition/function_body">{
        <span class="marker" id="mapping-38"></span><span class="token mv" id="move-src-26" data-title="function_body/expression_statement">require(<span class="marker" id="mapping-39"></span><span class="token mv" id="move-src-27" data-title="binary_expression/array_access">depositors()[nonce]</span> == msg.sender, "ONLY_DEPOSITOR");</span>
    }</span></span>

    function setL2TokenBridge(uint256 l2TokenBridge_)
        external
        <span class="marker" id="mapping-40"></span><span class="token del" data-title="function_definition/modifier_invocation">l2TokenBridgeNotSet</span>
        <span class="marker" id="mapping-41"></span><span class="token del" data-title="function_definition/modifier_invocation">isValidL2Address(<span class="marker" id="mapping-42"></span><span class="token mv" id="move-src-28" data-title="modifier_invocation/call_argument">l2TokenBridge_</span>)</span>
        onlyGovernance
    <span class="marker" id="mapping-43"></span><span class="token del" data-title="function_definition/function_body">{
        <span class="marker" id="mapping-44"></span><span class="token mv" id="move-src-29" data-title="function_body/emit_statement">emit LogSetL2TokenBridge(l2TokenBridge_);</span>
        <span class="marker" id="mapping-45"></span><span class="token mv" id="move-src-30" data-title="function_body/expression_statement">l2TokenBridge(l2TokenBridge_);</span>
    }</span>

    /*
      Sets the maximum allowed balance of the bridge.

      Note: It is possible to set a lower value than the current total balance.
      In this case, deposits will not be possible, until enough withdrawls are done, such that the
      total balance gets below the limit.
    */
    function setMaxTotalBalance(uint256 maxTotalBalance_) external onlyGovernance {
        emit LogSetMaxTotalBalance(maxTotalBalance_);
        maxTotalBalance(maxTotalBalance_);
    }

    function setMaxDeposit(uint256 maxDeposit_) external onlyGovernance {
        emit LogSetMaxDeposit(maxDeposit_);
        maxDeposit(maxDeposit_);
    }

    function depositMessagePayload(uint256 amount, uint256 l2Recipient)
        private
        returns (uint256[] memory)
    {
        uint256[] memory payload = new uint256[](3);
        payload[0] = l2Recipient;
        payload[1] = amount &amp; (UINT256_PART_SIZE - 1);
        payload[2] = amount &gt;&gt; UINT256_PART_SIZE_BITS;
        return payload;
    }

    function sendMessage(uint256 amount, uint256 l2Recipient)
        internal
        <span class="marker" id="mapping-46"></span><span class="token upd" id="move-src-31" data-title="modifier_invocation/identifier">l2T<span class="cupd">o</span>ke<span class="cupd">n</span>Br<span class="cupd">i</span>dgeSet</span>
        <span class="marker" id="mapping-47"></span><span class="token del" data-title="function_definition/modifier_invocation">isValidL2Address(<span class="marker" id="mapping-48"></span><span class="token mv" id="move-src-32" data-title="modifier_invocation/call_argument">l2Recipient</span>)</span>
    {
        require(amount &lt;= maxDeposit(), "TRANSFER_TO_STARKNET_AMOUNT_EXCEEDED");
        <span class="marker" id="mapping-49"></span><span class="token mv" id="move-src-33" data-title="function_body/emit_statement">emit LogDeposit(msg.sender, amount, l2Recipient);</span>

        <span class="marker" id="mapping-50"></span><span class="token del" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-51"></span><span class="token del" data-title="variable_declaration_statement/variable_declaration_tuple">(bool success, bytes memory returndata)</span> = <span class="marker" id="mapping-52"></span><span class="token del" data-title="variable_declaration_statement/call_expression"><span class="marker" id="mapping-53"></span><span class="token del" data-title="call_expression/member_expression"><span class="marker" id="mapping-54"></span><span class="token del" data-title="member_expression/type_cast_expression"><span class="marker" id="mapping-55"></span><span class="token mv" id="move-src-34" data-title="type_cast_expression/primitive_type">address</span>(<span class="marker" id="mapping-56"></span><span class="token del" data-title="type_cast_expression/call_argument">messagingContract()</span>)</span>.staticcall</span>(
            <span class="marker" id="mapping-57"></span><span class="token del" data-title="call_expression/call_argument"><span class="marker" id="mapping-58"></span><span class="token mv" id="move-src-35" data-title="call_argument/call_expression"><span class="marker" id="mapping-59"></span><span class="token del" data-title="call_expression/member_expression">abi.encodeWithSignature</span>("l1ToL2MessageNonce()")</span></span>
        )</span>;</span>
        <span class="marker" id="mapping-60"></span><span class="token del" data-title="function_body/expression_statement">require(success, string(returndata));</span>
        <span class="marker" id="mapping-61"></span><span class="token del" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-62"></span><span class="token mv" id="move-src-36" data-title="variable_declaration_statement/variable_declaration">uint256 nonce</span> = <span class="marker" id="mapping-63"></span><span class="token del" data-title="variable_declaration_statement/call_expression"><span class="marker" id="mapping-64"></span><span class="token mv" id="move-src-37" data-title="call_expression/member_expression">abi.decode</span>(<span class="marker" id="mapping-65"></span><span class="token del" data-title="call_expression/call_argument">returndata</span>, <span class="marker" id="mapping-66"></span><span class="token del" data-title="call_expression/call_argument"><span class="marker" id="mapping-67"></span><span class="token del" data-title="call_argument/parenthesized_expression">(<span class="marker" id="mapping-68"></span><span class="token mv" id="move-src-38" data-title="parenthesized_expression/primitive_type">uint256</span>)</span></span>)</span>;</span>
        <span class="marker" id="mapping-69"></span><span class="token del" data-title="function_body/expression_statement"><span class="marker" id="mapping-70"></span><span class="token mv" id="move-src-39" data-title="expression_statement/call_expression"><span class="marker" id="mapping-71"></span><span class="token mv" id="move-src-40" data-title="call_expression/member_expression">messagingContract().sendMessageToL2</span>(
            l2TokenBridge(),
            DEPOSIT_SELECTOR,
            depositMessagePayload(amount, l2Recipient)
        )</span>;</span>
        require(depositors()[nonce] == address(0x0), "DEPOSIT_ALREADY_REGISTERED");
        depositors()[nonce] = msg.sender;
    }

    function consumeMessage(uint256 amount, address recipient) internal {
        <span class="marker" id="mapping-72"></span><span class="token mv" id="move-src-41" data-title="function_body/emit_statement">emit LogWithdrawal(recipient, amount);</span>

        uint256[] memory payload = new uint256[](4);
        payload[0] = TRANSFER_FROM_STARKNET;
        payload[1] = uint256(recipient);
        payload[2] = amount &amp; (UINT256_PART_SIZE - 1);
        payload[3] = amount &gt;&gt; UINT256_PART_SIZE_BITS;

        messagingContract().consumeMessageFromL2(l2TokenBridge(), payload);
    }

    function withdraw(uint256 amount) external {
        withdraw(amount, msg.sender);
    }

    <span class="marker" id="mapping-73"></span><span class="token upd" id="move-src-42" data-title="contract_body/comment"><span class="cupd">/*
      A deposit cancellation requires two steps:
      1. The depositor should send a depositCancelRequest request with deposit details &amp; nonce.
      2. </span><span class="cupd">After a certain threshold time, (cancellation delay), they can claim back the funds
         by calling depositReclaim (using the same arguments).

      The nonce should be extracted from the LogMessageToL2 event that was emitted by the
      StarknetMessaging contract upon deposit.

      Note: As long as the depositReclaim was not performed, the deposit may be processed,
            even if the cancellation delay time as already passed.
    */</span></span>
    function depositCancelRequest(
        uint256 amount,
        uint256 l2Recipient,
        uint256 nonce
    ) external {
        messagingContract().startL1ToL2MessageCancellation(
            l2TokenBridge(),
            DEPOSIT_SELECTOR,
            depositMessagePayload(amount, l2Recipient),
            nonce
        );

        // Only the depositor is allowed to cancel a deposit.
        <span class="marker" id="mapping-74"></span><span class="token del" data-title="function_body/expression_statement"><span class="marker" id="mapping-75"></span><span class="token del" data-title="expression_statement/call_expression">onlyDepositor(<span class="marker" id="mapping-76"></span><span class="token mv" id="move-src-43" data-title="call_expression/call_argument">nonce</span>)</span>;</span>
        emit LogDepositCancelRequest(msg.sender, amount, l2Recipient, nonce);
    }

    function depositReclaim(
        uint256 amount,
        uint256 l2Recipient,
        uint256 nonce
    ) external {
        messagingContract().cancelL1ToL2Message(
            l2TokenBridge(),
            DEPOSIT_SELECTOR,
            depositMessagePayload(amount, l2Recipient),
            nonce
        );

        <span class="marker" id="mapping-77"></span><span class="token del" data-title="function_body/comment">// Only the depositor is allowed to reclaim cancelled deposit funds.</span>
        <span class="marker" id="mapping-78"></span><span class="token del" data-title="function_body/expression_statement"><span class="marker" id="mapping-79"></span><span class="token del" data-title="expression_statement/call_expression">onlyDepositor(<span class="marker" id="mapping-80"></span><span class="token mv" id="move-src-44" data-title="call_expression/call_argument">nonce</span>)</span>;</span>
        transferOutFunds(amount, msg.sender);
        emit LogDepositReclaimed(msg.sender, amount, l2Recipient, nonce);
    }
}
</pre></div><div class="col-6"><h5>StarknetTokenBridge.sol</h5><pre class="pre-scrollable"><span class="marker" id="mapping-81"></span><span class="token upd" id="move-dst-1" data-title="source_file/comment"><span class="cupd">/*
  Copyright 2019-202</span>3<span class="cupd"> StarkWare Industries Ltd.

  Licensed under the Apache License, Version 2.0 (the "License").
  You may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  https://www.starkware.co/open-source-license/

  Unless required by applicable law or agreed to in writing,
  software distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions
  and limitations under the License.
*/</span></span>
// SPDX-License-Identifier: Apache-2.0.
pragma solidity ^0.6.12;

import "GenericGovernance.sol";
import "Identity.sol";
import "ProxySupport.sol";
import "Addresses.sol";
import "CairoConstants.sol";
import "StarknetBridgeConstants.sol";
import "StarknetTokenStorage.sol";
<span class="marker" id="mapping-82"></span><span class="token add" data-title="source_file/import_directive">import "IStarknetMessaging.sol";</span>

abstract contract StarknetTokenBridge is
    <span class="marker" id="mapping-83"></span><span class="token upd" id="move-dst-4" data-title="user_defined_type/identifier">I<span class="cupd">d</span><span class="cupd">e</span><span class="cupd">n</span><span class="cupd">t</span>ity</span><span class="marker" id="mapping-84"></span><span class="token mv" id="move-dst-3" data-title="contract_declaration/,">,</span>
    <span class="marker" id="mapping-85"></span><span class="token mv" id="move-dst-2" data-title="contract_declaration/inheritance_specifier">StarknetTokenStorage</span>,
    <span class="marker" id="mapping-86"></span><span class="token upd" id="move-dst-7" data-title="user_defined_type/identifier">StarknetBridge<span class="cupd">Con</span>s<span class="cupd">t</span><span class="cupd">a</span><span class="cupd">n</span>ts</span><span class="marker" id="mapping-87"></span><span class="token mv" id="move-dst-6" data-title="contract_declaration/,">,</span>
    <span class="marker" id="mapping-88"></span><span class="token mv" id="move-dst-5" data-title="contract_declaration/inheritance_specifier">GenericGovernance</span>,
    ProxySupport
{
    event LogDeposit(
        address indexed sender,
        uint256 amount,
        uint256 indexed l2Recipient<span class="marker" id="mapping-89"></span><span class="token add" data-title="event_definition/,">,</span>
        <span class="marker" id="mapping-90"></span><span class="token add" data-title="event_definition/event_paramater">uint256 nonce</span><span class="marker" id="mapping-91"></span><span class="token add" data-title="event_definition/,">,</span>
        <span class="marker" id="mapping-92"></span><span class="token add" data-title="event_definition/event_paramater">uint256 fee</span>
    );
    event LogDepositCancelRequest(
        address indexed sender,
        uint256 amount,
        uint256 indexed l2Recipient,
        uint256 nonce
    );
    event LogDepositReclaimed(
        address indexed sender,
        uint256 amount,
        uint256 indexed l2Recipient,
        uint256 nonce
    );
    event LogWithdrawal(address indexed recipient, uint256 amount);
    event LogSetL2TokenBridge(uint256 value);
    event LogSetMaxTotalBalance(uint256 value);
    event LogSetMaxDeposit(uint256 value);
    <span class="marker" id="mapping-93"></span><span class="token add" data-title="contract_body/event_definition">event LogBridgeActivated();</span>

    <span class="marker" id="mapping-94"></span><span class="token add" data-title="contract_body/function_definition">function deposit(uint256 amount, uint256 l2Recipient) external payable virtual;</span>

    function transferOutFunds(uint256 amount, address recipient) internal virtual;

    /*
      The constructor is in use here only to set the immutable tag in GenericGovernance.
    */
    constructor() internal GenericGovernance(GOVERNANCE_TAG) {}

    function <span class="marker" id="mapping-95"></span><span class="token upd" id="move-dst-11" data-title="function_definition/identifier"><span class="cupd">is</span>Toke<span class="cupd">n</span>Con<span class="cupd">t</span>r<span class="cupd">a</span>ctRequ<span class="cupd">i</span>r<span class="cupd">ed</span></span>() internal <span class="marker" id="mapping-96"></span><span class="token mv" id="move-dst-16" data-title="function_definition/state_mutability">pure</span> <span class="marker" id="mapping-97"></span><span class="token add" data-title="function_definition/virtual">virtual</span> returns (bool) <span class="marker" id="mapping-98"></span><span class="token add" data-title="function_definition/function_body">{
        return true;
    }</span>

    <span class="marker" id="mapping-99"></span><span class="token add" data-title="contract_body/function_definition">function isInitialized() <span class="marker" id="mapping-100"></span><span class="token add" data-title="function_definition/visibility">internal</span> <span class="marker" id="mapping-101"></span><span class="token mv" id="move-dst-12" data-title="function_definition/state_mutability">view</span> <span class="marker" id="mapping-102"></span><span class="token mv" id="move-dst-13" data-title="function_definition/override_specifier">override</span> <span class="marker" id="mapping-103"></span><span class="token add" data-title="function_definition/return_type_definition">returns (bool)</span> <span class="marker" id="mapping-104"></span><span class="token mv" id="move-dst-14" data-title="function_definition/function_body">{
        <span class="marker" id="mapping-105"></span><span class="token add" data-title="function_body/if_statement">if (!isTokenContractRequired()) {
            return (messagingContract() != IStarknetMessaging(0));
        }</span>
        return <span class="marker" id="mapping-106"></span><span class="token add" data-title="return_statement/binary_expression"><span class="marker" id="mapping-107"></span><span class="token add" data-title="binary_expression/parenthesized_expression">(<span class="marker" id="mapping-108"></span><span class="token mv" id="move-dst-15" data-title="parenthesized_expression/binary_expression">messagingContract() != IStarknetMessaging(0)</span>)</span> &amp;&amp; <span class="marker" id="mapping-109"></span><span class="token add" data-title="binary_expression/parenthesized_expression">(bridgedToken() != address(0))</span></span>;
    }</span></span>

    function numOfSubContracts() internal pure override returns (uint256) {
        return 0;
    }

    function validateInitData(bytes calldata data) internal <span class="marker" id="mapping-110"></span><span class="token add" data-title="function_definition/state_mutability">view</span> <span class="marker" id="mapping-111"></span><span class="token add" data-title="function_definition/virtual">virtual</span> override {
        require(data.length == 64, "ILLEGAL_DATA_SIZE");
        <span class="marker" id="mapping-112"></span><span class="token add" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-113"></span><span class="token add" data-title="variable_declaration_statement/variable_declaration_tuple">(address bridgedToken_, address messagingContract_)</span> = <span class="marker" id="mapping-114"></span><span class="token add" data-title="variable_declaration_statement/call_expression"><span class="marker" id="mapping-115"></span><span class="token mv" id="move-dst-37" data-title="call_expression/member_expression">abi.decode</span>(<span class="marker" id="mapping-116"></span><span class="token add" data-title="call_expression/call_argument">data</span>, <span class="marker" id="mapping-117"></span><span class="token add" data-title="call_expression/call_argument">(address, address)</span>)</span>;</span>
        <span class="marker" id="mapping-118"></span><span class="token add" data-title="function_body/if_statement">if (isTokenContractRequired()) {
            require(bridgedToken_.isContract(), "INVALID_BRIDGE_TOKEN_ADDRESS");
        } else {
            require(bridgedToken_ == address(0), "NON_ZERO_TOKEN_ADDRESS_PROVIDED");
        }</span>
        <span class="marker" id="mapping-119"></span><span class="token mv" id="move-dst-19" data-title="function_body/expression_statement">require(<span class="marker" id="mapping-120"></span><span class="token add" data-title="call_argument/call_expression">messagingContract_.isContract()</span>, "INVALID_MESSAGING_CONTRACT_ADDRESS");</span>
    }

    /*
      No processing needed, as there are no sub-contracts to this contract.
    */
    function processSubContractAddresses(bytes calldata subContractAddresses) internal override {}

    /*
      Gets the addresses of bridgedToken &amp; messagingContract from the ProxySupport initialize(),
      and sets the storage slot accordingly.
    */
    function initializeContractState(bytes calldata data) internal override {
        (address bridgedToken_, <span class="marker" id="mapping-121"></span><span class="token add" data-title="type_name/primitive_type">address</span> messagingContract_) = abi.decode(data, (address, <span class="marker" id="mapping-122"></span><span class="token mv" id="move-dst-34" data-title="tuple_expression/primitive_type">address</span>));
        bridgedToken(bridgedToken_);
        messagingContract(messagingContract_);
    }

    <span class="marker" id="mapping-123"></span><span class="token add" data-title="contract_body/function_definition">function isValidL2Address(<span class="marker" id="mapping-124"></span><span class="token mv" id="move-dst-17" data-title="function_definition/parameter">uint256 l2Address</span>) <span class="marker" id="mapping-125"></span><span class="token mv" id="move-dst-25" data-title="function_definition/visibility">internal</span> <span class="marker" id="mapping-126"></span><span class="token add" data-title="function_definition/state_mutability">pure</span> <span class="marker" id="mapping-127"></span><span class="token add" data-title="function_definition/return_type_definition">returns (bool)</span> <span class="marker" id="mapping-128"></span><span class="token add" data-title="function_definition/function_body">{
        <span class="marker" id="mapping-129"></span><span class="token add" data-title="function_body/return_statement">return <span class="marker" id="mapping-130"></span><span class="token add" data-title="return_statement/parenthesized_expression">(<span class="marker" id="mapping-131"></span><span class="token add" data-title="parenthesized_expression/binary_expression"><span class="marker" id="mapping-132"></span><span class="token add" data-title="binary_expression/binary_expression">l2Address &gt; 0</span> &amp;&amp; <span class="marker" id="mapping-133"></span><span class="token mv" id="move-dst-20" data-title="binary_expression/binary_expression">l2Address &lt; CairoConstants.FIELD_PRIME</span></span>)</span>;</span>
    }</span></span>

    modifier <span class="marker" id="mapping-134"></span><span class="token upd" id="move-dst-23" data-title="modifier_definition/identifier"><span class="cupd">o</span><span class="cupd">n</span>lyAct<span class="cupd">i</span>ve</span>() {
        require(<span class="marker" id="mapping-135"></span><span class="token add" data-title="call_argument/call_expression">isActive()</span>, "NOT_ACTIVE_YET");
        _;
    }

    <span class="marker" id="mapping-136"></span><span class="token mv" id="move-dst-21" data-title="contract_body/modifier_definition">modifier <span class="marker" id="mapping-137"></span><span class="token upd" id="move-dst-22" data-title="modifier_definition/identifier"><span class="cupd">o</span><span class="cupd">n</span>lyD<span class="cupd">e</span>p<span class="cupd">o</span>sitor</span>(<span class="marker" id="mapping-138"></span><span class="token mv" id="move-dst-24" data-title="modifier_definition/parameter">uint256 nonce</span>) {
        <span class="marker" id="mapping-139"></span><span class="token add" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-140"></span><span class="token add" data-title="variable_declaration_statement/variable_declaration">address depositor_</span> = <span class="marker" id="mapping-141"></span><span class="token mv" id="move-dst-27" data-title="variable_declaration_statement/array_access">depositors()[nonce]</span>;</span>
        require(<span class="marker" id="mapping-142"></span><span class="token add" data-title="binary_expression/identifier">depositor_</span> <span class="marker" id="mapping-143"></span><span class="token add" data-title="binary_expression/!=">!=</span> <span class="marker" id="mapping-144"></span><span class="token add" data-title="binary_expression/type_cast_expression">address(0x0)</span>, "NO_DEPOSIT_TO_CANCEL");
        <span class="marker" id="mapping-145"></span><span class="token mv" id="move-dst-26" data-title="function_body/expression_statement">require(<span class="marker" id="mapping-146"></span><span class="token add" data-title="binary_expression/identifier">depositor_</span> == msg.sender, "ONLY_DEPOSITOR");</span>
        _;
    }</span>

    function setL2TokenBridge(uint256 l2TokenBridge_) external onlyGovernance <span class="marker" id="mapping-147"></span><span class="token mv" id="move-dst-18" data-title="function_definition/function_body">{
        require(<span class="marker" id="mapping-148"></span><span class="token add" data-title="call_argument/call_expression">isInitialized()</span>, "CONTRACT_NOT_INITIALIZED");
        <span class="marker" id="mapping-149"></span><span class="token add" data-title="function_body/expression_statement"><span class="marker" id="mapping-150"></span><span class="token mv" id="move-dst-35" data-title="expression_statement/call_expression"><span class="marker" id="mapping-151"></span><span class="token add" data-title="call_expression/identifier">require</span>(<span class="marker" id="mapping-152"></span><span class="token add" data-title="call_expression/call_argument"><span class="marker" id="mapping-153"></span><span class="token add" data-title="call_argument/call_expression">isValidL2Address(<span class="marker" id="mapping-154"></span><span class="token mv" id="move-dst-28" data-title="call_expression/call_argument">l2TokenBridge_</span>)</span></span><span class="marker" id="mapping-155"></span><span class="token add" data-title="call_expression/,">,</span> "L2_ADDRESS_OUT_OF_RANGE")</span>;</span>
        <span class="marker" id="mapping-156"></span><span class="token mv" id="move-dst-30" data-title="function_body/expression_statement">l2TokenBridge(l2TokenBridge_);</span>
        <span class="marker" id="mapping-157"></span><span class="token add" data-title="function_body/expression_statement">setActive();</span>
        <span class="marker" id="mapping-158"></span><span class="token mv" id="move-dst-29" data-title="function_body/emit_statement">emit LogSetL2TokenBridge(l2TokenBridge_);</span>
        <span class="marker" id="mapping-159"></span><span class="token add" data-title="function_body/emit_statement">emit LogBridgeActivated();</span>
    }</span>

    /*
      Sets the maximum allowed balance of the bridge.

      Note: It is possible to set a lower value than the current total balance.
      In this case, deposits will not be possible, until enough withdrawls are done, such that the
      total balance gets below the limit.
    */
    function setMaxTotalBalance(uint256 maxTotalBalance_) external onlyGovernance {
        emit LogSetMaxTotalBalance(maxTotalBalance_);
        maxTotalBalance(maxTotalBalance_);
    }

    function setMaxDeposit(uint256 maxDeposit_) external onlyGovernance {
        emit LogSetMaxDeposit(maxDeposit_);
        maxDeposit(maxDeposit_);
    }

    function depositMessagePayload(uint256 amount, uint256 l2Recipient)
        private
        <span class="marker" id="mapping-160"></span><span class="token add" data-title="function_definition/state_mutability">pure</span>
        returns (uint256[] memory)
    {
        uint256[] memory payload = new uint256[](3);
        payload[0] = l2Recipient;
        payload[1] = amount &amp; (UINT256_PART_SIZE - 1);
        payload[2] = amount &gt;&gt; UINT256_PART_SIZE_BITS;
        return payload;
    }

    function sendMessage(
        uint256 amount,
        uint256 l2Recipient<span class="marker" id="mapping-161"></span><span class="token add" data-title="function_definition/,">,</span>
        <span class="marker" id="mapping-162"></span><span class="token add" data-title="function_definition/parameter"><span class="marker" id="mapping-163"></span><span class="token add" data-title="parameter/type_name"><span class="marker" id="mapping-164"></span><span class="token mv" id="move-dst-38" data-title="type_name/primitive_type">uint256</span></span> fee</span>
    ) internal <span class="marker" id="mapping-165"></span><span class="token upd" id="move-dst-31" data-title="modifier_invocation/identifier"><span class="cupd">o</span><span class="cupd">n</span>lyAct<span class="cupd">i</span>ve</span> {
        <span class="marker" id="mapping-166"></span><span class="token add" data-title="function_body/expression_statement">require(amount &gt; 0, "ZERO_DEPOSIT");</span>
        <span class="marker" id="mapping-167"></span><span class="token add" data-title="function_body/expression_statement">require(msg.value &gt;= fee, "INSUFFICIENT_MSG_VALUE");</span>
        <span class="marker" id="mapping-168"></span><span class="token add" data-title="function_body/expression_statement"><span class="marker" id="mapping-169"></span><span class="token add" data-title="expression_statement/call_expression">require(<span class="marker" id="mapping-170"></span><span class="token add" data-title="call_expression/call_argument"><span class="marker" id="mapping-171"></span><span class="token add" data-title="call_argument/call_expression">isValidL2Address(<span class="marker" id="mapping-172"></span><span class="token mv" id="move-dst-32" data-title="call_expression/call_argument">l2Recipient</span>)</span></span>, <span class="marker" id="mapping-173"></span><span class="token add" data-title="call_expression/call_argument">"L2_ADDRESS_OUT_OF_RANGE"</span>)</span>;</span>
        require(amount &lt;= maxDeposit(), "TRANSFER_TO_STARKNET_AMOUNT_EXCEEDED");

        <span class="marker" id="mapping-174"></span><span class="token add" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-175"></span><span class="token add" data-title="variable_declaration_statement/variable_declaration_tuple">(, <span class="marker" id="mapping-176"></span><span class="token mv" id="move-dst-36" data-title="variable_declaration_tuple/variable_declaration">uint256 nonce</span>)</span> = <span class="marker" id="mapping-177"></span><span class="token mv" id="move-dst-39" data-title="variable_declaration_statement/call_expression"><span class="marker" id="mapping-178"></span><span class="token add" data-title="call_expression/struct_expression"><span class="marker" id="mapping-179"></span><span class="token mv" id="move-dst-40" data-title="struct_expression/member_expression">messagingContract().sendMessageToL2</span>{<span class="marker" id="mapping-180"></span><span class="token add" data-title="struct_expression/struct_field_assignment">value: fee</span>}</span>(
            l2TokenBridge(),
            DEPOSIT_SELECTOR,
            depositMessagePayload(amount, l2Recipient)
        )</span>;</span>
        require(depositors()[nonce] == address(0x0), "DEPOSIT_ALREADY_REGISTERED");
        depositors()[nonce] = msg.sender;
        <span class="marker" id="mapping-181"></span><span class="token mv" id="move-dst-33" data-title="function_body/emit_statement">emit LogDeposit(msg.sender, amount, l2Recipient<span class="marker" id="mapping-182"></span><span class="token add" data-title="emit_statement/,">,</span> <span class="marker" id="mapping-183"></span><span class="token mv" id="move-dst-43" data-title="emit_statement/call_argument">nonce</span><span class="marker" id="mapping-184"></span><span class="token add" data-title="emit_statement/,">,</span> <span class="marker" id="mapping-185"></span><span class="token add" data-title="emit_statement/call_argument">fee</span>);</span>
    }

    function consumeMessage(uint256 amount, address recipient) internal <span class="marker" id="mapping-186"></span><span class="token add" data-title="function_definition/modifier_invocation">onlyActive</span> {
        uint256[] memory payload = new uint256[](4);
        payload[0] = TRANSFER_FROM_STARKNET;
        payload[1] = uint256(recipient);
        payload[2] = amount &amp; (UINT256_PART_SIZE - 1);
        payload[3] = amount &gt;&gt; UINT256_PART_SIZE_BITS;

        messagingContract().consumeMessageFromL2(l2TokenBridge(), payload);
    }

    <span class="marker" id="mapping-187"></span><span class="token add" data-title="contract_body/function_definition">function withdraw(<span class="marker" id="mapping-188"></span><span class="token mv" id="move-dst-8" data-title="function_definition/parameter">uint256 amount</span>, <span class="marker" id="mapping-189"></span><span class="token mv" id="move-dst-9" data-title="function_definition/parameter">address recipient</span>) <span class="marker" id="mapping-190"></span><span class="token mv" id="move-dst-10" data-title="function_definition/visibility">public</span> <span class="marker" id="mapping-191"></span><span class="token add" data-title="function_definition/function_body">{
        // Make sure we don't accidentally burn funds.
        <span class="marker" id="mapping-192"></span><span class="token add" data-title="function_body/expression_statement">require(recipient != address(0x0), "INVALID_RECIPIENT");</span>

        // The call to consumeMessage will succeed only if a matching L2-&gt;L1 message
        // exists and is ready for consumption.
        <span class="marker" id="mapping-193"></span><span class="token add" data-title="function_body/expression_statement">consumeMessage(amount, recipient);</span>
        <span class="marker" id="mapping-194"></span><span class="token add" data-title="function_body/expression_statement">transferOutFunds(amount, recipient);</span>

        <span class="marker" id="mapping-195"></span><span class="token mv" id="move-dst-41" data-title="function_body/emit_statement">emit LogWithdrawal(recipient, amount);</span>
    }</span></span>

    function withdraw(uint256 amount) external {
        withdraw(amount, msg.sender);
    }

    <span class="marker" id="mapping-196"></span><span class="token upd" id="move-dst-42" data-title="contract_body/comment"><span class="cupd">/*
      A deposit cancellation requires two steps:
      1. The depositor should send a depositCancelRequest request with deposit details &amp; nonce.
      2. </span>Only the depositor is allowed to cancel a deposit.
      3. <span class="cupd">After a certain threshold time, (cancellation delay), they can claim back the funds
         by calling depositReclaim (using the same arguments).

      The nonce should be extracted from the LogMessageToL2 event that was emitted by the
      StarknetMessaging contract upon deposit.

      Note: As long as the depositReclaim was not performed, the deposit may be processed,
            even if the cancellation delay time as already passed.
    */</span></span>
    function depositCancelRequest(
        uint256 amount,
        uint256 l2Recipient,
        uint256 nonce
    ) external <span class="marker" id="mapping-197"></span><span class="token add" data-title="function_definition/modifier_invocation">onlyActive</span> <span class="marker" id="mapping-198"></span><span class="token add" data-title="function_definition/modifier_invocation">onlyDepositor(<span class="marker" id="mapping-199"></span><span class="token mv" id="move-dst-44" data-title="modifier_invocation/call_argument">nonce</span>)</span> {
        messagingContract().startL1ToL2MessageCancellation(
            l2TokenBridge(),
            DEPOSIT_SELECTOR,
            depositMessagePayload(amount, l2Recipient),
            nonce
        );

        // Only the depositor is allowed to cancel a deposit.

        emit LogDepositCancelRequest(msg.sender, amount, l2Recipient, nonce);
    }

    function depositReclaim(
        uint256 amount,
        uint256 l2Recipient,
        uint256 nonce
    ) external <span class="marker" id="mapping-200"></span><span class="token add" data-title="function_definition/modifier_invocation">onlyActive</span> <span class="marker" id="mapping-201"></span><span class="token add" data-title="function_definition/modifier_invocation">onlyDepositor(nonce)</span> {
        messagingContract().cancelL1ToL2Message(
            l2TokenBridge(),
            DEPOSIT_SELECTOR,
            depositMessagePayload(amount, l2Recipient),
            nonce
        );

        transferOutFunds(amount, msg.sender);
        emit LogDepositReclaimed(msg.sender, amount, l2Recipient, nonce);
    }
}
</pre></div></div></div></body></html>