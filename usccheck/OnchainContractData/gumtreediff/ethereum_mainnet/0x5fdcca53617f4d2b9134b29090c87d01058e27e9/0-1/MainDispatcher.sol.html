<html lang="en"><head><meta charset="utf8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>GumTree</title><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"><style type="text/css">/*
 * This file is part of GumTree.
 *
 * GumTree is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * GumTree is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with GumTree.  If not, see <http://www.gnu.org/licenses/>.
 *
 * Copyright 2011-2015 Jean-Rémy Falleri <jr.falleri@gmail.com>
 * Copyright 2011-2015 Floréal Morandat <florealm@gmail.com>
 */

.add {
	border: 1px solid black;
	background-color: MediumSeaGreen;
}

.del {
	border: 1px solid black;
	background-color: IndianRed;
}

.mv {
	border: 1px solid black;
	background-color: Plum;
}

.upd {
	border: 1px solid black;
	background-color: DarkOrange;
	font-weight: bold;
}

.cupd {
	font-weight: normal;
	color: DimGray;
}

.selected {
	background-color: Gold;
}

.marker {
	margin: 0;
	padding: 0;
}

div {
	margin: 0px;
	padding: 0px;
}

.pre-scrollable {
	margin: 0px;
	padding: 0px;
	font-size: 10pt;
	color: black;
	max-height: 90vh;
	background-color: white;
	border: 1px solid black;
	font-family: "Hack, Inconsolata", "Consolas", "Liberation Sans Regular", "DejaVu Sans Mono", monospace;
}

.tooltip-inner {
    max-width: none;
}
</style><script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script><script type="text/javascript">/*
 * This file is part of GumTree.
 *
 * GumTree is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * GumTree is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with GumTree.  If not, see <http://www.gnu.org/licenses/>.
 *
 * Copyright 2011-2015 Jean-Rémy Falleri <jr.falleri@gmail.com>
 * Copyright 2011-2015 Floréal Morandat <florealm@gmail.com>
 */

$(function(){
    let popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
    let popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
      return new bootstrap.Popover(popoverTriggerEl)
    })

    $("body").keypress(function (event) {
        switch (event.which) {
            case 116:
                $('html, body').animate({scrollTop: 0}, 100);
                break;
            case 98:
                $("html, body").animate({ scrollTop: $(document).height() }, 100);
                break;
            case 113:
                window.location = "/quit";
                break;
            case 108:
                window.location = "/list";
                break;
        }
    });
});
</script><script type="text/javascript">/*
 * This file is part of GumTree.
 *
 * GumTree is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * GumTree is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with GumTree.  If not, see <http://www.gnu.org/licenses/>.
 *
 * Copyright 2011-2015 Jean-Rémy Falleri <jr.falleri@gmail.com>
 * Copyright 2011-2015 Floréal Morandat <florealm@gmail.com>
 */

currentMapping = 0;

if (typeof String.prototype.startsWith != 'function') {
  String.prototype.startsWith = function (str){
    return this.slice(0, str.length) == str;
  };
}

function getMappedElement(eltId) {
	if (eltId.startsWith("move-src")) {
		return eltId.replace("src","dst");  	 	
  	}
  	else {
  		return eltId.replace("dst","src");
  	}
}

function nextMapping() {
	if (currentMapping == 0) {
		currentMapping = 1;
		return "#mapping-" + currentMapping.toString();
	} else {
		currentMapping++;
		
		if ($("#mapping-" + currentMapping.toString()).length > 0) {
			return "#mapping-" + currentMapping.toString();
		} else {
			currentMapping = 1;
			return "#mapping-" + currentMapping.toString();		
		}		
	}
}

function isSrc(eltId) {
	return eltId.startsWith("move-src");
}

$(function() {
    $("body").keypress(function (event) {
        switch(event.which) {
            case 110:
                const mapping = $(nextMapping());
                const pre = mapping.closest("pre");
                pre.animate({scrollTop: pre.scrollTop() + mapping.position().top - 200}, 100);
                break;
        }
    });

    // highlight
    $("span.mv.token, span.token.upd").click(function(event) {
        if ($(this).hasClass("selected")) {
            $("span.mv.token, span.token.upd").removeClass("selected");
        } else {
            $("span.mv.token, span.token.upd").removeClass("selected");
            const refElt = $("#" + getMappedElement($(this).attr("id")));
            $(this).addClass("selected");
            refElt.addClass("selected");
            const pre = refElt.closest("pre");
            console.log(pre);
            pre.animate({scrollTop: pre.scrollTop() + refElt.position().top - 200}, 100);
        }
        event.stopPropagation();
    });
    
    $("span.add.token, span.token.del").click(function(event) {
        $("span.mv.token, span.token.upd").removeClass("selected");
        event.stopPropagation();
    });

    // tooltip
    $("span.token").hover(
    	function (event) {
    		$(this).tooltip('show');
    		event.stopPropagation();
    	},
    	function (event) {
    		$(this).tooltip('hide');
    		event.stopPropagation();
    	}
    );
});
</script></head><body><div class="container-fluid"><div class="row"><div class="col"><div class="btn-toolbar justify-content-end"><div class="btn-group mr-2"><button class="btn btn-primary btn-sm" id="legend" data-bs-toggle="popover" data-bs-placement="bottom" data-bs-html="true" data-bs-content="<span class='del'>&nbsp;&nbsp;</span> deleted<br><span class='add'>&nbsp;&nbsp;</span> added<br><span class='mv'>&nbsp;&nbsp;</span> moved<br><span class='upd';>&nbsp;&nbsp;</span> updated<br>">Legend</button><button class="btn btn-primary btn-sm" id="shortcuts" data-bs-toggle="popover" data-bs-placement="bottom" data-bs-html="true" data-bs-content="<b>q</b> quit<br><b>l</b> list<br><b>n</b> next<br><b>t</b> top<br><b>b</b> bottom">Shortcuts</button></div><div class="btn-group"><a href="/list" class="btn btn-default btn-sm btn-primary">Back</a><a href="/quit" class="btn btn-default btn-sm btn-danger">Quit</a></div></div></div></div><div class="row"><div class="col-6"><h5>MainDispatcher.sol</h5><pre class="pre-scrollable"><span class="marker" id="mapping-1"></span><span class="token upd" id="move-src-1" data-title="source_file/comment"><span class="cupd">/*
  Copyright 2019</span>,<span class="cupd">202</span>0<span class="cupd"> StarkWare Industries Ltd.

  Licensed under the Apache License, Version 2.0 (the "License").
  You may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  https://www.starkware.co/open-source-license/

  Unless required by applicable law or agreed to in writing,
  software distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions
  and limitations under the License.
*/</span></span>
pragma solidity ^<span class="marker" id="mapping-2"></span><span class="token upd" id="move-src-2" data-title="solidity_pragma_token/solidity_version"><span class="cupd">0.</span>5.2</span>;

<span class="marker" id="mapping-3"></span><span class="token del" data-title="source_file/import_directive">import "SubContractor.sol";</span>
import "IDispatcher.sol";
import "Common.sol";
<span class="marker" id="mapping-4"></span><span class="token del" data-title="source_file/import_directive">import "StorageSlots.sol";</span>


contract MainDispatcher is <span class="marker" id="mapping-5"></span><span class="token upd" id="move-src-3" data-title="user_defined_type/identifier">ID<span class="cupd">i</span>sp<span class="cupd">a</span>tcher</span>, <span class="marker" id="mapping-6"></span><span class="token upd" id="move-src-4" data-title="user_defined_type/identifier">S<span class="cupd">t</span>o<span class="cupd">r</span><span class="cupd">a</span>geSlots</span> {

    <span class="marker" id="mapping-7"></span><span class="token del" data-title="contract_body/using_directive">using <span class="marker" id="mapping-8"></span><span class="token del" data-title="using_directive/type_alias">Addresses</span> for <span class="marker" id="mapping-9"></span><span class="token mv" id="move-src-5" data-title="using_directive/type_name">address</span>;</span>

    <span class="marker" id="mapping-10"></span><span class="token del" data-title="contract_body/fallback_receive_definition">function() external payable {
        address subContractAddress = getSubContract(msg.sig);
        require(subContractAddress != address(0x0), "NO_CONTRACT_FOR_FUNCTION");

        // solium-disable-next-line security/no-inline-assembly
        assembly {
            // Copy msg.data. We take full control of memory in this inline assembly
            // block because it will not return to Solidity code. We overwrite the
            // Solidity scratch pad at memory position 0.
            calldatacopy(0, 0, calldatasize)

            // Call the implementation.
            // out and outsize are 0 for now, as we don"t know the out size yet.
            let result := delegatecall(gas, subContractAddress, 0, calldatasize, 0, 0)

            // Copy the returned data.
            returndatacopy(0, 0, returndatasize)

            switch result
                // delegatecall returns 0 on error.
                case 0 {
                    revert(0, returndatasize)
                }
                default {
                    return(0, returndatasize)
                }
        }
    }</span>

    <span class="marker" id="mapping-11"></span><span class="token del" data-title="contract_body/comment">/*
      1. Extract subcontracts.
      2. Verify correct sub-contract initializer size.
      3. Extract sub-contract initializer data.
      4. Call sub-contract initializer.

      The init data bytes passed to initialize are structed as following:
      I. N slots (uin256 size) addresses of the deployed sub-contracts.
      II. An address of an external initialization contract (optional, or ZERO_ADDRESS).
      III. (Up to) N bytes sections of the sub-contracts initializers.

      If already initialized (i.e. upgrade) we expect the init data to be consistent with this.
      and if a different size of init data is expected when upgrading, the initializerSize should
      reflect this.

      If an external initializer contract is not used, ZERO_ADDRESS is passed in its slot.
      If the external initializer contract is used, all the remaining init data is passed to it,
      and internal initialization will not occur.

      External Initialization Contract
      --------------------------------
      External Initialization Contract (EIC) is a hook for custom initialization.
      Typically in an upgrade flow, the expected initialization contains only the addresses of
      the sub-contracts. Normal initialization of the sub-contracts is such that is not needed
      in an upgrade, and actually may be very dangerous, as changing of state on a working system
      may corrupt it.

      In the event that some state initialization is required, the EIC is a hook that allows this.
      It may be deployed and called specifically for this purpose.

      The address of the EIC must be provided (if at all) when a new implementation is added to
      a Proxy contract (as part of the initialization vector).
      Hence, it is considered part of the code open to reviewers prior to a time-locked upgrade.

      When a custom initialization is performed using an EIC,
      the main dispatcher initialize extracts and stores the sub-contracts addresses, and then
      yields to the EIC, skipping the rest of its initialization code.


      Flow of MainDispatcher initialize
      ---------------------------------
      1. Extraction and assignment of subcontracts addresses
         Main dispatcher expects a valid and consistent set of addresses in the passed data.
         It validates that, extracts the addresses from the data, and validates that the addresses
         are of the expected type and order. Then those addresses are stored.

      2. Extraction of EIC address
         The address of the EIC is extracted from the data.
         External Initializer Contract is optional. ZERO_ADDRESS indicates it is not used.

      3a. EIC is used
          Dispatcher calls the EIC initialize function with the remaining data.
          Note - In this option 3b is not performed.

      3b. EIC is not used
          If there is additional initialization data then:
          I. Sentitenl function is called to permit subcontracts initialization.
          II. Dispatcher loops through the subcontracts and for each one it extracts the
              initializing data and passes it to the subcontract's initialize function.

    */</span>
    <span class="marker" id="mapping-12"></span><span class="token del" data-title="contract_body/comment">// NOLINTNEXTLINE: external-function.</span>
    <span class="marker" id="mapping-13"></span><span class="token del" data-title="contract_body/function_definition">function initialize(<span class="marker" id="mapping-14"></span><span class="token del" data-title="function_definition/parameter">bytes memory data</span>) <span class="marker" id="mapping-15"></span><span class="token del" data-title="function_definition/visibility">public</span> <span class="marker" id="mapping-16"></span><span class="token del" data-title="function_definition/function_body">{
        // Number of sub-contracts.
        <span class="marker" id="mapping-17"></span><span class="token mv" id="move-src-6" data-title="function_body/variable_declaration_statement">uint256 <span class="marker" id="mapping-18"></span><span class="token upd" id="move-src-7" data-title="variable_declaration/identifier">nS<span class="cupd">ubContract</span>s</span> <span class="marker" id="mapping-19"></span><span class="token del" data-title="variable_declaration_statement/=">=</span> <span class="marker" id="mapping-20"></span><span class="token del" data-title="variable_declaration_statement/call_expression">getNumSubcontracts()</span>;</span>

        // We support currently 4 bits per contract, i.e. 16, reserving 00 leads to 15.
        <span class="marker" id="mapping-21"></span><span class="token del" data-title="function_body/expression_statement">require(nSubContracts &lt;= 15, "TOO_MANY_SUB_CONTRACTS");</span>

        // Init data MUST include addresses for all sub-contracts.
        <span class="marker" id="mapping-22"></span><span class="token del" data-title="function_body/expression_statement">require(data.length &gt;= 32 * (nSubContracts + 1), "SUB_CONTRACTS_NOT_PROVIDED");</span>

        // Ensure implementation is a valid contract.
        <span class="marker" id="mapping-23"></span><span class="token del" data-title="function_body/expression_statement">require(implementation().isContract(), "INVALID_IMPLEMENTATION");</span>

        // Size of passed data, excluding sub-contract addresses.
        <span class="marker" id="mapping-24"></span><span class="token del" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-25"></span><span class="token del" data-title="variable_declaration_statement/variable_declaration"><span class="marker" id="mapping-26"></span><span class="token mv" id="move-src-8" data-title="variable_declaration/type_name">uint256</span> additionalDataSize</span> = <span class="marker" id="mapping-27"></span><span class="token del" data-title="variable_declaration_statement/binary_expression">data.length - 32 * (nSubContracts + 1)</span>;</span>

        // Sum of subcontract initializers. Aggregated for verification near the end.
        <span class="marker" id="mapping-28"></span><span class="token del" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-29"></span><span class="token del" data-title="variable_declaration_statement/variable_declaration"><span class="marker" id="mapping-30"></span><span class="token mv" id="move-src-9" data-title="variable_declaration/type_name">uint256</span> totalInitSizes</span> = 0;</span>

        // Offset (within data) of sub-contract initializer vector.
        // Just past the sub-contract addresses.
        <span class="marker" id="mapping-31"></span><span class="token del" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-32"></span><span class="token del" data-title="variable_declaration_statement/variable_declaration"><span class="marker" id="mapping-33"></span><span class="token mv" id="move-src-10" data-title="variable_declaration/type_name">uint256</span> initDataContractsOffset</span> = <span class="marker" id="mapping-34"></span><span class="token del" data-title="variable_declaration_statement/binary_expression">32 * (nSubContracts + 1)</span>;</span>

        // 1. Extract &amp; update contract addresses.
        <span class="marker" id="mapping-35"></span><span class="token del" data-title="function_body/for_statement">for (<span class="marker" id="mapping-36"></span><span class="token del" data-title="for_statement/variable_declaration_statement"><span class="marker" id="mapping-37"></span><span class="token del" data-title="variable_declaration_statement/variable_declaration"><span class="marker" id="mapping-38"></span><span class="token mv" id="move-src-11" data-title="variable_declaration/type_name">uint256</span> nContract</span> = 1;</span> <span class="marker" id="mapping-39"></span><span class="token del" data-title="for_statement/expression_statement">nContract &lt;= nSubContracts;</span> <span class="marker" id="mapping-40"></span><span class="token del" data-title="for_statement/update_expression">nContract++</span>) <span class="marker" id="mapping-41"></span><span class="token del" data-title="for_statement/block_statement">{
            address contractAddress;

            // Extract sub-contract address.
            // solium-disable-next-line security/no-inline-assembly
            assembly {
                contractAddress := mload(add(data, mul(32, nContract)))
            }

            validateSubContractIndex(nContract, contractAddress);

            // Contracts are indexed from 1 and 0 is not in use here.
            setSubContractAddress(nContract, contractAddress);
        }</span></span>

        // Check if we have an external initializer contract.
        <span class="marker" id="mapping-42"></span><span class="token del" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-43"></span><span class="token del" data-title="variable_declaration_statement/variable_declaration"><span class="marker" id="mapping-44"></span><span class="token mv" id="move-src-12" data-title="variable_declaration/type_name">address</span> externalInitializerAddr</span>;</span>

        // 2. Extract sub-contract address, again. It's cheaper than reading from storage.
        // solium-disable-next-line security/no-inline-assembly
        <span class="marker" id="mapping-45"></span><span class="token del" data-title="function_body/assembly_statement">assembly {
            externalInitializerAddr := mload(add(data, mul(32, add(nSubContracts, 1))))
        }</span>

        // 3(a). Yield to EIC initialization.
        <span class="marker" id="mapping-46"></span><span class="token del" data-title="function_body/if_statement">if (externalInitializerAddr != address(0x0)) {
            callExternalInitializer(data, externalInitializerAddr, additionalDataSize);
            return;
        }</span>

        // 3(b). Subcontracts initialization.
        // I. If no init data passed besides sub-contracts, return.
        <span class="marker" id="mapping-47"></span><span class="token del" data-title="function_body/if_statement">if (additionalDataSize == 0) {
            return;
        }</span>

        // Just to be on the safe side.
        <span class="marker" id="mapping-48"></span><span class="token del" data-title="function_body/expression_statement">assert(externalInitializerAddr == address(0x0));</span>

        // II. Gate further initialization.
        <span class="marker" id="mapping-49"></span><span class="token del" data-title="function_body/expression_statement">initializationSentinel();</span>

        // III. Loops through the subcontracts, extracts their data and calls their initializer.
        <span class="marker" id="mapping-50"></span><span class="token del" data-title="function_body/for_statement">for (<span class="marker" id="mapping-51"></span><span class="token del" data-title="for_statement/variable_declaration_statement">uint256 nContract = 1;</span> <span class="marker" id="mapping-52"></span><span class="token del" data-title="for_statement/expression_statement">nContract &lt;= nSubContracts;</span> <span class="marker" id="mapping-53"></span><span class="token del" data-title="for_statement/update_expression">nContract++</span>) <span class="marker" id="mapping-54"></span><span class="token del" data-title="for_statement/block_statement">{
            <span class="marker" id="mapping-55"></span><span class="token del" data-title="block_statement/variable_declaration_statement">address contractAddress;</span>

            // Extract sub-contract address, again. It's cheaper than reading from storage.
            // solium-disable-next-line security/no-inline-assembly
            <span class="marker" id="mapping-56"></span><span class="token del" data-title="block_statement/assembly_statement">assembly {
                contractAddress := mload(add(data, mul(32, nContract)))
            }</span>
            // The initializerSize returns the expected size, with respect also to the state status.
            // i.e. different size if it's a first init (clean state) or upgrade init (alive state).
            // NOLINTNEXTLINE: calls-loop.

            // The initializerSize is called via delegatecall, so that it can relate to the state,
            // and not only to the new contract code. (e.g. return 0 if state-intialized else 192).
            // solium-disable-next-line security/no-low-level-calls
            // NOLINTNEXTLINE: reentrancy-events low-level-calls calls-loop.
            <span class="marker" id="mapping-57"></span><span class="token del" data-title="block_statement/variable_declaration_statement">(bool success, bytes memory returndata) = contractAddress.delegatecall(
                abi.encodeWithSelector(SubContractor(contractAddress).initializerSize.selector));</span>
            <span class="marker" id="mapping-58"></span><span class="token del" data-title="block_statement/expression_statement">require(success, string(returndata));</span>
            <span class="marker" id="mapping-59"></span><span class="token del" data-title="block_statement/variable_declaration_statement"><span class="marker" id="mapping-60"></span><span class="token del" data-title="variable_declaration_statement/variable_declaration">uint256 initSize</span> = <span class="marker" id="mapping-61"></span><span class="token del" data-title="variable_declaration_statement/call_expression"><span class="marker" id="mapping-62"></span><span class="token del" data-title="call_expression/member_expression">abi.decode</span>(<span class="marker" id="mapping-63"></span><span class="token del" data-title="call_expression/call_argument">returndata</span>, <span class="marker" id="mapping-64"></span><span class="token del" data-title="call_expression/call_argument"><span class="marker" id="mapping-65"></span><span class="token del" data-title="call_argument/parenthesized_expression">(<span class="marker" id="mapping-66"></span><span class="token mv" id="move-src-13" data-title="parenthesized_expression/primitive_type">uint256</span>)</span></span>)</span>;</span>
            <span class="marker" id="mapping-67"></span><span class="token del" data-title="block_statement/expression_statement">require(initSize &lt;= additionalDataSize, "INVALID_INITIALIZER_SIZE");</span>
            <span class="marker" id="mapping-68"></span><span class="token del" data-title="block_statement/expression_statement">require(totalInitSizes + initSize &lt;= additionalDataSize, "INVALID_INITIALIZER_SIZE");</span>

            <span class="marker" id="mapping-69"></span><span class="token del" data-title="block_statement/if_statement">if (initSize == 0) {
                continue;
            }</span>

            // Extract sub-contract init vector.
            <span class="marker" id="mapping-70"></span><span class="token del" data-title="block_statement/variable_declaration_statement">bytes memory subContractInitData = new bytes(initSize);</span>
            <span class="marker" id="mapping-71"></span><span class="token del" data-title="block_statement/for_statement">for (uint256 trgOffset = 32; trgOffset &lt;= initSize; trgOffset += 32) {
                // solium-disable-next-line security/no-inline-assembly
                assembly {
                    mstore(
                        add(subContractInitData, trgOffset),
                        mload(add(add(data, trgOffset), initDataContractsOffset))
                    )
                }
            }</span>

            // Call sub-contract initializer.
            // solium-disable-next-line security/no-low-level-calls
            // NOLINTNEXTLINE: low-level-calls.
            <span class="marker" id="mapping-72"></span><span class="token del" data-title="block_statement/expression_statement">(success, returndata) = contractAddress.delegatecall(
                abi.encodeWithSelector(this.initialize.selector, subContractInitData)
            );</span>
            <span class="marker" id="mapping-73"></span><span class="token del" data-title="block_statement/expression_statement">require(success, string(returndata));</span>
            <span class="marker" id="mapping-74"></span><span class="token del" data-title="block_statement/expression_statement">totalInitSizes += initSize;</span>
            <span class="marker" id="mapping-75"></span><span class="token del" data-title="block_statement/expression_statement">initDataContractsOffset += initSize;</span>
        }</span></span>
        <span class="marker" id="mapping-76"></span><span class="token del" data-title="function_body/expression_statement">require(
            additionalDataSize == totalInitSizes,
            "MISMATCHING_INIT_DATA_SIZE");</span>
    }</span></span>

    <span class="marker" id="mapping-77"></span><span class="token del" data-title="contract_body/function_definition">function callExternalInitializer(
        <span class="marker" id="mapping-78"></span><span class="token del" data-title="function_definition/parameter">bytes memory data</span>,
        <span class="marker" id="mapping-79"></span><span class="token mv" id="move-src-14" data-title="function_definition/parameter">address <span class="marker" id="mapping-80"></span><span class="token upd" id="move-src-15" data-title="parameter/identifier">ex<span class="cupd">t</span>e<span class="cupd">r</span>n<span class="cupd">a</span>lIni<span class="cupd">t</span>ializer<span class="cupd">Addr</span></span></span>,
        <span class="marker" id="mapping-81"></span><span class="token mv" id="move-src-16" data-title="function_definition/parameter">uint256 <span class="marker" id="mapping-82"></span><span class="token upd" id="move-src-17" data-title="parameter/identifier"><span class="cupd">d</span>ataSize</span></span>)
        <span class="marker" id="mapping-83"></span><span class="token del" data-title="function_definition/visibility">private</span> <span class="marker" id="mapping-84"></span><span class="token del" data-title="function_definition/function_body">{
        <span class="marker" id="mapping-85"></span><span class="token del" data-title="function_body/expression_statement">require(externalInitializerAddr.isContract(), "NOT_A_CONTRACT");</span>
        <span class="marker" id="mapping-86"></span><span class="token del" data-title="function_body/expression_statement"><span class="marker" id="mapping-87"></span><span class="token del" data-title="expression_statement/call_expression">require(<span class="marker" id="mapping-88"></span><span class="token del" data-title="call_expression/call_argument">dataSize &lt;= data.length</span>, <span class="marker" id="mapping-89"></span><span class="token mv" id="move-src-18" data-title="call_expression/call_argument">"INVALID_DATA_SIZE"</span>)</span>;</span>
        <span class="marker" id="mapping-90"></span><span class="token del" data-title="function_body/variable_declaration_statement">bytes memory extInitData = new bytes(dataSize);</span>

        // Prepare memcpy pointers.
        <span class="marker" id="mapping-91"></span><span class="token mv" id="move-src-19" data-title="function_body/variable_declaration_statement">uint256 <span class="marker" id="mapping-92"></span><span class="token upd" id="move-src-20" data-title="variable_declaration/identifier">srcDataO<span class="cupd">ffset</span></span> = <span class="marker" id="mapping-93"></span><span class="token del" data-title="binary_expression/binary_expression">32 + data.length</span> <span class="marker" id="mapping-94"></span><span class="token del" data-title="binary_expression/-">-</span> <span class="marker" id="mapping-95"></span><span class="token del" data-title="binary_expression/identifier">dataSize</span>;</span>
        <span class="marker" id="mapping-96"></span><span class="token del" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-97"></span><span class="token mv" id="move-src-21" data-title="variable_declaration_statement/variable_declaration">uint256 <span class="marker" id="mapping-98"></span><span class="token upd" id="move-src-22" data-title="variable_declaration/identifier">sr<span class="cupd">c</span>D<span class="cupd">at</span>a</span></span>;</span>
        <span class="marker" id="mapping-99"></span><span class="token del" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-100"></span><span class="token del" data-title="variable_declaration_statement/variable_declaration"><span class="marker" id="mapping-101"></span><span class="token mv" id="move-src-23" data-title="variable_declaration/type_name">uint256</span> trgData</span>;</span>

        // solium-disable-next-line security/no-inline-assembly
        <span class="marker" id="mapping-102"></span><span class="token del" data-title="function_body/assembly_statement">assembly {
            srcData := add(data, srcDataOffset)
            trgData := add(extInitData, 32)
        }</span>

        // Copy initializer data to be passed to the EIC.
        <span class="marker" id="mapping-103"></span><span class="token del" data-title="function_body/for_statement">for (<span class="marker" id="mapping-104"></span><span class="token del" data-title="for_statement/variable_declaration_statement"><span class="marker" id="mapping-105"></span><span class="token del" data-title="variable_declaration_statement/variable_declaration"><span class="marker" id="mapping-106"></span><span class="token mv" id="move-src-24" data-title="variable_declaration/type_name">uint256</span> seek</span> = 0;</span> <span class="marker" id="mapping-107"></span><span class="token del" data-title="for_statement/expression_statement">seek &lt; dataSize;</span> <span class="marker" id="mapping-108"></span><span class="token del" data-title="for_statement/augmented_assignment_expression">seek += 32</span>) <span class="marker" id="mapping-109"></span><span class="token del" data-title="for_statement/block_statement">{
            // solium-disable-next-line security/no-inline-assembly
            assembly {
                mstore(
                    add(trgData, seek),
                    mload(add(srcData, seek))
                )
            }
        }</span></span>

        // solium-disable-next-line security/no-low-level-calls
        // NOLINTNEXTLINE: low-level-calls.
        <span class="marker" id="mapping-110"></span><span class="token del" data-title="function_body/variable_declaration_statement">(bool success, bytes memory returndata) = externalInitializerAddr.delegatecall(
            abi.encodeWithSelector(this.initialize.selector, extInitData)
        );</span>
        <span class="marker" id="mapping-111"></span><span class="token del" data-title="function_body/expression_statement"><span class="marker" id="mapping-112"></span><span class="token del" data-title="expression_statement/call_expression">require(<span class="marker" id="mapping-113"></span><span class="token del" data-title="call_expression/call_argument">success</span>, <span class="marker" id="mapping-114"></span><span class="token del" data-title="call_expression/call_argument"><span class="marker" id="mapping-115"></span><span class="token del" data-title="call_argument/type_cast_expression"><span class="marker" id="mapping-116"></span><span class="token mv" id="move-src-25" data-title="type_cast_expression/primitive_type">string</span>(<span class="marker" id="mapping-117"></span><span class="token del" data-title="type_cast_expression/call_argument">returndata</span>)</span></span>)</span>;</span>
        <span class="marker" id="mapping-118"></span><span class="token del" data-title="function_body/expression_statement"><span class="marker" id="mapping-119"></span><span class="token del" data-title="expression_statement/call_expression">require(<span class="marker" id="mapping-120"></span><span class="token del" data-title="call_expression/call_argument">returndata.length == 0</span>, <span class="marker" id="mapping-121"></span><span class="token del" data-title="call_expression/call_argument"><span class="marker" id="mapping-122"></span><span class="token del" data-title="call_argument/type_cast_expression"><span class="marker" id="mapping-123"></span><span class="token mv" id="move-src-26" data-title="type_cast_expression/primitive_type">string</span>(<span class="marker" id="mapping-124"></span><span class="token del" data-title="type_cast_expression/call_argument">returndata</span>)</span></span>)</span>;</span>
    }</span></span>
}
</pre></div><div class="col-6"><h5>MainDispatcher.sol</h5><pre class="pre-scrollable"><span class="marker" id="mapping-125"></span><span class="token upd" id="move-dst-1" data-title="source_file/comment"><span class="cupd">/*
  Copyright 2019</span>-<span class="cupd">202</span>1<span class="cupd"> StarkWare Industries Ltd.

  Licensed under the Apache License, Version 2.0 (the "License").
  You may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  https://www.starkware.co/open-source-license/

  Unless required by applicable law or agreed to in writing,
  software distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions
  and limitations under the License.
*/</span></span>
<span class="marker" id="mapping-126"></span><span class="token add" data-title="source_file/comment">// SPDX-License-Identifier: Apache-2.0.</span>
pragma solidity ^<span class="marker" id="mapping-127"></span><span class="token upd" id="move-dst-2" data-title="solidity_pragma_token/solidity_version"><span class="cupd">0.</span>6.11</span>;

import "MainStorage.sol";
import "MainDispatcherBase.sol";

<span class="marker" id="mapping-128"></span><span class="token add" data-title="contract_declaration/abstract">abstract</span> contract MainDispatcher is <span class="marker" id="mapping-129"></span><span class="token upd" id="move-dst-3" data-title="user_defined_type/identifier">Ma<span class="cupd">i</span>nStor<span class="cupd">a</span>ge</span>, <span class="marker" id="mapping-130"></span><span class="token upd" id="move-dst-4" data-title="user_defined_type/identifier">MainDispa<span class="cupd">t</span>che<span class="cupd">r</span>B<span class="cupd">a</span>se</span> {

    <span class="marker" id="mapping-131"></span><span class="token add" data-title="contract_body/state_variable_declaration"><span class="marker" id="mapping-132"></span><span class="token mv" id="move-dst-11" data-title="state_variable_declaration/type_name">uint256</span> constant SUBCONTRACT_BITS = 4;</span>

    <span class="marker" id="mapping-133"></span><span class="token add" data-title="contract_body/function_definition">function magicSalt() <span class="marker" id="mapping-134"></span><span class="token add" data-title="function_definition/visibility">internal</span> <span class="marker" id="mapping-135"></span><span class="token add" data-title="function_definition/state_mutability">pure</span> virtual <span class="marker" id="mapping-136"></span><span class="token add" data-title="function_definition/return_type_definition">returns(<span class="marker" id="mapping-137"></span><span class="token add" data-title="return_type_definition/parameter"><span class="marker" id="mapping-138"></span><span class="token mv" id="move-dst-24" data-title="parameter/type_name">uint256</span></span>)</span>;</span>
    <span class="marker" id="mapping-139"></span><span class="token add" data-title="contract_body/function_definition">function handlerMapSection(<span class="marker" id="mapping-140"></span><span class="token add" data-title="function_definition/parameter"><span class="marker" id="mapping-141"></span><span class="token mv" id="move-dst-9" data-title="parameter/type_name">uint256</span> section</span>) <span class="marker" id="mapping-142"></span><span class="token add" data-title="function_definition/visibility">internal</span> <span class="marker" id="mapping-143"></span><span class="token add" data-title="function_definition/state_mutability">view</span> virtual <span class="marker" id="mapping-144"></span><span class="token add" data-title="function_definition/return_type_definition">returns(<span class="marker" id="mapping-145"></span><span class="token add" data-title="return_type_definition/parameter"><span class="marker" id="mapping-146"></span><span class="token mv" id="move-dst-10" data-title="parameter/type_name">uint256</span></span>)</span>;</span>
    <span class="marker" id="mapping-147"></span><span class="token add" data-title="contract_body/function_definition">function expectedIdByIndex(<span class="marker" id="mapping-148"></span><span class="token add" data-title="function_definition/parameter"><span class="marker" id="mapping-149"></span><span class="token mv" id="move-dst-8" data-title="parameter/type_name">uint256</span> index</span>) <span class="marker" id="mapping-150"></span><span class="token add" data-title="function_definition/visibility">internal</span> <span class="marker" id="mapping-151"></span><span class="token add" data-title="function_definition/state_mutability">pure</span> virtual <span class="marker" id="mapping-152"></span><span class="token add" data-title="function_definition/return_type_definition">returns (<span class="marker" id="mapping-153"></span><span class="token add" data-title="return_type_definition/parameter"><span class="marker" id="mapping-154"></span><span class="token add" data-title="parameter/type_name"><span class="marker" id="mapping-155"></span><span class="token mv" id="move-dst-26" data-title="type_name/primitive_type">string</span></span> memory id</span>)</span>;</span>

    <span class="marker" id="mapping-156"></span><span class="token add" data-title="contract_body/function_definition">function validateSubContractIndex(<span class="marker" id="mapping-157"></span><span class="token add" data-title="function_definition/parameter"><span class="marker" id="mapping-158"></span><span class="token mv" id="move-dst-23" data-title="parameter/type_name">uint256</span> index</span>, <span class="marker" id="mapping-159"></span><span class="token add" data-title="function_definition/parameter"><span class="marker" id="mapping-160"></span><span class="token mv" id="move-dst-5" data-title="parameter/type_name">address</span> subContract</span>) <span class="marker" id="mapping-161"></span><span class="token add" data-title="function_definition/visibility">internal</span> <span class="marker" id="mapping-162"></span><span class="token add" data-title="function_definition/state_mutability">pure</span> <span class="marker" id="mapping-163"></span><span class="token add" data-title="function_definition/override_specifier">override</span> <span class="marker" id="mapping-164"></span><span class="token add" data-title="function_definition/function_body">{
        <span class="marker" id="mapping-165"></span><span class="token add" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-166"></span><span class="token add" data-title="variable_declaration_statement/variable_declaration"><span class="marker" id="mapping-167"></span><span class="token add" data-title="variable_declaration/type_name"><span class="marker" id="mapping-168"></span><span class="token mv" id="move-dst-25" data-title="type_name/primitive_type">string</span></span> memory id</span> = <span class="marker" id="mapping-169"></span><span class="token add" data-title="variable_declaration_statement/call_expression">SubContractor(subContract).identify()</span>;</span>
        <span class="marker" id="mapping-170"></span><span class="token add" data-title="function_body/variable_declaration_statement">bytes32 hashed_expected_id = keccak256(abi.encodePacked(expectedIdByIndex(index)));</span>
        <span class="marker" id="mapping-171"></span><span class="token add" data-title="function_body/expression_statement"><span class="marker" id="mapping-172"></span><span class="token add" data-title="expression_statement/call_expression">require(
            <span class="marker" id="mapping-173"></span><span class="token add" data-title="call_expression/call_argument">hashed_expected_id == keccak256(abi.encodePacked(id))</span>,
            <span class="marker" id="mapping-174"></span><span class="token mv" id="move-dst-18" data-title="call_expression/call_argument">"MISPLACED_INDEX_OR_BAD_CONTRACT_ID"</span>
        )</span>;</span>
    }</span></span>

    <span class="marker" id="mapping-175"></span><span class="token add" data-title="contract_body/function_definition">function getSubContract(<span class="marker" id="mapping-176"></span><span class="token add" data-title="function_definition/parameter">bytes4 selector</span>) <span class="marker" id="mapping-177"></span><span class="token add" data-title="function_definition/visibility">internal</span> <span class="marker" id="mapping-178"></span><span class="token add" data-title="function_definition/state_mutability">view</span> <span class="marker" id="mapping-179"></span><span class="token add" data-title="function_definition/override_specifier">override</span> <span class="marker" id="mapping-180"></span><span class="token add" data-title="function_definition/return_type_definition">returns (<span class="marker" id="mapping-181"></span><span class="token add" data-title="return_type_definition/parameter"><span class="marker" id="mapping-182"></span><span class="token mv" id="move-dst-12" data-title="parameter/type_name">address</span></span>)</span> <span class="marker" id="mapping-183"></span><span class="token add" data-title="function_definition/function_body">{
        <span class="marker" id="mapping-184"></span><span class="token add" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-185"></span><span class="token mv" id="move-dst-21" data-title="variable_declaration_statement/variable_declaration">uint256 <span class="marker" id="mapping-186"></span><span class="token upd" id="move-dst-22" data-title="variable_declaration/identifier">lo<span class="cupd">c</span><span class="cupd">at</span>ion</span></span> = <span class="marker" id="mapping-187"></span><span class="token add" data-title="variable_declaration_statement/binary_expression">0xFF &amp; <span class="marker" id="mapping-188"></span><span class="token add" data-title="binary_expression/type_cast_expression"><span class="marker" id="mapping-189"></span><span class="token mv" id="move-dst-13" data-title="type_cast_expression/primitive_type">uint256</span>(<span class="marker" id="mapping-190"></span><span class="token add" data-title="type_cast_expression/call_argument">keccak256(abi.encodePacked(selector, magicSalt()))</span>)</span></span>;</span>
        <span class="marker" id="mapping-191"></span><span class="token mv" id="move-dst-6" data-title="function_body/variable_declaration_statement">uint256 <span class="marker" id="mapping-192"></span><span class="token upd" id="move-dst-7" data-title="variable_declaration/identifier">s<span class="cupd">ubContract</span>Idx</span>;</span>
        <span class="marker" id="mapping-193"></span><span class="token mv" id="move-dst-19" data-title="function_body/variable_declaration_statement">uint256 <span class="marker" id="mapping-194"></span><span class="token upd" id="move-dst-20" data-title="variable_declaration/identifier">o<span class="cupd">ffset</span></span> = <span class="marker" id="mapping-195"></span><span class="token add" data-title="binary_expression/parenthesized_expression">(SUBCONTRACT_BITS * location)</span> <span class="marker" id="mapping-196"></span><span class="token add" data-title="binary_expression/%">%</span> <span class="marker" id="mapping-197"></span><span class="token add" data-title="binary_expression/number_literal">256</span>;</span>

        // We have 64 locations in each register, hence the &gt;&gt;6 (i.e. location // 64).
        <span class="marker" id="mapping-198"></span><span class="token add" data-title="function_body/expression_statement">subContractIdx = (handlerMapSection(location &gt;&gt; 6) &gt;&gt; offset) &amp; 0xF;</span>
        <span class="marker" id="mapping-199"></span><span class="token add" data-title="function_body/return_statement">return subContracts[subContractIdx];</span>
    }</span></span>

    <span class="marker" id="mapping-200"></span><span class="token add" data-title="contract_body/function_definition">function setSubContractAddress(<span class="marker" id="mapping-201"></span><span class="token mv" id="move-dst-16" data-title="function_definition/parameter">uint256 <span class="marker" id="mapping-202"></span><span class="token upd" id="move-dst-17" data-title="parameter/identifier">in<span class="cupd">d</span>ex</span></span>, <span class="marker" id="mapping-203"></span><span class="token mv" id="move-dst-14" data-title="function_definition/parameter">address <span class="marker" id="mapping-204"></span><span class="token upd" id="move-dst-15" data-title="parameter/identifier">subCon<span class="cupd">t</span><span class="cupd">r</span><span class="cupd">a</span>c<span class="cupd">t</span><span class="cupd">Addr</span>ess</span></span>) <span class="marker" id="mapping-205"></span><span class="token add" data-title="function_definition/visibility">internal</span> <span class="marker" id="mapping-206"></span><span class="token add" data-title="function_definition/override_specifier">override</span> <span class="marker" id="mapping-207"></span><span class="token add" data-title="function_definition/function_body">{
        subContracts[index] = subContractAddress;
    }</span></span>
}
</pre></div></div></div></body></html>