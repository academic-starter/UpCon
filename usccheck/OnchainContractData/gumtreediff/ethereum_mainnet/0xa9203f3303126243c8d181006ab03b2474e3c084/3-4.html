<html lang="en"><head><meta charset="utf8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>GumTree</title><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"><style type="text/css">/*
 * This file is part of GumTree.
 *
 * GumTree is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * GumTree is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with GumTree.  If not, see <http://www.gnu.org/licenses/>.
 *
 * Copyright 2011-2015 Jean-Rémy Falleri <jr.falleri@gmail.com>
 * Copyright 2011-2015 Floréal Morandat <florealm@gmail.com>
 */

.add {
	border: 1px solid black;
	background-color: MediumSeaGreen;
}

.del {
	border: 1px solid black;
	background-color: IndianRed;
}

.mv {
	border: 1px solid black;
	background-color: Plum;
}

.upd {
	border: 1px solid black;
	background-color: DarkOrange;
	font-weight: bold;
}

.cupd {
	font-weight: normal;
	color: DimGray;
}

.selected {
	background-color: Gold;
}

.marker {
	margin: 0;
	padding: 0;
}

div {
	margin: 0px;
	padding: 0px;
}

.pre-scrollable {
	margin: 0px;
	padding: 0px;
	font-size: 10pt;
	color: black;
	max-height: 90vh;
	background-color: white;
	border: 1px solid black;
	font-family: "Hack, Inconsolata", "Consolas", "Liberation Sans Regular", "DejaVu Sans Mono", monospace;
}

.tooltip-inner {
    max-width: none;
}
</style><script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script><script type="text/javascript">/*
 * This file is part of GumTree.
 *
 * GumTree is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * GumTree is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with GumTree.  If not, see <http://www.gnu.org/licenses/>.
 *
 * Copyright 2011-2015 Jean-Rémy Falleri <jr.falleri@gmail.com>
 * Copyright 2011-2015 Floréal Morandat <florealm@gmail.com>
 */

$(function(){
    let popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
    let popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
      return new bootstrap.Popover(popoverTriggerEl)
    })

    $("body").keypress(function (event) {
        switch (event.which) {
            case 116:
                $('html, body').animate({scrollTop: 0}, 100);
                break;
            case 98:
                $("html, body").animate({ scrollTop: $(document).height() }, 100);
                break;
            case 113:
                window.location = "/quit";
                break;
            case 108:
                window.location = "/list";
                break;
        }
    });
});
</script><script type="text/javascript">/*
 * This file is part of GumTree.
 *
 * GumTree is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * GumTree is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with GumTree.  If not, see <http://www.gnu.org/licenses/>.
 *
 * Copyright 2011-2015 Jean-Rémy Falleri <jr.falleri@gmail.com>
 * Copyright 2011-2015 Floréal Morandat <florealm@gmail.com>
 */

currentMapping = 0;

if (typeof String.prototype.startsWith != 'function') {
  String.prototype.startsWith = function (str){
    return this.slice(0, str.length) == str;
  };
}

function getMappedElement(eltId) {
	if (eltId.startsWith("move-src")) {
		return eltId.replace("src","dst");  	 	
  	}
  	else {
  		return eltId.replace("dst","src");
  	}
}

function nextMapping() {
	if (currentMapping == 0) {
		currentMapping = 1;
		return "#mapping-" + currentMapping.toString();
	} else {
		currentMapping++;
		
		if ($("#mapping-" + currentMapping.toString()).length > 0) {
			return "#mapping-" + currentMapping.toString();
		} else {
			currentMapping = 1;
			return "#mapping-" + currentMapping.toString();		
		}		
	}
}

function isSrc(eltId) {
	return eltId.startsWith("move-src");
}

$(function() {
    $("body").keypress(function (event) {
        switch(event.which) {
            case 110:
                const mapping = $(nextMapping());
                const pre = mapping.closest("pre");
                pre.animate({scrollTop: pre.scrollTop() + mapping.position().top - 200}, 100);
                break;
        }
    });

    // highlight
    $("span.mv.token, span.token.upd").click(function(event) {
        if ($(this).hasClass("selected")) {
            $("span.mv.token, span.token.upd").removeClass("selected");
        } else {
            $("span.mv.token, span.token.upd").removeClass("selected");
            const refElt = $("#" + getMappedElement($(this).attr("id")));
            $(this).addClass("selected");
            refElt.addClass("selected");
            const pre = refElt.closest("pre");
            console.log(pre);
            pre.animate({scrollTop: pre.scrollTop() + refElt.position().top - 200}, 100);
        }
        event.stopPropagation();
    });
    
    $("span.add.token, span.token.del").click(function(event) {
        $("span.mv.token, span.token.upd").removeClass("selected");
        event.stopPropagation();
    });

    // tooltip
    $("span.token").hover(
    	function (event) {
    		$(this).tooltip('show');
    		event.stopPropagation();
    	},
    	function (event) {
    		$(this).tooltip('hide');
    		event.stopPropagation();
    	}
    );
});
</script></head><body><div class="container-fluid"><div class="row"><div class="col"><div class="btn-toolbar justify-content-end"><div class="btn-group mr-2"><button class="btn btn-primary btn-sm" id="legend" data-bs-toggle="popover" data-bs-placement="bottom" data-bs-html="true" data-bs-content="<span class='del'>&nbsp;&nbsp;</span> deleted<br><span class='add'>&nbsp;&nbsp;</span> added<br><span class='mv'>&nbsp;&nbsp;</span> moved<br><span class='upd';>&nbsp;&nbsp;</span> updated<br>">Legend</button><button class="btn btn-primary btn-sm" id="shortcuts" data-bs-toggle="popover" data-bs-placement="bottom" data-bs-html="true" data-bs-content="<b>q</b> quit<br><b>l</b> list<br><b>n</b> next<br><b>t</b> top<br><b>b</b> bottom">Shortcuts</button></div><div class="btn-group"><a href="/list" class="btn btn-default btn-sm btn-primary">Back</a><a href="/quit" class="btn btn-default btn-sm btn-danger">Quit</a></div></div></div></div><div class="row"><div class="col-6"><h5>0xe042ce028406ff1912dac006c739dafeda12eb8c.etherscan.io-LandResourceV4.sol</h5><pre class="pre-scrollable"><span class="marker" id="mapping-1"></span><span class="token upd" id="move-src-1" data-title="source_file/comment"><span class="cupd">// </span>F<span class="cupd">ile: openzeppelin-solidity/contracts/math/SafeMath.sol</span></span>

<span class="marker" id="mapping-2"></span><span class="token del" data-title="source_file/pragma_directive">pragma solidity ^0.4.24;</span>


/**
 * @title SafeMath
 * @dev Math operations with safety checks that throw on error
 */
library SafeMath {

  /**
  * @dev Multiplies two numbers, throws on overflow.
  */
  function mul(uint256 _a, uint256 _b) internal pure returns (uint256 c) {
    // Gas optimization: this is cheaper than asserting 'a' not being zero, but the
    // benefit is lost if 'b' is also tested.
    // See: https://github.com/OpenZeppelin/openzeppelin-solidity/pull/522
    if (_a == 0) {
      return 0;
    }

    c = _a * _b;
    assert(c / _a == _b);
    return c;
  }

  /**
  * @dev Integer division of two numbers, truncating the quotient.
  */
  function div(uint256 _a, uint256 _b) internal pure returns (uint256) {
    // assert(_b &gt; 0); // Solidity automatically throws when dividing by 0
    // uint256 c = _a / _b;
    // assert(_a == _b * c + _a % _b); // There is no case in which this doesn't hold
    return _a / _b;
  }

  /**
  * @dev Subtracts two numbers, throws on overflow (i.e. if subtrahend is greater than minuend).
  */
  function sub(uint256 _a, uint256 _b) internal pure returns (uint256) {
    assert(_b &lt;= _a);
    return _a - _b;
  }

  /**
  * @dev Adds two numbers, throws on overflow.
  */
  function add(uint256 _a, uint256 _b) internal pure returns (uint256 c) {
    c = _a + _b;
    assert(c &gt;= _a);
    return c;
  }
}

<span class="marker" id="mapping-3"></span><span class="token mv" id="move-src-2" data-title="source_file/comment"><span class="marker" id="mapping-4"></span><span class="token upd" id="move-src-3" data-title="source_file/comment"><span class="cupd">// </span>File:<span class="cupd"> </span>openzeppelin-<span class="cupd">solidity</span>/contracts/introspection/ERC165.sol</span></span>

<span class="marker" id="mapping-5"></span><span class="token del" data-title="source_file/pragma_directive">pragma solidity ^0.4.24;</span>


/**
 * @title ERC165
 * @dev https://github.com/ethereum/EIPs/blob/master/EIPS/eip-165.md
 */
interface ERC165 {

  /**
   * @notice Query if a contract implements an interface
   * @param _interfaceId The interface identifier, as specified in ERC-165
   * @dev Interface identification is specified in ERC-165. This function
   * uses less than 30,000 gas.
   */
  function supportsInterface(bytes4 _interfaceId)
    external
    view
    returns (bool);
}

<span class="marker" id="mapping-6"></span><span class="token mv" id="move-src-4" data-title="source_file/comment"><span class="marker" id="mapping-7"></span><span class="token upd" id="move-src-5" data-title="source_file/comment"><span class="cupd">// </span>F<span class="cupd">ile: openzeppelin-solidity/contracts/</span><span class="cupd">t</span><span class="cupd">o</span>k<span class="cupd">e</span><span class="cupd">n/ERC</span>72<span class="cupd">1</span>/ERC721Basic<span class="cupd">.sol</span></span></span>

<span class="marker" id="mapping-8"></span><span class="token del" data-title="source_file/pragma_directive">pragma solidity ^0.4.24;</span>



/**
 * @title ERC721 Non-Fungible Token Standard basic interface
 * @dev see https://github.com/ethereum/EIPs/blob/master/EIPS/eip-721.md
 */
contract ERC721Basic is ERC165 {

  bytes4 internal constant InterfaceId_ERC721 = 0x80ac58cd;
  /*
   * 0x80ac58cd ===
   *   bytes4(keccak256('balanceOf(address)')) ^
   *   bytes4(keccak256('ownerOf(uint256)')) ^
   *   bytes4(keccak256('approve(address,uint256)')) ^
   *   bytes4(keccak256('getApproved(uint256)')) ^
   *   bytes4(keccak256('setApprovalForAll(address,bool)')) ^
   *   bytes4(keccak256('isApprovedForAll(address,address)')) ^
   *   bytes4(keccak256('transferFrom(address,address,uint256)')) ^
   *   bytes4(keccak256('safeTransferFrom(address,address,uint256)')) ^
   *   bytes4(keccak256('safeTransferFrom(address,address,uint256,bytes)'))
   */

  bytes4 internal constant InterfaceId_ERC721Exists = 0x4f558e79;
  /*
   * 0x4f558e79 ===
   *   bytes4(keccak256('exists(uint256)'))
   */

  bytes4 internal constant InterfaceId_ERC721Enumerable = 0x780e9d63;
  /**
   * 0x780e9d63 ===
   *   bytes4(keccak256('totalSupply()')) ^
   *   bytes4(keccak256('tokenOfOwnerByIndex(address,uint256)')) ^
   *   bytes4(keccak256('tokenByIndex(uint256)'))
   */

  bytes4 internal constant InterfaceId_ERC721Metadata = 0x5b5e139f;
  /**
   * 0x5b5e139f ===
   *   bytes4(keccak256('name()')) ^
   *   bytes4(keccak256('symbol()')) ^
   *   bytes4(keccak256('tokenURI(uint256)'))
   */

  event Transfer(
    address indexed _from,
    address indexed _to,
    uint256 indexed _tokenId
  );
  event Approval(
    address indexed _owner,
    address indexed _approved,
    uint256 indexed _tokenId
  );
  event ApprovalForAll(
    address indexed _owner,
    address indexed _operator,
    bool _approved
  );

  function balanceOf(address _owner) public view returns (uint256 _balance);
  function ownerOf(uint256 _tokenId) public view returns (address _owner);
  function exists(uint256 _tokenId) public view returns (bool _exists);

  function approve(address _to, uint256 _tokenId) public;
  function getApproved(uint256 _tokenId)
    public view returns (address _operator);

  function setApprovalForAll(address _operator, bool _approved) public;
  function isApprovedForAll(address _owner, address _operator)
    public view returns (bool);

  function transferFrom(address _from, address _to, uint256 _tokenId) public;
  function safeTransferFrom(address _from, address _to, uint256 _tokenId)
    public;

  function safeTransferFrom(
    address _from,
    address _to,
    uint256 _tokenId,
    bytes _data
  )
    public;
}

<span class="marker" id="mapping-9"></span><span class="token mv" id="move-src-6" data-title="source_file/comment"><span class="marker" id="mapping-10"></span><span class="token upd" id="move-src-7" data-title="source_file/comment"><span class="cupd">// </span>File:<span class="cupd"> </span>openzeppelin-<span class="cupd">solidity</span>/contracts/token/ERC721/ERC721.sol</span></span>

<span class="marker" id="mapping-11"></span><span class="token del" data-title="source_file/pragma_directive">pragma solidity ^0.4.24;</span>



/**
 * @title ERC-721 Non-Fungible Token Standard, optional enumeration extension
 * @dev See https://github.com/ethereum/EIPs/blob/master/EIPS/eip-721.md
 */
contract ERC721Enumerable is ERC721Basic {
  function totalSupply() public view returns (uint256);
  function tokenOfOwnerByIndex(
    address _owner,
    uint256 _index
  )
    public
    view
    returns (uint256 _tokenId);

  function tokenByIndex(uint256 _index) public view returns (uint256);
}


/**
 * @title ERC-721 Non-Fungible Token Standard, optional metadata extension
 * @dev See https://github.com/ethereum/EIPs/blob/master/EIPS/eip-721.md
 */
contract ERC721Metadata is ERC721Basic {
  function name() external view returns (string _name);
  function symbol() external view returns (string _symbol);
  function tokenURI(uint256 _tokenId) public view returns (string);
}


/**
 * @title ERC-721 Non-Fungible Token Standard, full implementation interface
 * @dev See https://github.com/ethereum/EIPs/blob/master/EIPS/eip-721.md
 */
contract ERC721 is ERC721Basic, ERC721Enumerable, ERC721Metadata {
}

<span class="marker" id="mapping-12"></span><span class="token mv" id="move-src-8" data-title="source_file/comment"><span class="marker" id="mapping-13"></span><span class="token upd" id="move-src-9" data-title="source_file/comment"><span class="cupd">// </span>F<span class="cupd">ile: openzeppelin-solidity/contracts/</span>in<span class="cupd">t</span>r<span class="cupd">o</span>sp<span class="cupd">e</span>ctio<span class="cupd">n/</span>Support<span class="cupd">s</span>Interfa<span class="cupd">c</span>eWithLookup<span class="cupd">.sol</span></span></span>

<span class="marker" id="mapping-14"></span><span class="token del" data-title="source_file/pragma_directive">pragma solidity ^0.4.24;</span>



/**
 * @title SupportsInterfaceWithLookup
 * @author Matt Condon (@shrugs)
 * @dev Implements ERC165 using a lookup table.
 */
contract SupportsInterfaceWithLookup is ERC165 {

  bytes4 public constant InterfaceId_ERC165 = 0x01ffc9a7;
  /**
   * 0x01ffc9a7 ===
   *   bytes4(keccak256('supportsInterface(bytes4)'))
   */

  /**
   * @dev a mapping of interface id to whether or not it's supported
   */
  mapping(bytes4 =&gt; bool) internal supportedInterfaces;

  /**
   * @dev A contract implementing SupportsInterfaceWithLookup
   * implement ERC165 itself
   */
  constructor()
    public
  {
    _registerInterface(InterfaceId_ERC165);
  }

  /**
   * @dev implement supportsInterface(bytes4) using a lookup table
   */
  function supportsInterface(bytes4 _interfaceId)
    external
    view
    returns (bool)
  {
    return supportedInterfaces[_interfaceId];
  }

  /**
   * @dev private method for registering an interface
   */
  function _registerInterface(bytes4 _interfaceId)
    internal
  {
    require(_interfaceId != 0xffffffff);
    supportedInterfaces[_interfaceId] = true;
  }
}

<span class="marker" id="mapping-15"></span><span class="token mv" id="move-src-10" data-title="source_file/comment"><span class="marker" id="mapping-16"></span><span class="token upd" id="move-src-11" data-title="source_file/comment"><span class="cupd">// </span>File:<span class="cupd"> </span>@ev<span class="cupd">ol</span>ut<span class="cupd">i</span>onlan<span class="cupd">d</span>/common/contracts/<span class="cupd">i</span>n<span class="cupd">t</span>erfaces/IMintableERC2<span class="cupd">0.</span>sol</span></span>

<span class="marker" id="mapping-17"></span><span class="token del" data-title="source_file/pragma_directive">pragma solidity ^0.4.23;</span>

contract IMintableERC20 {

    function mint(address _to, uint256 _value) public;
}

<span class="marker" id="mapping-18"></span><span class="token mv" id="move-src-12" data-title="source_file/comment"><span class="marker" id="mapping-19"></span><span class="token upd" id="move-src-13" data-title="source_file/comment"><span class="cupd">// </span>F<span class="cupd">i</span>le:<span class="cupd"> </span>@<span class="cupd">e</span>vo<span class="cupd">l</span>ut<span class="cupd">i</span><span class="cupd">o</span>n<span class="cupd">l</span>an<span class="cupd">d</span><span class="cupd">/co</span>mmo<span class="cupd">n</span>/con<span class="cupd">tracts/int</span>e<span class="cupd">r</span>face<span class="cupd">s</span>/IS<span class="cupd">e</span><span class="cupd">t</span>t<span class="cupd">i</span><span class="cupd">n</span>gs<span class="cupd">R</span>egistry<span class="cupd">.sol</span></span></span>

<span class="marker" id="mapping-20"></span><span class="token del" data-title="source_file/pragma_directive">pragma solidity ^0.4.24;</span>

contract ISettingsRegistry {
    enum SettingsValueTypes { NONE, UINT, STRING, ADDRESS, BYTES, BOOL, INT }

    function uintOf(bytes32 _propertyName) public view returns (uint256);

    function stringOf(bytes32 _propertyName) public view returns (string);

    function addressOf(bytes32 _propertyName) public view returns (address);

    function bytesOf(bytes32 _propertyName) public view returns (bytes);

    function boolOf(bytes32 _propertyName) public view returns (bool);

    function intOf(bytes32 _propertyName) public view returns (int);

    function setUintProperty(bytes32 _propertyName, uint _value) public;

    function setStringProperty(bytes32 _propertyName, string _value) public;

    function setAddressProperty(bytes32 _propertyName, address _value) public;

    function setBytesProperty(bytes32 _propertyName, bytes _value) public;

    function setBoolProperty(bytes32 _propertyName, bool _value) public;

    function setIntProperty(bytes32 _propertyName, int _value) public;

    function getValueTypeOf(bytes32 _propertyName) public view returns (uint /* SettingsValueTypes */ );

    event ChangeProperty(bytes32 indexed _propertyName, uint256 _type);
}

<span class="marker" id="mapping-21"></span><span class="token mv" id="move-src-14" data-title="source_file/comment"><span class="marker" id="mapping-22"></span><span class="token upd" id="move-src-15" data-title="source_file/comment"><span class="cupd">// </span>F<span class="cupd">ile: </span>@<span class="cupd">e</span>vo<span class="cupd">l</span>ut<span class="cupd">i</span><span class="cupd">o</span>n<span class="cupd">l</span>an<span class="cupd">d</span><span class="cupd">/co</span>mmo<span class="cupd">n</span>/con<span class="cupd">tracts/</span>in<span class="cupd">t</span><span class="cupd">e</span>rfaces<span class="cupd">/</span>IAuthority<span class="cupd">.sol</span></span></span>

<span class="marker" id="mapping-23"></span><span class="token del" data-title="source_file/pragma_directive">pragma solidity ^0.4.24;</span>

contract IAuthority {
    function canCall(
        address src, address dst, bytes4 sig
    ) public view returns (bool);
}

<span class="marker" id="mapping-24"></span><span class="token mv" id="move-src-16" data-title="source_file/comment"><span class="marker" id="mapping-25"></span><span class="token upd" id="move-src-17" data-title="source_file/comment"><span class="cupd">// </span>File:<span class="cupd"> </span>@ev<span class="cupd">ol</span>ut<span class="cupd">i</span>onlan<span class="cupd">d</span>/common/con<span class="cupd">t</span>racts/DSAuth.sol</span></span>

<span class="marker" id="mapping-26"></span><span class="token del" data-title="source_file/pragma_directive">pragma solidity ^0.4.24;</span>


contract DSAuthEvents {
    event LogSetAuthority (address indexed authority);
    event LogSetOwner     (address indexed owner);
}

/**
 * @title DSAuth
 * @dev The DSAuth contract is reference implement of https://github.com/dapphub/ds-auth
 * But in the isAuthorized method, the src from address(this) is remove for safty concern.
 */
contract DSAuth is DSAuthEvents {
    IAuthority   public  authority;
    address      public  owner;

    constructor() public {
        owner = msg.sender;
        emit LogSetOwner(msg.sender);
    }

    function setOwner(address owner_)
        public
        auth
    {
        owner = owner_;
        emit LogSetOwner(owner);
    }

    function setAuthority(IAuthority authority_)
        public
        auth
    {
        authority = authority_;
        emit LogSetAuthority(authority);
    }

    modifier auth {
        require(isAuthorized(msg.sender, msg.sig));
        _;
    }

    modifier onlyOwner() {
        require(msg.sender == owner);
        _;
    }

    function isAuthorized(address src, bytes4 sig) internal view returns (bool) {
        if (src == owner) {
            return true;
        } else if (authority == IAuthority(0)) {
            return false;
        } else {
            return authority.canCall(src, this, sig);
        }
    }
}

<span class="marker" id="mapping-27"></span><span class="token mv" id="move-src-18" data-title="source_file/comment"><span class="marker" id="mapping-28"></span><span class="token upd" id="move-src-19" data-title="source_file/comment"><span class="cupd">// </span>F<span class="cupd">i</span>le:<span class="cupd"> </span>@<span class="cupd">e</span>vo<span class="cupd">l</span>ut<span class="cupd">i</span><span class="cupd">o</span>n<span class="cupd">l</span>an<span class="cupd">d</span><span class="cupd">/co</span>mmo<span class="cupd">n</span>/con<span class="cupd">tracts/</span>S<span class="cupd">e</span>tti<span class="cupd">n</span>gId<span class="cupd">s</span><span class="cupd">.sol</span></span></span>

<span class="marker" id="mapping-29"></span><span class="token del" data-title="source_file/pragma_directive">pragma solidity ^0.4.24;</span>

<span class="marker" id="mapping-30"></span><span class="token mv" id="move-src-20" data-title="source_file/comment"><span class="marker" id="mapping-31"></span><span class="token upd" id="move-src-21" data-title="source_file/comment"><span class="cupd">/</span>**<span class="cupd"></span>
    <span class="cupd">I</span><span class="cupd">d</span> d<span class="cupd">ef</span>inition<span class="cupd">s</span> <span class="cupd">f</span>or <span class="cupd">S</span>ett<span class="cupd">i</span>ngs<span class="cupd">R</span>e<span class="cupd">g</span><span class="cupd">i</span>stry.<span class="cupd">so</span>l
    Can be u<span class="cupd">s</span>e<span class="cupd">d</span> i<span class="cupd">n c</span>onj<span class="cupd">un</span><span class="cupd">c</span>t<span class="cupd">i</span>on <span class="cupd">w</span>ith th<span class="cupd">e</span><span class="cupd"> </span><span class="cupd">s</span>e<span class="cupd">t</span><span class="cupd">t</span>ing<span class="cupd">s</span> re<span class="cupd">g</span><span class="cupd">i</span><span class="cupd">s</span>try to<span class="cupd"> </span><span class="cupd">g</span>et <span class="cupd">p</span><span class="cupd">r</span>operties
*/</span></span>
<span class="marker" id="mapping-32"></span><span class="token del" data-title="source_file/contract_declaration">contract SettingIds <span class="marker" id="mapping-33"></span><span class="token del" data-title="contract_declaration/contract_body">{
    <span class="marker" id="mapping-34"></span><span class="token del" data-title="contract_body/state_variable_declaration"><span class="marker" id="mapping-35"></span><span class="token del" data-title="state_variable_declaration/type_name">bytes32</span> <span class="marker" id="mapping-36"></span><span class="token mv" id="move-src-22" data-title="state_variable_declaration/visibility">public</span> constant CONTRACT_RING_ERC20_TOKEN = <span class="marker" id="mapping-37"></span><span class="token mv" id="move-src-23" data-title="state_variable_declaration/string_literal">"CONTRACT_RING_ERC20_TOKEN"</span>;</span>

    <span class="marker" id="mapping-38"></span><span class="token del" data-title="contract_body/state_variable_declaration"><span class="marker" id="mapping-39"></span><span class="token del" data-title="state_variable_declaration/type_name">bytes32</span> <span class="marker" id="mapping-40"></span><span class="token mv" id="move-src-24" data-title="state_variable_declaration/visibility">public</span> constant CONTRACT_KTON_ERC20_TOKEN = <span class="marker" id="mapping-41"></span><span class="token mv" id="move-src-25" data-title="state_variable_declaration/string_literal">"CONTRACT_KTON_ERC20_TOKEN"</span>;</span>

    <span class="marker" id="mapping-42"></span><span class="token mv" id="move-src-26" data-title="contract_body/state_variable_declaration">bytes32 public constant CONTRACT_GOLD_ERC20_TOKEN = "CONTRACT_GOLD_ERC20_TOKEN";</span>

    <span class="marker" id="mapping-43"></span><span class="token mv" id="move-src-27" data-title="contract_body/state_variable_declaration">bytes32 public constant CONTRACT_WOOD_ERC20_TOKEN = "CONTRACT_WOOD_ERC20_TOKEN";</span>

    <span class="marker" id="mapping-44"></span><span class="token mv" id="move-src-28" data-title="contract_body/state_variable_declaration">bytes32 public constant CONTRACT_WATER_ERC20_TOKEN = "CONTRACT_WATER_ERC20_TOKEN";</span>

    <span class="marker" id="mapping-45"></span><span class="token mv" id="move-src-29" data-title="contract_body/state_variable_declaration">bytes32 public constant CONTRACT_FIRE_ERC20_TOKEN = "CONTRACT_FIRE_ERC20_TOKEN";</span>

    <span class="marker" id="mapping-46"></span><span class="token mv" id="move-src-30" data-title="contract_body/state_variable_declaration">bytes32 public constant CONTRACT_SOIL_ERC20_TOKEN = "CONTRACT_SOIL_ERC20_TOKEN";</span>

    <span class="marker" id="mapping-47"></span><span class="token mv" id="move-src-31" data-title="contract_body/state_variable_declaration">bytes32 public constant CONTRACT_OBJECT_OWNERSHIP = "CONTRACT_OBJECT_OWNERSHIP";</span>

    <span class="marker" id="mapping-48"></span><span class="token del" data-title="contract_body/state_variable_declaration"><span class="marker" id="mapping-49"></span><span class="token del" data-title="state_variable_declaration/type_name">bytes32</span> <span class="marker" id="mapping-50"></span><span class="token mv" id="move-src-32" data-title="state_variable_declaration/visibility">public</span> constant CONTRACT_TOKEN_LOCATION = <span class="marker" id="mapping-51"></span><span class="token mv" id="move-src-33" data-title="state_variable_declaration/string_literal">"CONTRACT_TOKEN_LOCATION"</span>;</span>

    <span class="marker" id="mapping-52"></span><span class="token mv" id="move-src-34" data-title="contract_body/state_variable_declaration">bytes32 public constant CONTRACT_LAND_BASE = "CONTRACT_LAND_BASE";</span>

    <span class="marker" id="mapping-53"></span><span class="token del" data-title="contract_body/state_variable_declaration"><span class="marker" id="mapping-54"></span><span class="token del" data-title="state_variable_declaration/type_name">bytes32</span> <span class="marker" id="mapping-55"></span><span class="token mv" id="move-src-35" data-title="state_variable_declaration/visibility">public</span> constant CONTRACT_USER_POINTS = <span class="marker" id="mapping-56"></span><span class="token mv" id="move-src-36" data-title="state_variable_declaration/string_literal">"CONTRACT_USER_POINTS"</span>;</span>

    <span class="marker" id="mapping-57"></span><span class="token mv" id="move-src-37" data-title="contract_body/state_variable_declaration">bytes32 public constant CONTRACT_INTERSTELLAR_ENCODER = "CONTRACT_INTERSTELLAR_ENCODER";</span>

    <span class="marker" id="mapping-58"></span><span class="token del" data-title="contract_body/state_variable_declaration"><span class="marker" id="mapping-59"></span><span class="token del" data-title="state_variable_declaration/type_name">bytes32</span> <span class="marker" id="mapping-60"></span><span class="token mv" id="move-src-38" data-title="state_variable_declaration/visibility">public</span> constant CONTRACT_DIVIDENDS_POOL = <span class="marker" id="mapping-61"></span><span class="token mv" id="move-src-39" data-title="state_variable_declaration/string_literal">"CONTRACT_DIVIDENDS_POOL"</span>;</span>

    <span class="marker" id="mapping-62"></span><span class="token mv" id="move-src-40" data-title="contract_body/state_variable_declaration">bytes32 public constant CONTRACT_TOKEN_USE = "CONTRACT_TOKEN_USE";</span>

    <span class="marker" id="mapping-63"></span><span class="token del" data-title="contract_body/state_variable_declaration"><span class="marker" id="mapping-64"></span><span class="token del" data-title="state_variable_declaration/type_name">bytes32</span> <span class="marker" id="mapping-65"></span><span class="token mv" id="move-src-41" data-title="state_variable_declaration/visibility">public</span> constant CONTRACT_REVENUE_POOL = <span class="marker" id="mapping-66"></span><span class="token mv" id="move-src-42" data-title="state_variable_declaration/string_literal">"CONTRACT_REVENUE_POOL"</span>;</span>

    <span class="marker" id="mapping-67"></span><span class="token del" data-title="contract_body/state_variable_declaration"><span class="marker" id="mapping-68"></span><span class="token del" data-title="state_variable_declaration/type_name">bytes32</span> <span class="marker" id="mapping-69"></span><span class="token mv" id="move-src-43" data-title="state_variable_declaration/visibility">public</span> constant CONTRACT_ERC721_BRIDGE = <span class="marker" id="mapping-70"></span><span class="token mv" id="move-src-44" data-title="state_variable_declaration/string_literal">"CONTRACT_ERC721_BRIDGE"</span>;</span>

    <span class="marker" id="mapping-71"></span><span class="token del" data-title="contract_body/state_variable_declaration"><span class="marker" id="mapping-72"></span><span class="token del" data-title="state_variable_declaration/type_name">bytes32</span> <span class="marker" id="mapping-73"></span><span class="token mv" id="move-src-45" data-title="state_variable_declaration/visibility">public</span> constant CONTRACT_PET_BASE = <span class="marker" id="mapping-74"></span><span class="token mv" id="move-src-46" data-title="state_variable_declaration/string_literal">"CONTRACT_PET_BASE"</span>;</span>

    // Cut owner takes on each auction, measured in basis points (1/100 of a percent).
    // this can be considered as transaction fee.
    // Values 0-10,000 map to 0%-100%
    // set ownerCut to 4%
    // ownerCut = 400;
    <span class="marker" id="mapping-75"></span><span class="token del" data-title="contract_body/state_variable_declaration"><span class="marker" id="mapping-76"></span><span class="token del" data-title="state_variable_declaration/type_name">bytes32</span> <span class="marker" id="mapping-77"></span><span class="token mv" id="move-src-47" data-title="state_variable_declaration/visibility">public</span> constant UINT_AUCTION_CUT = <span class="marker" id="mapping-78"></span><span class="token mv" id="move-src-48" data-title="state_variable_declaration/string_literal">"UINT_AUCTION_CUT"</span>;</span>  // Denominator is 10000

    <span class="marker" id="mapping-79"></span><span class="token mv" id="move-src-49" data-title="contract_body/state_variable_declaration">bytes32 public constant <span class="marker" id="mapping-80"></span><span class="token upd" id="move-src-50" data-title="state_variable_declaration/identifier"><span class="cupd">UINT_</span><span class="cupd">T</span>OK<span class="cupd">E</span>N<span class="cupd">_</span><span class="cupd">O</span>FF<span class="cupd">E</span>R_<span class="cupd">C</span>UT</span> = "UINT_TOKEN_OFFER_CUT";</span>  // Denominator is 10000

    // Cut referer takes on each auction, measured in basis points (1/100 of a percent).
    // which cut from transaction fee.
    // Values 0-10,000 map to 0%-100%
    // set refererCut to 4%
    // refererCut = 400;
    <span class="marker" id="mapping-81"></span><span class="token mv" id="move-src-51" data-title="contract_body/state_variable_declaration">bytes32 public constant <span class="marker" id="mapping-82"></span><span class="token upd" id="move-src-52" data-title="state_variable_declaration/identifier">UI<span class="cupd">NT</span><span class="cupd">_</span>R<span class="cupd">E</span>F<span class="cupd">E</span>R<span class="cupd">ER</span>_CUT</span> = "UINT_REFERER_CUT";</span>

    <span class="marker" id="mapping-83"></span><span class="token mv" id="move-src-53" data-title="contract_body/state_variable_declaration">bytes32 public constant <span class="marker" id="mapping-84"></span><span class="token upd" id="move-src-54" data-title="state_variable_declaration/identifier">CO<span class="cupd">N</span>TR<span class="cupd">AC</span><span class="cupd">T</span><span class="cupd">_</span>LA<span class="cupd">N</span>D<span class="cupd">_</span>R<span class="cupd">E</span>SOURCE</span> = "CONTRACT_LAND_RESOURCE";</span>
}</span></span>

<span class="marker" id="mapping-85"></span><span class="token mv" id="move-src-55" data-title="source_file/comment"><span class="marker" id="mapping-86"></span><span class="token upd" id="move-src-56" data-title="source_file/comment"><span class="cupd">// </span>File:<span class="cupd"> </span>@ev<span class="cupd">ol</span>ut<span class="cupd">i</span>onlan<span class="cupd">d</span>/common/contracts/<span class="cupd">i</span>n<span class="cupd">t</span>erfaces/IInterstellarEncoder.sol</span></span>

<span class="marker" id="mapping-87"></span><span class="token del" data-title="source_file/pragma_directive">pragma solidity ^0.4.24;</span>

contract IInterstellarEncoder {
    uint256 constant CLEAR_HIGH =  0x00000000000000000000000000000000ffffffffffffffffffffffffffffffff;

    uint256 public constant MAGIC_NUMBER = 42;    // Interstellar Encoding Magic Number.
    uint256 public constant CHAIN_ID = 1; // Ethereum mainet.
    uint256 public constant CURRENT_LAND = 1; // 1 is Atlantis, 0 is NaN.

    enum ObjectClass { 
        NaN,
        LAND,
        APOSTLE,
        OBJECT_CLASS_COUNT
    }

    function registerNewObjectClass(address _objectContract, uint8 objectClass) public;

    function registerNewTokenContract(address _tokenAddress) public;

    function encodeTokenId(address _tokenAddress, uint8 _objectClass, uint128 _objectIndex) public view returns (uint256 _tokenId);

    function encodeTokenIdForObjectContract(
        address _tokenAddress, address _objectContract, uint128 _objectId) public view returns (uint256 _tokenId);

    function getContractAddress(uint256 _tokenId) public view returns (address);

    function getObjectId(uint256 _tokenId) public view returns (uint128 _objectId);

    function getObjectClass(uint256 _tokenId) public view returns (uint8);

    function getObjectAddress(uint256 _tokenId) public view returns (address);
}

<span class="marker" id="mapping-88"></span><span class="token mv" id="move-src-57" data-title="source_file/comment"><span class="marker" id="mapping-89"></span><span class="token upd" id="move-src-58" data-title="source_file/comment"><span class="cupd">// </span>F<span class="cupd">i</span>le:<span class="cupd"> </span>@<span class="cupd">e</span>vo<span class="cupd">l</span>ut<span class="cupd">i</span><span class="cupd">o</span>n<span class="cupd">l</span>an<span class="cupd">d</span><span class="cupd">/co</span>mmo<span class="cupd">n</span>/con<span class="cupd">tracts/int</span><span class="cupd">e</span>rfa<span class="cupd">c</span>es/IT<span class="cupd">o</span>ke<span class="cupd">n</span>Use<span class="cupd">.sol</span></span></span>

<span class="marker" id="mapping-90"></span><span class="token del" data-title="source_file/pragma_directive">pragma solidity ^0.4.24;</span>

contract ITokenUse {
    uint48 public constant MAX_UINT48_TIME = 281474976710655;

    function isObjectInHireStage(uint256 _tokenId) public view returns (bool);

    function isObjectReadyToUse(uint256 _tokenId) public view returns (bool);

    function getTokenUser(uint256 _tokenId) public view returns (address);

    function createTokenUseOffer(uint256 _tokenId, uint256 _duration, uint256 _price, address _acceptedActivity) public;

    function cancelTokenUseOffer(uint256 _tokenId) public;

    function takeTokenUseOffer(uint256 _tokenId) public;

    function addActivity(uint256 _tokenId, address _user, uint256 _endTime) public;

    function removeActivity(uint256 _tokenId, address _user) public;
}

<span class="marker" id="mapping-91"></span><span class="token mv" id="move-src-59" data-title="source_file/comment"><span class="marker" id="mapping-92"></span><span class="token upd" id="move-src-60" data-title="source_file/comment"><span class="cupd">// </span>F<span class="cupd">ile: @evolutionland/common/contracts/interfaces/I</span>Act<span class="cupd">i</span>vi<span class="cupd">t</span>y<span class="cupd">.sol</span></span></span>

<span class="marker" id="mapping-93"></span><span class="token del" data-title="source_file/pragma_directive">pragma solidity ^0.4.24;</span>


contract IActivity is ERC165 {
    bytes4 internal constant InterfaceId_IActivity = 0x6086e7f8; 
    /*
     * 0x6086e7f8 ===
     *   bytes4(keccak256('activityStopped(uint256)'))
     */

    function activityStopped(uint256 _tokenId) public;
}

<span class="marker" id="mapping-94"></span><span class="token mv" id="move-src-61" data-title="source_file/comment"><span class="marker" id="mapping-95"></span><span class="token upd" id="move-src-62" data-title="source_file/comment"><span class="cupd">// </span>File:<span class="cupd"> </span>@ev<span class="cupd">ol</span>ut<span class="cupd">i</span>onlan<span class="cupd">d</span>/common/contracts/<span class="cupd">i</span>n<span class="cupd">t</span>erfaces/IMinerObject.sol</span></span>

<span class="marker" id="mapping-96"></span><span class="token del" data-title="source_file/pragma_directive">pragma solidity ^0.4.24;</span>


contract IMinerObject is ERC165  {
    bytes4 internal constant InterfaceId_IMinerObject = 0x64272b75;
    
    /*
     * 0x64272b752 ===
     *   bytes4(keccak256('strengthOf(uint256,address)'))
     */

    function strengthOf(uint256 _tokenId, address _resourceToken, uint256 _landTokenId) public view returns (uint256);

}

<span class="marker" id="mapping-97"></span><span class="token mv" id="move-src-63" data-title="source_file/comment"><span class="marker" id="mapping-98"></span><span class="token upd" id="move-src-64" data-title="source_file/comment"><span class="cupd">// </span>F<span class="cupd">ile: </span><span class="cupd">co</span><span class="cupd">n</span><span class="cupd">tracts/interfaces/I</span>La<span class="cupd">n</span>dBa<span class="cupd">s</span><span class="cupd">e</span><span class="cupd">.sol</span></span></span>

<span class="marker" id="mapping-99"></span><span class="token del" data-title="source_file/pragma_directive">pragma solidity ^0.4.24;</span>

contract ILandBase {

    /*
     *  Event
     */
    event ModifiedResourceRate(uint indexed tokenId, address resourceToken, uint16 newResourceRate);
    event HasboxSetted(uint indexed tokenId, bool hasBox);

    event ChangedReourceRateAttr(uint indexed tokenId, uint256 attr);

    event ChangedFlagMask(uint indexed tokenId, uint256 newFlagMask);

    event CreatedNewLand(uint indexed tokenId, int x, int y, address beneficiary, uint256 resourceRateAttr, uint256 mask);

    function defineResouceTokenRateAttrId(address _resourceToken, uint8 _attrId) public;

    function setHasBox(uint _landTokenID, bool isHasBox) public;
    function isReserved(uint256 _tokenId) public view returns (bool);
    function isSpecial(uint256 _tokenId) public view returns (bool);
    function isHasBox(uint256 _tokenId) public view returns (bool);

    function getResourceRateAttr(uint _landTokenId) public view returns (uint256);
    function setResourceRateAttr(uint _landTokenId, uint256 _newResourceRateAttr) public;

    function getResourceRate(uint _landTokenId, address _resouceToken) public view returns (uint16);
    function setResourceRate(uint _landTokenID, address _resourceToken, uint16 _newResouceRate) public;

    function getFlagMask(uint _landTokenId) public view returns (uint256);

    function setFlagMask(uint _landTokenId, uint256 _newFlagMask) public;

}

<span class="marker" id="mapping-100"></span><span class="token mv" id="move-src-65" data-title="source_file/comment"><span class="marker" id="mapping-101"></span><span class="token upd" id="move-src-66" data-title="source_file/comment"><span class="cupd">// </span>File: cont<span class="cupd">ra</span>ct<span class="cupd">s</span>/Lan<span class="cupd">d</span>Se<span class="cupd">t</span>tingIds.sol</span></span>

pragma solidity ^0.4.24;


<span class="marker" id="mapping-102"></span><span class="token del" data-title="source_file/contract_declaration">contract LandSettingIds is SettingIds {

}</span>

<span class="marker" id="mapping-103"></span><span class="token mv" id="move-src-67" data-title="source_file/comment"><span class="marker" id="mapping-104"></span><span class="token upd" id="move-src-68" data-title="source_file/comment"><span class="cupd">// </span>F<span class="cupd">ile: </span><span class="cupd">co</span><span class="cupd">n</span><span class="cupd">tracts/</span>La<span class="cupd">n</span>dR<span class="cupd">e</span><span class="cupd">s</span><span class="cupd">o</span>u<span class="cupd">r</span>ceV4<span class="cupd">.sol</span></span></span>

<span class="marker" id="mapping-105"></span><span class="token del" data-title="source_file/pragma_directive">pragma solidity ^0.4.23;</span>














<span class="marker" id="mapping-106"></span><span class="token mv" id="move-src-69" data-title="source_file/comment"><span class="marker" id="mapping-107"></span><span class="token upd" id="move-src-70" data-title="source_file/comment"><span class="cupd">/</span>**<span class="cupd"></span>
 * @title LandReso<span class="cupd">u</span>rce
 * @dev<span class="cupd"> </span>LandResource is <span class="cupd">r</span>egistry tha<span class="cupd">t </span>mana<span class="cupd">g</span>e the element <span class="cupd">re</span>sources generated on Land, and <span class="cupd">r</span>elated resource rele<span class="cupd">a</span>sing sp<span class="cupd">e</span>ed.
 <span class="cupd">*</span> difference<span class="cupd"> </span>betw<span class="cupd">e</span>en LandResourceV2:
  <span class="cupd"> </span>  1. add function landWorkingOn to get which land the apostle is working on
     2. add function updateMinerStrength to update miner strength on land
     3. add event UpdateMiningStrength
 */</span></span>


contract <span class="marker" id="mapping-108"></span><span class="token upd" id="move-src-71" data-title="contract_declaration/identifier"><span class="cupd">LandResourceV</span>4</span> is SupportsInterfaceWithLookup, DSAuth, IActivity<span class="marker" id="mapping-109"></span><span class="token del" data-title="contract_declaration/,">,</span> <span class="marker" id="mapping-110"></span><span class="token del" data-title="contract_declaration/inheritance_specifier">LandSettingIds</span> {
    using SafeMath for *;

    // For every seconds, the speed will decrease by current speed multiplying (DENOMINATOR_in_seconds - seconds) / DENOMINATOR_in_seconds
    // resource will decrease 1/10000 every day.
    uint256 public constant DENOMINATOR = 10000;

    uint256 public constant TOTAL_SECONDS = DENOMINATOR * (1 days);

    bool private singletonLock = false;

    ISettingsRegistry public registry;

    uint256 public resourceReleaseStartTime;

    // TODO: move to global settings contract.
    uint256 public attenPerDay = 1;
    uint256 public recoverAttenPerDay = 20;

    // Struct for recording resouces on land which have already been pinged.
    // 金, Evolution Land Gold
    // 木, Evolution Land Wood
    // 水, Evolution Land Water
    // 火, Evolution Land fire
    // 土, Evolution Land Silicon
    struct ResourceMineState {
        mapping(address =&gt; uint256) mintedBalance;
        mapping(address =&gt; uint256[]) miners;
        mapping(address =&gt; uint256) totalMinerStrength;
        uint256 lastUpdateSpeedInSeconds;
        uint256 lastDestoryAttenInSeconds;
        uint256 industryIndex;
        uint128 lastUpdateTime;
        uint64 totalMiners;
        uint64 maxMiners;
    }

    struct MinerStatus {
        uint256 landTokenId;
        address resource;
        uint64 indexInResource;
    }

    mapping(uint256 =&gt; ResourceMineState) public land2ResourceMineState;

    mapping(uint256 =&gt; MinerStatus) public miner2Index;

    <span class="marker" id="mapping-111"></span><span class="token upd" id="move-src-72" data-title="contract_body/comment"><span class="cupd">/*
 </span>   <span class="cupd"> *  Event
</span>   <span class="cupd">  </span>*/</span>

    event StartMining(uint256 minerTokenId, uint256 <span class="marker" id="mapping-112"></span><span class="token upd" id="move-src-73" data-title="event_paramater/identifier"><span class="cupd">land</span>Token<span class="cupd">Id</span></span>, address _resource, uint256 strength);
    event StopMining(uint256 minerTokenId, uint256 <span class="marker" id="mapping-113"></span><span class="token upd" id="move-src-74" data-title="event_paramater/identifier"><span class="cupd">land</span>Token<span class="cupd">Id</span></span>, address _resource, uint256 strength);
    event ResourceClaimed(address owner, uint256 landTokenId, uint256 goldBalance, uint256 woodBalance, uint256 waterBalance, uint256 fireBalance, uint256 soilBalance);

    event UpdateMiningStrengthWhenStop(uint256 apostleTokenId, uint256 <span class="marker" id="mapping-114"></span><span class="token upd" id="move-src-75" data-title="event_paramater/identifier"><span class="cupd">land</span>Token<span class="cupd">Id</span></span>, uint256 strength);
    event UpdateMiningStrengthWhenStart(uint256 apostleTokenId, uint256 <span class="marker" id="mapping-115"></span><span class="token upd" id="move-src-76" data-title="event_paramater/identifier"><span class="cupd">land</span>Token<span class="cupd">Id</span></span>, uint256 strength);
    <span class="marker" id="mapping-116"></span><span class="token upd" id="move-src-77" data-title="contract_body/comment"><span class="cupd">/</span>*<span class="cupd"></span><span class="cupd">
</span><span class="cupd"> </span>    *  Modifiers
     */</span>
    modifier singletonLockCall() {
        require(!singletonLock, "Only can call once");
        _;
        singletonLock = true;
    }


    function initializeContract(address _registry, uint256 _resourceReleaseStartTime) public singletonLockCall {
        // Ownable constructor
        owner = msg.sender;
        emit LogSetOwner(msg.sender);

        registry = ISettingsRegistry(_registry);

        resourceReleaseStartTime = _resourceReleaseStartTime;

        _registerInterface(InterfaceId_IActivity);
    }

    // get amount of speed uint at this moment
    function _getReleaseSpeedInSeconds(uint256 _tokenId, uint256 _time) internal view returns (uint256 currentSpeed) {
        require(_time &gt;= resourceReleaseStartTime, "Should after release time");
        require(_time &gt;= land2ResourceMineState[_tokenId].lastUpdateTime, "Should after release last update time");

        // after 10000 days from start
        // the resource release speed decreases to 0
        if (TOTAL_SECONDS &lt; _time - resourceReleaseStartTime)
        {
            return 0;
        }

        // max amount of speed unit of _tokenId for now
        // suppose that speed_uint = 1 in this function
        uint256 availableSpeedInSeconds = TOTAL_SECONDS.sub(_time - resourceReleaseStartTime);
        <span class="marker" id="mapping-117"></span><span class="token upd" id="move-src-78" data-title="function_body/comment"><span class="cupd">// </span><span class="cupd">time from last update</span></span>
        <span class="marker" id="mapping-118"></span><span class="token del" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-119"></span><span class="token mv" id="move-src-79" data-title="variable_declaration_statement/variable_declaration">uint256 <span class="marker" id="mapping-120"></span><span class="token upd" id="move-src-80" data-title="variable_declaration/identifier">time<span class="cupd">B</span>etween</span></span> = <span class="marker" id="mapping-121"></span><span class="token del" data-title="variable_declaration_statement/member_expression">_time - land2ResourceMineState[_tokenId].lastUpdateTime</span>;</span>

        <span class="marker" id="mapping-122"></span><span class="token upd" id="move-src-81" data-title="function_body/comment"><span class="cupd">// </span><span class="cupd">t</span>he<span class="cupd"> </span>r<span class="cupd">e</span>cov<span class="cupd">e</span>r sp<span class="cupd">ee</span>d is 20/10000, 20 times.</span>
        <span class="marker" id="mapping-123"></span><span class="token upd" id="move-src-82" data-title="function_body/comment"><span class="cupd">// </span>recoveryRa<span class="cupd">t</span><span class="cupd">e </span>overall<span class="cupd"> </span>from <span class="cupd">la</span>sUp<span class="cupd">d</span>at<span class="cupd">e</span>T<span class="cupd">i</span>m<span class="cupd">e</span> <span class="cupd">t</span>il now + <span class="cupd">a</span>moun<span class="cupd">t</span> <span class="cupd">o</span>f sp<span class="cupd">e</span>e<span class="cupd">d</span> uint at <span class="cupd">lastUpdateTime</span></span>
        <span class="marker" id="mapping-124"></span><span class="token del" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-125"></span><span class="token mv" id="move-src-83" data-title="variable_declaration_statement/variable_declaration">uint256 <span class="marker" id="mapping-126"></span><span class="token upd" id="move-src-84" data-title="variable_declaration/identifier">n<span class="cupd">e</span>xtSpeedInSeconds</span></span> = <span class="marker" id="mapping-127"></span><span class="token del" data-title="variable_declaration_statement/binary_expression">land2ResourceMineState[_tokenId].lastUpdateSpeedInSeconds + timeBetween * recoverAttenPerDay</span>;</span>
        <span class="marker" id="mapping-128"></span><span class="token upd" id="move-src-85" data-title="function_body/comment"><span class="cupd">// </span>d<span class="cupd">e</span>st<span class="cupd">r</span>oyRat<span class="cupd">e</span> <span class="cupd">over</span>all<span class="cupd"> </span>from la<span class="cupd">s</span>U<span class="cupd">p</span>dat<span class="cupd">e</span>Tim<span class="cupd">e</span><span class="cupd"> </span>t<span class="cupd">i</span>l now amount of <span class="cupd">s</span>peed<span class="cupd"> </span>uint<span class="cupd"> </span>at<span class="cupd"> </span>las<span class="cupd">t</span>UpdateT<span class="cupd">ime</span></span>
        <span class="marker" id="mapping-129"></span><span class="token mv" id="move-src-86" data-title="function_body/variable_declaration_statement">uint256 <span class="marker" id="mapping-130"></span><span class="token upd" id="move-src-87" data-title="variable_declaration/identifier"><span class="cupd">d</span>estroyedSpeedI<span class="cupd">n</span>Seconds</span> = <span class="marker" id="mapping-131"></span><span class="token del" data-title="variable_declaration_statement/member_expression">timeBetween * land2ResourceMineState[_tokenId].lastDestoryAttenInSeconds</span>;</span>

        <span class="marker" id="mapping-132"></span><span class="token del" data-title="function_body/if_statement">if (nextSpeedInSeconds &lt; destroyedSpeedInSeconds)
        {
            nextSpeedInSeconds = 0;
        } else {
            nextSpeedInSeconds = nextSpeedInSeconds - destroyedSpeedInSeconds;
        }</span>

        <span class="marker" id="mapping-133"></span><span class="token del" data-title="function_body/if_statement">if (nextSpeedInSeconds &gt; availableSpeedInSeconds) {
            nextSpeedInSeconds = availableSpeedInSeconds;
        }</span>

        <span class="marker" id="mapping-134"></span><span class="token mv" id="move-src-88" data-title="function_body/return_statement">return <span class="marker" id="mapping-135"></span><span class="token upd" id="move-src-89" data-title="return_statement/identifier">n<span class="cupd">e</span>xt<span class="cupd">SpeedInSeconds</span></span>;</span>
    }

    function getReleaseSpeed(uint256 _tokenId, address <span class="marker" id="mapping-136"></span><span class="token upd" id="move-src-90" data-title="parameter/identifier"><span class="cupd">_resource</span>Token</span>, uint256 _time) public view returns (uint256 currentSpeed) {
        return <span class="marker" id="mapping-137"></span><span class="token mv" id="move-src-91" data-title="return_statement/call_expression">ILandBase(registry.addressOf(CONTRACT_LAND_BASE))
        .getResourceRate(_tokenId, <span class="marker" id="mapping-138"></span><span class="token upd" id="move-src-92" data-title="call_argument/identifier"><span class="cupd">_resource</span>Token</span>).mul(_getReleaseSpeedInSeconds(_tokenId, _time))
        .<span class="marker" id="mapping-139"></span><span class="token upd" id="move-src-93" data-title="member_expression/identifier">div</span>(<span class="marker" id="mapping-140"></span><span class="token mv" id="move-src-94" data-title="call_expression/call_argument">TOTAL_SECONDS</span>)</span>;
    }

    <span class="marker" id="mapping-141"></span><span class="token mv" id="move-src-95" data-title="contract_body/comment"><span class="marker" id="mapping-142"></span><span class="token upd" id="move-src-96" data-title="contract_body/comment"><span class="cupd">/</span>**<span class="cupd"></span>
     * @dev Get<span class="cupd"> and</span> Query<span class="cupd"> </span>t<span class="cupd">h</span>e <span class="cupd">a</span>moun<span class="cupd">t</span> of resources avail<span class="cupd">a</span>ble from <span class="cupd">l</span>astUpdateTime to now for use on specific land.
     * @param _tokenId The token id of specific land.
    */</span></span>
    function _getMinableBalance(uint256 _tokenId, address <span class="marker" id="mapping-143"></span><span class="token upd" id="move-src-97" data-title="parameter/identifier"><span class="cupd">_resource</span>Token</span>, uint256 _currentTime, uint256 _lastUpdateTime) public view returns (uint256 minableBalance) {

        uint256 speed_in_current_period = ILandBase(registry.addressOf(CONTRACT_LAND_BASE))
        .getResourceRate(_tokenId, <span class="marker" id="mapping-144"></span><span class="token upd" id="move-src-98" data-title="call_argument/identifier"><span class="cupd">_resource</span>Token</span>).mul(_getReleaseSpeedInSeconds(_tokenId, ((_currentTime + _lastUpdateTime) / 2))).mul(1 ether).div(1 days).div(TOTAL_SECONDS);

        // calculate the area of trapezoid
        minableBalance = speed_in_current_period.mul(_currentTime - _lastUpdateTime);
    }

    function _getMaxMineBalance(uint256 _tokenId, address <span class="marker" id="mapping-145"></span><span class="token upd" id="move-src-99" data-title="parameter/identifier"><span class="cupd">_resource</span>Token</span>, uint256 _currentTime, uint256 _lastUpdateTime) internal view returns (uint256) {
        // totalMinerStrength is in wei
        <span class="marker" id="mapping-146"></span><span class="token mv" id="move-src-100" data-title="function_body/variable_declaration_statement">uint256 <span class="marker" id="mapping-147"></span><span class="token upd" id="move-src-101" data-title="variable_declaration/identifier">mi<span class="cupd">n</span>eSpeed</span> = <span class="marker" id="mapping-148"></span><span class="token del" data-title="variable_declaration_statement/array_access">land2ResourceMineState[_tokenId].totalMinerStrength[_resourceToken]</span>;</span>

        return <span class="marker" id="mapping-149"></span><span class="token del" data-title="member_expression/identifier">mineSpeed</span>.mul(_currentTime - _lastUpdateTime).div(1 days);
    }

    function mine(uint256 _landTokenId) public {
        _mineAllResource(
            _landTokenId,
            registry.addressOf(CONTRACT_GOLD_ERC20_TOKEN),
            registry.addressOf(CONTRACT_WOOD_ERC20_TOKEN),
            registry.addressOf(CONTRACT_WATER_ERC20_TOKEN),
            registry.addressOf(CONTRACT_FIRE_ERC20_TOKEN),
            registry.addressOf(CONTRACT_SOIL_ERC20_TOKEN)
        );
    }

    function _mineAllResource(uint256 _landTokenId, address _gold, address _wood, address _water, address _fire, address _soil) internal {
        require(IInterstellarEncoder(registry.addressOf(CONTRACT_INTERSTELLAR_ENCODER)).getObjectClass(_landTokenId) == 1, "Token must be land.");

        <span class="marker" id="mapping-150"></span><span class="token del" data-title="function_body/if_statement">if (<span class="marker" id="mapping-151"></span><span class="token del" data-title="if_statement/binary_expression">land2ResourceMineState[_landTokenId].lastUpdateTime == 0</span>) <span class="marker" id="mapping-152"></span><span class="token del" data-title="if_statement/block_statement">{
            <span class="marker" id="mapping-153"></span><span class="token del" data-title="block_statement/expression_statement"><span class="marker" id="mapping-154"></span><span class="token del" data-title="expression_statement/assignment_expression"><span class="marker" id="mapping-155"></span><span class="token del" data-title="assignment_expression/member_expression">land2ResourceMineState[_landTokenId].lastUpdateTime</span> = <span class="marker" id="mapping-156"></span><span class="token del" data-title="assignment_expression/type_cast_expression"><span class="marker" id="mapping-157"></span><span class="token mv" id="move-src-102" data-title="type_cast_expression/primitive_type">uint128</span>(<span class="marker" id="mapping-158"></span><span class="token del" data-title="type_cast_expression/call_argument">resourceReleaseStartTime</span>)</span></span>;</span>
            <span class="marker" id="mapping-159"></span><span class="token del" data-title="block_statement/expression_statement">land2ResourceMineState[_landTokenId].lastUpdateSpeedInSeconds = TOTAL_SECONDS;</span>
        }</span></span>

        _mineResource(_landTokenId, _gold);
        _mineResource(_landTokenId, _wood);
        _mineResource(_landTokenId, _water);
        _mineResource(_landTokenId, _fire);
        _mineResource(_landTokenId, _soil);

        <span class="marker" id="mapping-160"></span><span class="token del" data-title="function_body/expression_statement"><span class="marker" id="mapping-161"></span><span class="token del" data-title="expression_statement/assignment_expression"><span class="marker" id="mapping-162"></span><span class="token del" data-title="assignment_expression/member_expression">land2ResourceMineState[_landTokenId].lastUpdateSpeedInSeconds</span> = <span class="marker" id="mapping-163"></span><span class="token del" data-title="assignment_expression/call_expression">_getReleaseSpeedInSeconds(<span class="marker" id="mapping-164"></span><span class="token mv" id="move-src-103" data-title="call_expression/call_argument">_landTokenId</span>, <span class="marker" id="mapping-165"></span><span class="token mv" id="move-src-104" data-title="call_expression/call_argument">now</span>)</span></span>;</span>
        land2ResourceMineState[_landTokenId].lastUpdateTime = uint128(now);

    }

    <span class="marker" id="mapping-166"></span><span class="token del" data-title="contract_body/function_definition">function _mineResource(<span class="marker" id="mapping-167"></span><span class="token del" data-title="function_definition/parameter">uint256 _landTokenId</span>, <span class="marker" id="mapping-168"></span><span class="token del" data-title="function_definition/parameter">address _resourceToken</span>) <span class="marker" id="mapping-169"></span><span class="token mv" id="move-src-105" data-title="function_definition/visibility">internal</span> <span class="marker" id="mapping-170"></span><span class="token del" data-title="function_definition/function_body">{
        // the longest seconds to zero speed.
        <span class="marker" id="mapping-171"></span><span class="token del" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-172"></span><span class="token del" data-title="variable_declaration_statement/variable_declaration">uint minedBalance</span> = <span class="marker" id="mapping-173"></span><span class="token del" data-title="variable_declaration_statement/call_expression">_calculateMinedBalance(<span class="marker" id="mapping-174"></span><span class="token mv" id="move-src-106" data-title="call_expression/call_argument">_landTokenId</span>, <span class="marker" id="mapping-175"></span><span class="token del" data-title="call_expression/call_argument">_resourceToken</span>, <span class="marker" id="mapping-176"></span><span class="token mv" id="move-src-107" data-title="call_expression/call_argument">now</span>)</span>;</span>

        <span class="marker" id="mapping-177"></span><span class="token del" data-title="function_body/expression_statement">land2ResourceMineState[_landTokenId].mintedBalance[_resourceToken] += minedBalance;</span>
    }</span></span>

    function _calculateMinedBalance(uint256 _landTokenId, address _resourceToken, uint256 _currentTime) internal returns (uint256) {
        uint256 currentTime = _currentTime;

        uint256 minedBalance;
        uint256 minableBalance;
        if (currentTime &gt; (resourceReleaseStartTime + TOTAL_SECONDS))
        {
            currentTime = (resourceReleaseStartTime + TOTAL_SECONDS);
        }

        uint256 lastUpdateTime = land2ResourceMineState[_landTokenId].lastUpdateTime;
        require(currentTime &gt;= lastUpdateTime);

        if (lastUpdateTime &gt;= (resourceReleaseStartTime + TOTAL_SECONDS)) {
            minedBalance = 0;
            minableBalance = 0;
        } else {
            minedBalance = _getMaxMineBalance(_landTokenId, _resourceToken, currentTime, lastUpdateTime);
            minableBalance = _getMinableBalance(_landTokenId, _resourceToken, currentTime, lastUpdateTime);
        }


        if (minedBalance &gt; minableBalance) {
            minedBalance = minableBalance;
        }

        return minedBalance;
    }

    <span class="marker" id="mapping-178"></span><span class="token mv" id="move-src-108" data-title="contract_body/function_definition">function <span class="marker" id="mapping-179"></span><span class="token upd" id="move-src-109" data-title="function_definition/identifier"><span class="cupd">claim</span>All<span class="cupd">Resource</span></span>(<span class="marker" id="mapping-180"></span><span class="token mv" id="move-src-110" data-title="function_definition/parameter">uint256 _landTokenId</span>) public {
        <span class="marker" id="mapping-181"></span><span class="token del" data-title="function_body/expression_statement">require(msg.sender == ERC721(registry.addressOf(CONTRACT_OBJECT_OWNERSHIP)).ownerOf(_landTokenId), "Must be the owner of the land");</span>

        address gold = registry.addressOf(CONTRACT_GOLD_ERC20_TOKEN);
        address wood = registry.addressOf(CONTRACT_WOOD_ERC20_TOKEN);
        address water = registry.addressOf(CONTRACT_WATER_ERC20_TOKEN);
        address fire = registry.addressOf(CONTRACT_FIRE_ERC20_TOKEN);
        address soil = registry.addressOf(CONTRACT_SOIL_ERC20_TOKEN);

        <span class="marker" id="mapping-182"></span><span class="token mv" id="move-src-111" data-title="function_body/expression_statement">_mineAllResource(<span class="marker" id="mapping-183"></span><span class="token mv" id="move-src-112" data-title="call_expression/call_argument">_landTokenId</span>, gold, wood, water, fire, soil);</span>

        <span class="marker" id="mapping-184"></span><span class="token del" data-title="function_body/variable_declaration_statement">uint goldBalance;</span>
        <span class="marker" id="mapping-185"></span><span class="token del" data-title="function_body/variable_declaration_statement">uint woodBalance;</span>
        <span class="marker" id="mapping-186"></span><span class="token del" data-title="function_body/variable_declaration_statement">uint waterBalance;</span>
        <span class="marker" id="mapping-187"></span><span class="token del" data-title="function_body/variable_declaration_statement">uint fireBalance;</span>
        <span class="marker" id="mapping-188"></span><span class="token del" data-title="function_body/variable_declaration_statement">uint soilBalance;</span>

        <span class="marker" id="mapping-189"></span><span class="token mv" id="move-src-113" data-title="function_body/if_statement">if (<span class="marker" id="mapping-190"></span><span class="token del" data-title="binary_expression/array_access">land2ResourceMineState[_landTokenId].mintedBalance[gold]</span> &gt; 0) {
            <span class="marker" id="mapping-191"></span><span class="token del" data-title="block_statement/expression_statement">goldBalance = land2ResourceMineState[_landTokenId].mintedBalance[gold];</span>
            IMintableERC20(<span class="marker" id="mapping-192"></span><span class="token mv" id="move-src-114" data-title="call_expression/call_argument">gold</span>).mint(msg.sender, <span class="marker" id="mapping-193"></span><span class="token mv" id="move-src-115" data-title="call_expression/call_argument">goldBalance</span>);
            <span class="marker" id="mapping-194"></span><span class="token del" data-title="block_statement/expression_statement">land2ResourceMineState[_landTokenId].mintedBalance[gold] = 0;</span>
        }</span>

        <span class="marker" id="mapping-195"></span><span class="token mv" id="move-src-116" data-title="function_body/if_statement">if (<span class="marker" id="mapping-196"></span><span class="token del" data-title="binary_expression/array_access">land2ResourceMineState[_landTokenId].mintedBalance[wood]</span> &gt; 0) {
            <span class="marker" id="mapping-197"></span><span class="token del" data-title="block_statement/expression_statement">woodBalance = land2ResourceMineState[_landTokenId].mintedBalance[wood];</span>
            IMintableERC20(<span class="marker" id="mapping-198"></span><span class="token mv" id="move-src-117" data-title="call_expression/call_argument">wood</span>).mint(msg.sender, <span class="marker" id="mapping-199"></span><span class="token mv" id="move-src-118" data-title="call_expression/call_argument">woodBalance</span>);
            land2ResourceMineState[<span class="marker" id="mapping-200"></span><span class="token upd" id="move-src-119" data-title="array_access/identifier"><span class="cupd">_land</span>Token<span class="cupd">Id</span></span>].mintedBalance[<span class="marker" id="mapping-201"></span><span class="token upd" id="move-src-120" data-title="array_access/identifier">wood</span>] = 0;
        }</span>

        <span class="marker" id="mapping-202"></span><span class="token del" data-title="function_body/if_statement">if (<span class="marker" id="mapping-203"></span><span class="token del" data-title="if_statement/binary_expression">land2ResourceMineState[_landTokenId].mintedBalance[water] &gt; 0</span>) <span class="marker" id="mapping-204"></span><span class="token del" data-title="if_statement/block_statement">{
            <span class="marker" id="mapping-205"></span><span class="token del" data-title="block_statement/expression_statement">waterBalance = land2ResourceMineState[_landTokenId].mintedBalance[water];</span>
            <span class="marker" id="mapping-206"></span><span class="token del" data-title="block_statement/expression_statement"><span class="marker" id="mapping-207"></span><span class="token del" data-title="expression_statement/call_expression"><span class="marker" id="mapping-208"></span><span class="token del" data-title="call_expression/member_expression"><span class="marker" id="mapping-209"></span><span class="token del" data-title="member_expression/call_expression">IMintableERC20(<span class="marker" id="mapping-210"></span><span class="token mv" id="move-src-121" data-title="call_expression/call_argument">water</span>)</span>.mint</span>(<span class="marker" id="mapping-211"></span><span class="token mv" id="move-src-122" data-title="call_expression/call_argument">msg.sender</span>, <span class="marker" id="mapping-212"></span><span class="token mv" id="move-src-123" data-title="call_expression/call_argument">waterBalance</span>)</span>;</span>
            <span class="marker" id="mapping-213"></span><span class="token del" data-title="block_statement/expression_statement">land2ResourceMineState[_landTokenId].mintedBalance[water] = 0;</span>
        }</span></span>

        <span class="marker" id="mapping-214"></span><span class="token del" data-title="function_body/if_statement">if (<span class="marker" id="mapping-215"></span><span class="token del" data-title="if_statement/binary_expression">land2ResourceMineState[_landTokenId].mintedBalance[fire] &gt; 0</span>) <span class="marker" id="mapping-216"></span><span class="token del" data-title="if_statement/block_statement">{
            <span class="marker" id="mapping-217"></span><span class="token del" data-title="block_statement/expression_statement">fireBalance = land2ResourceMineState[_landTokenId].mintedBalance[fire];</span>
            <span class="marker" id="mapping-218"></span><span class="token del" data-title="block_statement/expression_statement"><span class="marker" id="mapping-219"></span><span class="token del" data-title="expression_statement/call_expression"><span class="marker" id="mapping-220"></span><span class="token del" data-title="call_expression/member_expression"><span class="marker" id="mapping-221"></span><span class="token del" data-title="member_expression/call_expression">IMintableERC20(<span class="marker" id="mapping-222"></span><span class="token mv" id="move-src-124" data-title="call_expression/call_argument">fire</span>)</span>.mint</span>(<span class="marker" id="mapping-223"></span><span class="token del" data-title="call_expression/call_argument">msg.sender</span>, <span class="marker" id="mapping-224"></span><span class="token mv" id="move-src-125" data-title="call_expression/call_argument">fireBalance</span>)</span>;</span>
            <span class="marker" id="mapping-225"></span><span class="token del" data-title="block_statement/expression_statement">land2ResourceMineState[_landTokenId].mintedBalance[fire] = 0;</span>
        }</span></span>

        <span class="marker" id="mapping-226"></span><span class="token del" data-title="function_body/if_statement">if (<span class="marker" id="mapping-227"></span><span class="token del" data-title="if_statement/binary_expression">land2ResourceMineState[_landTokenId].mintedBalance[soil] &gt; 0</span>) <span class="marker" id="mapping-228"></span><span class="token del" data-title="if_statement/block_statement">{
            <span class="marker" id="mapping-229"></span><span class="token del" data-title="block_statement/expression_statement">soilBalance = land2ResourceMineState[_landTokenId].mintedBalance[soil];</span>
            <span class="marker" id="mapping-230"></span><span class="token del" data-title="block_statement/expression_statement"><span class="marker" id="mapping-231"></span><span class="token del" data-title="expression_statement/call_expression"><span class="marker" id="mapping-232"></span><span class="token del" data-title="call_expression/member_expression"><span class="marker" id="mapping-233"></span><span class="token del" data-title="member_expression/call_expression">IMintableERC20(<span class="marker" id="mapping-234"></span><span class="token mv" id="move-src-126" data-title="call_expression/call_argument">soil</span>)</span>.mint</span>(<span class="marker" id="mapping-235"></span><span class="token mv" id="move-src-127" data-title="call_expression/call_argument">msg.sender</span>, <span class="marker" id="mapping-236"></span><span class="token mv" id="move-src-128" data-title="call_expression/call_argument">soilBalance</span>)</span>;</span>
            <span class="marker" id="mapping-237"></span><span class="token del" data-title="block_statement/expression_statement">land2ResourceMineState[_landTokenId].mintedBalance[soil] = 0;</span>
        }</span></span>

        emit <span class="marker" id="mapping-238"></span><span class="token upd" id="move-src-129" data-title="emit_statement/identifier"><span class="cupd">ResourceClaimed</span></span>(msg.sender, <span class="marker" id="mapping-239"></span><span class="token upd" id="move-src-130" data-title="call_argument/identifier"><span class="cupd">_</span>land<span class="cupd">Token</span>Id</span>, <span class="marker" id="mapping-240"></span><span class="token mv" id="move-src-131" data-title="emit_statement/call_argument">goldBalance</span>, <span class="marker" id="mapping-241"></span><span class="token mv" id="move-src-132" data-title="emit_statement/call_argument">woodBalance</span>, <span class="marker" id="mapping-242"></span><span class="token mv" id="move-src-133" data-title="emit_statement/call_argument">waterBalance</span>, <span class="marker" id="mapping-243"></span><span class="token mv" id="move-src-134" data-title="emit_statement/call_argument">fireBalance</span>, soilBalance);
    }</span>

    // both for own _tokenId or hired one
    function startMining(uint256 _tokenId, uint256 _landTokenId, address _resource) public {
        <span class="marker" id="mapping-244"></span><span class="token del" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-245"></span><span class="token del" data-title="variable_declaration_statement/variable_declaration">ITokenUse tokenUse</span> = <span class="marker" id="mapping-246"></span><span class="token mv" id="move-src-135" data-title="variable_declaration_statement/call_expression">ITokenUse(registry.addressOf(CONTRACT_TOKEN_USE))</span>;</span>

        <span class="marker" id="mapping-247"></span><span class="token del" data-title="member_expression/identifier">tokenUse</span>.addActivity(_tokenId, msg.sender, 0);

        // require the permission from land owner;
        require(msg.sender == ERC721(registry.addressOf(CONTRACT_OBJECT_OWNERSHIP)).ownerOf(_landTokenId), "Must be the owner of the land");

        // make sure that _tokenId won't be used repeatedly
        require(miner2Index[_tokenId].landTokenId == 0);

        // update status!
        mine(_landTokenId);

        uint256 _index = land2ResourceMineState[_landTokenId].miners[_resource].length;

        land2ResourceMineState[_landTokenId].totalMiners += 1;

        <span class="marker" id="mapping-248"></span><span class="token del" data-title="function_body/if_statement">if (land2ResourceMineState[_landTokenId].maxMiners == 0) {
            land2ResourceMineState[_landTokenId].maxMiners = 5;
        }</span>

        require(<span class="marker" id="mapping-249"></span><span class="token del" data-title="call_argument/member_expression"><span class="marker" id="mapping-250"></span><span class="token del" data-title="member_expression/array_access"><span class="marker" id="mapping-251"></span><span class="token mv" id="move-src-136" data-title="array_access/binary_expression">land2ResourceMineState[_landTokenId].totalMiners &lt;= <span class="marker" id="mapping-252"></span><span class="token upd" id="move-src-137" data-title="binary_expression/identifier">l<span class="cupd">a</span>nd2Resource<span class="cupd">Mine</span>State</span></span>[_landTokenId]</span>.maxMiners</span>);

        address miner = IInterstellarEncoder(registry.addressOf(CONTRACT_INTERSTELLAR_ENCODER)).getObjectAddress(_tokenId);
        uint256 strength = IMinerObject(miner).strengthOf(_tokenId, _resource, _landTokenId);

        land2ResourceMineState[_landTokenId].miners[_resource].push(_tokenId);
        land2ResourceMineState[_landTokenId].totalMinerStrength[_resource] += strength;

        miner2Index[_tokenId] = MinerStatus({
            landTokenId : _landTokenId,
            resource : _resource,
            indexInResource : uint64(_index)
            });

        emit StartMining(_tokenId, _landTokenId, _resource, strength);

    }

    function batchStartMining(uint256[] _tokenIds, uint256[] _landTokenIds, address[] _resources) public {
        require(_tokenIds.length == _landTokenIds.length &amp;&amp; _landTokenIds.length == _resources.length, "input error");
        <span class="marker" id="mapping-253"></span><span class="token del" data-title="primitive_type/uint">uint</span> length = _tokenIds.length;

        for (<span class="marker" id="mapping-254"></span><span class="token del" data-title="primitive_type/uint">uint</span> i = 0; i &lt; length; i++) {
            startMining(_tokenIds[i], _landTokenIds[i], _resources[i]);
        }

    }

    function <span class="marker" id="mapping-255"></span><span class="token upd" id="move-src-138" data-title="function_definition/identifier"><span class="cupd">batchClaim</span>All<span class="cupd">Resource</span></span>(uint256[] _landTokenIds) public {
        <span class="marker" id="mapping-256"></span><span class="token del" data-title="primitive_type/uint">uint</span> length = _landTokenIds.length;

        for (<span class="marker" id="mapping-257"></span><span class="token del" data-title="primitive_type/uint">uint</span> i = 0; i &lt; length; i++) {
            <span class="marker" id="mapping-258"></span><span class="token upd" id="move-src-139" data-title="call_expression/identifier"><span class="cupd">claim</span>All<span class="cupd">Resource</span></span>(_landTokenIds[i]);
        }
    }

    // Only trigger from Token Activity.
    function activityStopped(uint256 _tokenId) public auth {

        _stopMining(_tokenId);
    }

    function stopMining(uint256 _tokenId) public {
        ITokenUse(registry.addressOf(CONTRACT_TOKEN_USE)).removeActivity(_tokenId, msg.sender);
    }

    function _stopMining(uint256 _tokenId) internal {
        // remove the miner from land2ResourceMineState;
        uint64 minerIndex = miner2Index[_tokenId].indexInResource;
        address resource = miner2Index[_tokenId].resource;
        uint256 landTokenId = miner2Index[_tokenId].landTokenId;

        // update status!
        mine(landTokenId);

        uint64 lastMinerIndex = uint64(land2ResourceMineState[landTokenId].miners[resource].length.sub(1));
        uint256 lastMiner = land2ResourceMineState[landTokenId].miners[resource][lastMinerIndex];

        land2ResourceMineState[landTokenId].miners[resource][minerIndex] = lastMiner;
        land2ResourceMineState[landTokenId].miners[resource][lastMinerIndex] = 0;

        land2ResourceMineState[landTokenId].miners[resource].length -= 1;
        miner2Index[lastMiner].indexInResource = minerIndex;

        land2ResourceMineState[landTokenId].totalMiners -= 1;

        address miner = IInterstellarEncoder(registry.addressOf(CONTRACT_INTERSTELLAR_ENCODER)).getObjectAddress(_tokenId);
        uint256 strength = IMinerObject(miner).strengthOf(_tokenId, resource, landTokenId);

        // for backward compatibility
        // if strength can fluctuate some time in the future
        if (land2ResourceMineState[landTokenId].totalMinerStrength[resource] != 0) {
            if (land2ResourceMineState[landTokenId].totalMinerStrength[resource] &gt; strength) {
                land2ResourceMineState[landTokenId].totalMinerStrength[resource] = land2ResourceMineState[landTokenId].totalMinerStrength[resource].sub(strength);
            } else {
                land2ResourceMineState[landTokenId].totalMinerStrength[resource] = 0;
            }
        }

        if (land2ResourceMineState[landTokenId].totalMiners == 0) {
            land2ResourceMineState[landTokenId].totalMinerStrength[resource] = 0;
        }

        delete miner2Index[_tokenId];

        emit StopMining(_tokenId, landTokenId, resource, strength);
    }

    <span class="marker" id="mapping-259"></span><span class="token mv" id="move-src-140" data-title="contract_body/function_definition">function <span class="marker" id="mapping-260"></span><span class="token upd" id="move-src-141" data-title="function_definition/identifier">g<span class="cupd">e</span><span class="cupd">t</span>Min<span class="cupd">e</span><span class="cupd">r</span>OnLand</span>(<span class="marker" id="mapping-261"></span><span class="token del" data-title="function_definition/parameter">uint _landTokenId</span><span class="marker" id="mapping-262"></span><span class="token del" data-title="function_definition/,">,</span> address _resourceToken<span class="marker" id="mapping-263"></span><span class="token del" data-title="function_definition/,">,</span> <span class="marker" id="mapping-264"></span><span class="token del" data-title="function_definition/parameter">uint _index</span>) <span class="marker" id="mapping-265"></span><span class="token mv" id="move-src-142" data-title="function_definition/visibility">public</span> view returns (uint256) <span class="marker" id="mapping-266"></span><span class="token del" data-title="function_definition/function_body">{
        return land2ResourceMineState[_landTokenId].miners[_resourceToken][_index];
    }</span></span>

    <span class="marker" id="mapping-267"></span><span class="token mv" id="move-src-143" data-title="contract_body/function_definition">function <span class="marker" id="mapping-268"></span><span class="token upd" id="move-src-144" data-title="function_definition/identifier"><span class="cupd">get</span>Tot<span class="cupd">a</span>l<span class="cupd">Min</span>i<span class="cupd">n</span>gStrength</span>(<span class="marker" id="mapping-269"></span><span class="token del" data-title="primitive_type/uint">uint</span> <span class="marker" id="mapping-270"></span><span class="token upd" id="move-src-145" data-title="parameter/identifier"><span class="cupd">_land</span>Token<span class="cupd">Id</span></span>, address <span class="marker" id="mapping-271"></span><span class="token upd" id="move-src-146" data-title="parameter/identifier"><span class="cupd">_resource</span>Token</span>) public view returns (uint256) {
        return land2ResourceMineState[<span class="marker" id="mapping-272"></span><span class="token upd" id="move-src-147" data-title="array_access/identifier"><span class="cupd">_land</span>Token<span class="cupd">Id</span></span>].<span class="marker" id="mapping-273"></span><span class="token upd" id="move-src-148" data-title="member_expression/identifier"><span class="cupd">t</span>ot<span class="cupd">al</span>Mi<span class="cupd">n</span>erStrength</span>[<span class="marker" id="mapping-274"></span><span class="token upd" id="move-src-149" data-title="array_access/identifier"><span class="cupd">_resource</span>Token</span>];
    }</span>

    <span class="marker" id="mapping-275"></span><span class="token del" data-title="contract_body/function_definition">function availableResources(<span class="marker" id="mapping-276"></span><span class="token mv" id="move-src-150" data-title="function_definition/parameter">uint256 _landTokenId</span>, <span class="marker" id="mapping-277"></span><span class="token mv" id="move-src-151" data-title="function_definition/parameter">address[<span class="marker" id="mapping-278"></span><span class="token del" data-title="type_name/number_literal">5</span>] <span class="marker" id="mapping-279"></span><span class="token upd" id="move-src-152" data-title="parameter/identifier"><span class="cupd">_resource</span>Tokens</span></span>) <span class="marker" id="mapping-280"></span><span class="token mv" id="move-src-153" data-title="function_definition/visibility">public</span> <span class="marker" id="mapping-281"></span><span class="token mv" id="move-src-154" data-title="function_definition/state_mutability">view</span> <span class="marker" id="mapping-282"></span><span class="token mv" id="move-src-155" data-title="function_definition/return_type_definition">returns (uint256, uint256<span class="marker" id="mapping-283"></span><span class="token del" data-title="return_type_definition/,">,</span> <span class="marker" id="mapping-284"></span><span class="token mv" id="move-src-156" data-title="return_type_definition/parameter">uint256</span><span class="marker" id="mapping-285"></span><span class="token del" data-title="return_type_definition/,">,</span> <span class="marker" id="mapping-286"></span><span class="token mv" id="move-src-157" data-title="return_type_definition/parameter">uint256</span><span class="marker" id="mapping-287"></span><span class="token del" data-title="return_type_definition/,">,</span> <span class="marker" id="mapping-288"></span><span class="token del" data-title="return_type_definition/parameter">uint256</span>)</span> <span class="marker" id="mapping-289"></span><span class="token del" data-title="function_definition/function_body">{

        <span class="marker" id="mapping-290"></span><span class="token del" data-title="function_body/variable_declaration_statement">uint availableGold = _calculateMinedBalance(_landTokenId, _resourceTokens[0], now) + land2ResourceMineState[_landTokenId].mintedBalance[_resourceTokens[0]];</span>
        <span class="marker" id="mapping-291"></span><span class="token del" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-292"></span><span class="token del" data-title="variable_declaration_statement/variable_declaration">uint availableWood</span> = <span class="marker" id="mapping-293"></span><span class="token del" data-title="variable_declaration_statement/array_access"><span class="marker" id="mapping-294"></span><span class="token del" data-title="array_access/member_expression"><span class="marker" id="mapping-295"></span><span class="token del" data-title="member_expression/array_access"><span class="marker" id="mapping-296"></span><span class="token del" data-title="array_access/binary_expression"><span class="marker" id="mapping-297"></span><span class="token del" data-title="binary_expression/call_expression">_calculateMinedBalance(<span class="marker" id="mapping-298"></span><span class="token del" data-title="call_expression/call_argument">_landTokenId</span>, <span class="marker" id="mapping-299"></span><span class="token del" data-title="call_expression/call_argument">_resourceTokens[1]</span>, <span class="marker" id="mapping-300"></span><span class="token mv" id="move-src-158" data-title="call_expression/call_argument">now</span>)</span> + land2ResourceMineState</span>[_landTokenId]</span>.mintedBalance</span>[<span class="marker" id="mapping-301"></span><span class="token del" data-title="array_access/array_access">_resourceTokens[1]</span>]</span>;</span>
        <span class="marker" id="mapping-302"></span><span class="token del" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-303"></span><span class="token del" data-title="variable_declaration_statement/variable_declaration">uint availableWater</span> = <span class="marker" id="mapping-304"></span><span class="token del" data-title="variable_declaration_statement/array_access"><span class="marker" id="mapping-305"></span><span class="token del" data-title="array_access/member_expression"><span class="marker" id="mapping-306"></span><span class="token del" data-title="member_expression/array_access"><span class="marker" id="mapping-307"></span><span class="token del" data-title="array_access/binary_expression"><span class="marker" id="mapping-308"></span><span class="token del" data-title="binary_expression/call_expression">_calculateMinedBalance(<span class="marker" id="mapping-309"></span><span class="token del" data-title="call_expression/call_argument">_landTokenId</span>, <span class="marker" id="mapping-310"></span><span class="token del" data-title="call_expression/call_argument">_resourceTokens[2]</span>, <span class="marker" id="mapping-311"></span><span class="token mv" id="move-src-159" data-title="call_expression/call_argument">now</span>)</span> + land2ResourceMineState</span>[_landTokenId]</span>.mintedBalance</span>[<span class="marker" id="mapping-312"></span><span class="token del" data-title="array_access/array_access">_resourceTokens[2]</span>]</span>;</span>
        <span class="marker" id="mapping-313"></span><span class="token del" data-title="function_body/variable_declaration_statement">uint availableFire = _calculateMinedBalance(_landTokenId, _resourceTokens[3], now) + land2ResourceMineState[_landTokenId].mintedBalance[_resourceTokens[3]];</span>
        <span class="marker" id="mapping-314"></span><span class="token del" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-315"></span><span class="token del" data-title="variable_declaration_statement/variable_declaration">uint availableSoil</span> = <span class="marker" id="mapping-316"></span><span class="token del" data-title="variable_declaration_statement/array_access"><span class="marker" id="mapping-317"></span><span class="token del" data-title="array_access/member_expression"><span class="marker" id="mapping-318"></span><span class="token del" data-title="member_expression/array_access"><span class="marker" id="mapping-319"></span><span class="token del" data-title="array_access/binary_expression"><span class="marker" id="mapping-320"></span><span class="token del" data-title="binary_expression/call_expression">_calculateMinedBalance(<span class="marker" id="mapping-321"></span><span class="token mv" id="move-src-160" data-title="call_expression/call_argument">_landTokenId</span>, <span class="marker" id="mapping-322"></span><span class="token del" data-title="call_expression/call_argument">_resourceTokens[4]</span>, <span class="marker" id="mapping-323"></span><span class="token del" data-title="call_expression/call_argument">now</span>)</span> + land2ResourceMineState</span>[_landTokenId]</span>.mintedBalance</span>[<span class="marker" id="mapping-324"></span><span class="token del" data-title="array_access/array_access">_resourceTokens[4]</span>]</span>;</span>

        <span class="marker" id="mapping-325"></span><span class="token del" data-title="function_body/return_statement">return (availableGold, availableWood, availableWater, availableFire, availableSoil);</span>
    }</span></span>

    <span class="marker" id="mapping-326"></span><span class="token del" data-title="contract_body/function_definition">function mintedBalanceOnLand(<span class="marker" id="mapping-327"></span><span class="token mv" id="move-src-161" data-title="function_definition/parameter">uint256 _landTokenId</span>, <span class="marker" id="mapping-328"></span><span class="token del" data-title="function_definition/parameter">address _resourceToken</span>) <span class="marker" id="mapping-329"></span><span class="token mv" id="move-src-162" data-title="function_definition/visibility">public</span> <span class="marker" id="mapping-330"></span><span class="token mv" id="move-src-163" data-title="function_definition/state_mutability">view</span> <span class="marker" id="mapping-331"></span><span class="token mv" id="move-src-164" data-title="function_definition/return_type_definition">returns (uint256)</span> <span class="marker" id="mapping-332"></span><span class="token del" data-title="function_definition/function_body">{
        return land2ResourceMineState[_landTokenId].mintedBalance[_resourceToken];
    }</span></span>

    <span class="marker" id="mapping-333"></span><span class="token mv" id="move-src-165" data-title="contract_body/function_definition">function landWorkingOn(uint256 _apostleTokenId) public view <span class="marker" id="mapping-334"></span><span class="token mv" id="move-src-166" data-title="function_definition/return_type_definition">returns (uint256 <span class="marker" id="mapping-335"></span><span class="token upd" id="move-src-167" data-title="parameter/identifier">l<span class="cupd">a</span>ndTokenId</span>)</span> {
        <span class="marker" id="mapping-336"></span><span class="token upd" id="move-src-168" data-title="assignment_expression/identifier"><span class="cupd">land</span>Token<span class="cupd">Id</span></span> = miner2Index[_apostleTokenId].landTokenId;
    }</span>




    function _updateMinerStrength(uint256 _apostleTokenId, bool _isStop) internal returns (uint256, uint256){
        // require that this apostle
        uint256 landTokenId = landWorkingOn(_apostleTokenId);
        require(landTokenId != 0, "this apostle is not mining.");

        address resource = miner2Index[_apostleTokenId].resource;

        address miner = IInterstellarEncoder(registry.addressOf(CONTRACT_INTERSTELLAR_ENCODER)).getObjectAddress(_apostleTokenId);
        uint256 strength = IMinerObject(miner).strengthOf(_apostleTokenId, resource, landTokenId);

        mine(landTokenId);

        if (_isStop) {
            land2ResourceMineState[landTokenId].totalMinerStrength[resource] = land2ResourceMineState[landTokenId].totalMinerStrength[resource].sub(strength);
        } else {
            land2ResourceMineState[landTokenId].totalMinerStrength[resource] += strength;
        }

        return (landTokenId, strength);
    }

    // when a mirrorToken or a pet has tied to apostle
    // we need to update status and remove this apostle from mining list first
    // open authority to PetBase
    // can only be called by PetBase
    function updateMinerStrengthWhenStop(uint256 _apostleTokenId) public auth {
        uint256 landTokenId;
        uint256 strength;
        (landTokenId, strength) = _updateMinerStrength(_apostleTokenId, true);
        // _isStop == true - minus strength
        // _isStop == false - add strength
        emit UpdateMiningStrengthWhenStop(_apostleTokenId, landTokenId, strength);
    }

    function updateMinerStrengthWhenStart(uint256 _apostleTokenId) public auth {
        uint256 landTokenId;
        uint256 strength;
        (landTokenId, strength) = _updateMinerStrength(_apostleTokenId, false);
        // _isStop == true - minus strength
        // _isStop == false - add strength
        emit UpdateMiningStrengthWhenStart(_apostleTokenId, landTokenId, strength);
    }

}</pre></div><div class="col-6"><h5>0x1e0d6ba9d7ddd3f9bc121c51fa051e7826f12b9f.etherscan.io-LandResourceV5.sol</h5><pre class="pre-scrollable"><span class="marker" id="mapping-337"></span><span class="token upd" id="move-dst-1" data-title="source_file/comment"><span class="cupd">// </span>Dependency f<span class="cupd">ile: openzeppelin-solidity/contracts/math/SafeMath.sol</span></span>

<span class="marker" id="mapping-338"></span><span class="token mv" id="move-dst-3" data-title="source_file/comment"><span class="marker" id="mapping-339"></span><span class="token upd" id="move-dst-3" data-title="source_file/comment"><span class="cupd">// </span>pragma<span class="cupd"> </span><span class="cupd">solidity</span> ^0.4.24;</span></span>


/**
 * @title SafeMath
 * @dev Math operations with safety checks that throw on error
 */
library SafeMath {

  /**
  * @dev Multiplies two numbers, throws on overflow.
  */
  function mul(uint256 _a, uint256 _b) internal pure returns (uint256 c) {
    // Gas optimization: this is cheaper than asserting 'a' not being zero, but the
    // benefit is lost if 'b' is also tested.
    // See: https://github.com/OpenZeppelin/openzeppelin-solidity/pull/522
    if (_a == 0) {
      return 0;
    }

    c = _a * _b;
    assert(c / _a == _b);
    return c;
  }

  /**
  * @dev Integer division of two numbers, truncating the quotient.
  */
  function div(uint256 _a, uint256 _b) internal pure returns (uint256) {
    // assert(_b &gt; 0); // Solidity automatically throws when dividing by 0
    // uint256 c = _a / _b;
    // assert(_a == _b * c + _a % _b); // There is no case in which this doesn't hold
    return _a / _b;
  }

  /**
  * @dev Subtracts two numbers, throws on overflow (i.e. if subtrahend is greater than minuend).
  */
  function sub(uint256 _a, uint256 _b) internal pure returns (uint256) {
    assert(_b &lt;= _a);
    return _a - _b;
  }

  /**
  * @dev Adds two numbers, throws on overflow.
  */
  function add(uint256 _a, uint256 _b) internal pure returns (uint256 c) {
    c = _a + _b;
    assert(c &gt;= _a);
    return c;
  }
}


<span class="marker" id="mapping-340"></span><span class="token mv" id="move-dst-5" data-title="source_file/comment"><span class="marker" id="mapping-341"></span><span class="token upd" id="move-dst-5" data-title="source_file/comment"><span class="cupd">// </span>Dependency f<span class="cupd">ile: openzeppelin-solidity/contracts/</span>in<span class="cupd">t</span>r<span class="cupd">o</span>sp<span class="cupd">e</span>ctio<span class="cupd">n/ERC</span><span class="cupd">1</span>65<span class="cupd">.sol</span></span></span>

<span class="marker" id="mapping-342"></span><span class="token mv" id="move-dst-7" data-title="source_file/comment"><span class="marker" id="mapping-343"></span><span class="token upd" id="move-dst-7" data-title="source_file/comment"><span class="cupd">// </span>pragma<span class="cupd"> </span><span class="cupd">solidity</span> ^0.4.24;</span></span>


/**
 * @title ERC165
 * @dev https://github.com/ethereum/EIPs/blob/master/EIPS/eip-165.md
 */
interface ERC165 {

  /**
   * @notice Query if a contract implements an interface
   * @param _interfaceId The interface identifier, as specified in ERC-165
   * @dev Interface identification is specified in ERC-165. This function
   * uses less than 30,000 gas.
   */
  function supportsInterface(bytes4 _interfaceId)
    external
    view
    returns (bool);
}


<span class="marker" id="mapping-344"></span><span class="token mv" id="move-dst-9" data-title="source_file/comment"><span class="marker" id="mapping-345"></span><span class="token upd" id="move-dst-9" data-title="source_file/comment"><span class="cupd">// </span>Dependency f<span class="cupd">ile: openzeppelin-solidity/contracts/</span><span class="cupd">t</span><span class="cupd">o</span>k<span class="cupd">e</span><span class="cupd">n/</span>ERC721/ERC721Ba<span class="cupd">s</span>i<span class="cupd">c</span><span class="cupd">.sol</span></span></span>

<span class="marker" id="mapping-346"></span><span class="token mv" id="move-dst-11" data-title="source_file/comment"><span class="marker" id="mapping-347"></span><span class="token upd" id="move-dst-11" data-title="source_file/comment"><span class="cupd">// </span>pragma<span class="cupd"> </span>s<span class="cupd">ol</span><span class="cupd">i</span><span class="cupd">d</span><span class="cupd">i</span><span class="cupd">t</span>y ^<span class="cupd">0.</span>4.24;</span></span>

<span class="marker" id="mapping-348"></span><span class="token mv" id="move-dst-13" data-title="source_file/comment"><span class="marker" id="mapping-349"></span><span class="token upd" id="move-dst-13" data-title="source_file/comment"><span class="cupd">// </span><span class="cupd">i</span>mport<span class="cupd"> </span>"op<span class="cupd">e</span>nzeppe<span class="cupd">l</span><span class="cupd">i</span>n-s<span class="cupd">o</span><span class="cupd">l</span>i<span class="cupd">d</span>ity<span class="cupd">/co</span><span class="cupd">n</span><span class="cupd">tracts/int</span><span class="cupd">r</span>o<span class="cupd">s</span>p<span class="cupd">e</span>c<span class="cupd">t</span><span class="cupd">i</span>o<span class="cupd">n</span>/E<span class="cupd">R</span>C165<span class="cupd">.sol</span>";</span></span>


/**
 * @title ERC721 Non-Fungible Token Standard basic interface
 * @dev see https://github.com/ethereum/EIPs/blob/master/EIPS/eip-721.md
 */
contract ERC721Basic is ERC165 {

  bytes4 internal constant InterfaceId_ERC721 = 0x80ac58cd;
  /*
   * 0x80ac58cd ===
   *   bytes4(keccak256('balanceOf(address)')) ^
   *   bytes4(keccak256('ownerOf(uint256)')) ^
   *   bytes4(keccak256('approve(address,uint256)')) ^
   *   bytes4(keccak256('getApproved(uint256)')) ^
   *   bytes4(keccak256('setApprovalForAll(address,bool)')) ^
   *   bytes4(keccak256('isApprovedForAll(address,address)')) ^
   *   bytes4(keccak256('transferFrom(address,address,uint256)')) ^
   *   bytes4(keccak256('safeTransferFrom(address,address,uint256)')) ^
   *   bytes4(keccak256('safeTransferFrom(address,address,uint256,bytes)'))
   */

  bytes4 internal constant InterfaceId_ERC721Exists = 0x4f558e79;
  /*
   * 0x4f558e79 ===
   *   bytes4(keccak256('exists(uint256)'))
   */

  bytes4 internal constant InterfaceId_ERC721Enumerable = 0x780e9d63;
  /**
   * 0x780e9d63 ===
   *   bytes4(keccak256('totalSupply()')) ^
   *   bytes4(keccak256('tokenOfOwnerByIndex(address,uint256)')) ^
   *   bytes4(keccak256('tokenByIndex(uint256)'))
   */

  bytes4 internal constant InterfaceId_ERC721Metadata = 0x5b5e139f;
  /**
   * 0x5b5e139f ===
   *   bytes4(keccak256('name()')) ^
   *   bytes4(keccak256('symbol()')) ^
   *   bytes4(keccak256('tokenURI(uint256)'))
   */

  event Transfer(
    address indexed _from,
    address indexed _to,
    uint256 indexed _tokenId
  );
  event Approval(
    address indexed _owner,
    address indexed _approved,
    uint256 indexed _tokenId
  );
  event ApprovalForAll(
    address indexed _owner,
    address indexed _operator,
    bool _approved
  );

  function balanceOf(address _owner) public view returns (uint256 _balance);
  function ownerOf(uint256 _tokenId) public view returns (address _owner);
  function exists(uint256 _tokenId) public view returns (bool _exists);

  function approve(address _to, uint256 _tokenId) public;
  function getApproved(uint256 _tokenId)
    public view returns (address _operator);

  function setApprovalForAll(address _operator, bool _approved) public;
  function isApprovedForAll(address _owner, address _operator)
    public view returns (bool);

  function transferFrom(address _from, address _to, uint256 _tokenId) public;
  function safeTransferFrom(address _from, address _to, uint256 _tokenId)
    public;

  function safeTransferFrom(
    address _from,
    address _to,
    uint256 _tokenId,
    bytes _data
  )
    public;
}


<span class="marker" id="mapping-350"></span><span class="token mv" id="move-dst-15" data-title="source_file/comment"><span class="marker" id="mapping-351"></span><span class="token upd" id="move-dst-15" data-title="source_file/comment"><span class="cupd">// </span>Dependency f<span class="cupd">ile: </span>op<span class="cupd">e</span>nzeppe<span class="cupd">l</span><span class="cupd">i</span>n-s<span class="cupd">o</span><span class="cupd">l</span>i<span class="cupd">d</span>ity<span class="cupd">/co</span><span class="cupd">n</span><span class="cupd">tracts/</span><span class="cupd">t</span>ok<span class="cupd">e</span>n<span class="cupd">/</span>ERC721/ERC721<span class="cupd">.sol</span></span></span>

<span class="marker" id="mapping-352"></span><span class="token mv" id="move-dst-17" data-title="source_file/comment"><span class="marker" id="mapping-353"></span><span class="token upd" id="move-dst-17" data-title="source_file/comment"><span class="cupd">// </span>pragma<span class="cupd"> </span>s<span class="cupd">ol</span><span class="cupd">i</span><span class="cupd">d</span>i<span class="cupd">t</span>y ^0.4.24;</span></span>

<span class="marker" id="mapping-354"></span><span class="token mv" id="move-dst-19" data-title="source_file/comment"><span class="marker" id="mapping-355"></span><span class="token upd" id="move-dst-19" data-title="source_file/comment"><span class="cupd">// </span><span class="cupd">i</span>mport<span class="cupd"> </span>"op<span class="cupd">e</span>nzeppe<span class="cupd">l</span><span class="cupd">i</span>n-s<span class="cupd">o</span><span class="cupd">l</span>i<span class="cupd">d</span>ity<span class="cupd">/co</span><span class="cupd">n</span><span class="cupd">tracts/</span>tok<span class="cupd">e</span><span class="cupd">n</span>/ERC721/ERC721Ba<span class="cupd">s</span>ic<span class="cupd">.sol</span>";</span></span>


/**
 * @title ERC-721 Non-Fungible Token Standard, optional enumeration extension
 * @dev See https://github.com/ethereum/EIPs/blob/master/EIPS/eip-721.md
 */
contract ERC721Enumerable is ERC721Basic {
  function totalSupply() public view returns (uint256);
  function tokenOfOwnerByIndex(
    address _owner,
    uint256 _index
  )
    public
    view
    returns (uint256 _tokenId);

  function tokenByIndex(uint256 _index) public view returns (uint256);
}


/**
 * @title ERC-721 Non-Fungible Token Standard, optional metadata extension
 * @dev See https://github.com/ethereum/EIPs/blob/master/EIPS/eip-721.md
 */
contract ERC721Metadata is ERC721Basic {
  function name() external view returns (string _name);
  function symbol() external view returns (string _symbol);
  function tokenURI(uint256 _tokenId) public view returns (string);
}


/**
 * @title ERC-721 Non-Fungible Token Standard, full implementation interface
 * @dev See https://github.com/ethereum/EIPs/blob/master/EIPS/eip-721.md
 */
contract ERC721 is ERC721Basic, ERC721Enumerable, ERC721Metadata {
}


<span class="marker" id="mapping-356"></span><span class="token mv" id="move-dst-21" data-title="source_file/comment"><span class="marker" id="mapping-357"></span><span class="token upd" id="move-dst-21" data-title="source_file/comment"><span class="cupd">/</span>/<span class="cupd"> </span>Depen<span class="cupd">d</span>ency<span class="cupd"> </span><span class="cupd">fi</span>le:<span class="cupd"> </span><span class="cupd">o</span>p<span class="cupd">e</span><span class="cupd">n</span>z<span class="cupd">e</span>ppel<span class="cupd">i</span>n-<span class="cupd">s</span><span class="cupd">ol</span>i<span class="cupd">d</span><span class="cupd">i</span>ty/<span class="cupd">con</span>tra<span class="cupd">ct</span>s/<span class="cupd">i</span><span class="cupd">n</span><span class="cupd">t</span>ro<span class="cupd">s</span>p<span class="cupd">e</span>c<span class="cupd">t</span><span class="cupd">i</span>o<span class="cupd">n</span>/Suppo<span class="cupd">r</span>t<span class="cupd">s</span>In<span class="cupd">t</span>e<span class="cupd">r</span>fac<span class="cupd">e</span>Wi<span class="cupd">t</span>hL<span class="cupd">o</span>oku<span class="cupd">p</span>.sol</span></span>

<span class="marker" id="mapping-358"></span><span class="token mv" id="move-dst-56" data-title="source_file/comment"><span class="marker" id="mapping-359"></span><span class="token upd" id="move-dst-56" data-title="source_file/comment"><span class="cupd">// </span>pragma<span class="cupd"> </span>s<span class="cupd">ol</span><span class="cupd">i</span><span class="cupd">d</span><span class="cupd">i</span><span class="cupd">t</span>y ^0.4.24;</span></span>

<span class="marker" id="mapping-360"></span><span class="token mv" id="move-dst-58" data-title="source_file/comment"><span class="marker" id="mapping-361"></span><span class="token upd" id="move-dst-58" data-title="source_file/comment"><span class="cupd">// </span><span class="cupd">i</span>mport<span class="cupd"> </span>"op<span class="cupd">e</span>nzeppe<span class="cupd">l</span><span class="cupd">i</span>n-s<span class="cupd">o</span><span class="cupd">l</span>i<span class="cupd">d</span>ity<span class="cupd">/co</span><span class="cupd">n</span><span class="cupd">tracts/int</span>rosp<span class="cupd">e</span><span class="cupd">c</span>ti<span class="cupd">o</span><span class="cupd">n</span>/ERC165<span class="cupd">.sol</span>";</span></span>


/**
 * @title SupportsInterfaceWithLookup
 * @author Matt Condon (@shrugs)
 * @dev Implements ERC165 using a lookup table.
 */
contract SupportsInterfaceWithLookup is ERC165 {

  bytes4 public constant InterfaceId_ERC165 = 0x01ffc9a7;
  /**
   * 0x01ffc9a7 ===
   *   bytes4(keccak256('supportsInterface(bytes4)'))
   */

  /**
   * @dev a mapping of interface id to whether or not it's supported
   */
  mapping(bytes4 =&gt; bool) internal supportedInterfaces;

  /**
   * @dev A contract implementing SupportsInterfaceWithLookup
   * implement ERC165 itself
   */
  constructor()
    public
  {
    _registerInterface(InterfaceId_ERC165);
  }

  /**
   * @dev implement supportsInterface(bytes4) using a lookup table
   */
  function supportsInterface(bytes4 _interfaceId)
    external
    view
    returns (bool)
  {
    return supportedInterfaces[_interfaceId];
  }

  /**
   * @dev private method for registering an interface
   */
  function _registerInterface(bytes4 _interfaceId)
    internal
  {
    require(_interfaceId != 0xffffffff);
    supportedInterfaces[_interfaceId] = true;
  }
}


<span class="marker" id="mapping-362"></span><span class="token mv" id="move-dst-60" data-title="source_file/comment"><span class="marker" id="mapping-363"></span><span class="token upd" id="move-dst-60" data-title="source_file/comment"><span class="cupd">// </span>Dependency f<span class="cupd">ile: @evolutionland/common/contracts/interfaces/I</span>M<span class="cupd">i</span>n<span class="cupd">t</span>ableERC20<span class="cupd">.sol</span></span></span>

<span class="marker" id="mapping-364"></span><span class="token mv" id="move-dst-62" data-title="source_file/comment"><span class="marker" id="mapping-365"></span><span class="token upd" id="move-dst-62" data-title="source_file/comment"><span class="cupd">// </span>pragma<span class="cupd"> </span>s<span class="cupd">ol</span><span class="cupd">i</span><span class="cupd">d</span><span class="cupd">i</span><span class="cupd">t</span>y ^0.4.23;</span></span>

contract IMintableERC20 {

    function mint(address _to, uint256 _value) public;
}

<span class="marker" id="mapping-366"></span><span class="token mv" id="move-dst-64" data-title="source_file/comment"><span class="marker" id="mapping-367"></span><span class="token upd" id="move-dst-64" data-title="source_file/comment"><span class="cupd">// </span>Dependency f<span class="cupd">ile: </span>@evolutionland/<span class="cupd">co</span>mmo<span class="cupd">n</span>/con<span class="cupd">tracts/interfaces/I</span>Setti<span class="cupd">n</span>g<span class="cupd">s</span>R<span class="cupd">e</span>gistry<span class="cupd">.sol</span></span></span>

<span class="marker" id="mapping-368"></span><span class="token mv" id="move-dst-66" data-title="source_file/comment"><span class="marker" id="mapping-369"></span><span class="token upd" id="move-dst-66" data-title="source_file/comment"><span class="cupd">// </span>p<span class="cupd">ra</span>gma <span class="cupd">s</span>oli<span class="cupd">d</span>i<span class="cupd">t</span>y ^0.4.24;</span></span>

contract ISettingsRegistry {
    enum SettingsValueTypes { NONE, UINT, STRING, ADDRESS, BYTES, BOOL, INT }

    function uintOf(bytes32 _propertyName) public view returns (uint256);

    function stringOf(bytes32 _propertyName) public view returns (string);

    function addressOf(bytes32 _propertyName) public view returns (address);

    function bytesOf(bytes32 _propertyName) public view returns (bytes);

    function boolOf(bytes32 _propertyName) public view returns (bool);

    function intOf(bytes32 _propertyName) public view returns (int);

    function setUintProperty(bytes32 _propertyName, uint _value) public;

    function setStringProperty(bytes32 _propertyName, string _value) public;

    function setAddressProperty(bytes32 _propertyName, address _value) public;

    function setBytesProperty(bytes32 _propertyName, bytes _value) public;

    function setBoolProperty(bytes32 _propertyName, bool _value) public;

    function setIntProperty(bytes32 _propertyName, int _value) public;

    function getValueTypeOf(bytes32 _propertyName) public view returns (uint /* SettingsValueTypes */ );

    event ChangeProperty(bytes32 indexed _propertyName, uint256 _type);
}

<span class="marker" id="mapping-370"></span><span class="token mv" id="move-dst-68" data-title="source_file/comment"><span class="marker" id="mapping-371"></span><span class="token upd" id="move-dst-68" data-title="source_file/comment"><span class="cupd">// </span>Dependency f<span class="cupd">ile: </span>@evolutionland/<span class="cupd">co</span>mmo<span class="cupd">n</span>/con<span class="cupd">tracts/</span>i<span class="cupd">n</span>t<span class="cupd">e</span>rface<span class="cupd">s</span>/IAuth<span class="cupd">o</span><span class="cupd">r</span>ity<span class="cupd">.sol</span></span></span>

<span class="marker" id="mapping-372"></span><span class="token mv" id="move-dst-70" data-title="source_file/comment"><span class="marker" id="mapping-373"></span><span class="token upd" id="move-dst-70" data-title="source_file/comment"><span class="cupd">/</span>/<span class="cupd"> </span>p<span class="cupd">r</span><span class="cupd">a</span><span class="cupd">g</span><span class="cupd">ma</span><span class="cupd"> </span><span class="cupd">so</span><span class="cupd">l</span><span class="cupd">i</span><span class="cupd">d</span><span class="cupd">i</span><span class="cupd">t</span>y<span class="cupd"> </span>^0<span class="cupd">.</span>4.24;</span></span>

contract IAuthority {
    function canCall(
        address src, address dst, bytes4 sig
    ) public view returns (bool);
}

<span class="marker" id="mapping-374"></span><span class="token add" data-title="source_file/comment">// Dependency file: @evolutionland/common/contracts/DSAuth.sol</span>

<span class="marker" id="mapping-375"></span><span class="token add" data-title="source_file/comment">// pragma solidity ^0.4.24;</span>

<span class="marker" id="mapping-376"></span><span class="token add" data-title="source_file/comment">// import '/Users/echo/workspace/contract/evolutionlandorg/land/node_modules/@evolutionland/common/contracts/interfaces/IAuthority.sol';</span>

contract DSAuthEvents {
    event LogSetAuthority (address indexed authority);
    event LogSetOwner     (address indexed owner);
}

/**
 * @title DSAuth
 * @dev The DSAuth contract is reference implement of https://github.com/dapphub/ds-auth
 * But in the isAuthorized method, the src from address(this) is remove for safty concern.
 */
contract DSAuth is DSAuthEvents {
    IAuthority   public  authority;
    address      public  owner;

    constructor() public {
        owner = msg.sender;
        emit LogSetOwner(msg.sender);
    }

    function setOwner(address owner_)
        public
        auth
    {
        owner = owner_;
        emit LogSetOwner(owner);
    }

    function setAuthority(IAuthority authority_)
        public
        auth
    {
        authority = authority_;
        emit LogSetAuthority(authority);
    }

    modifier auth {
        require(isAuthorized(msg.sender, msg.sig));
        _;
    }

    modifier onlyOwner() {
        require(msg.sender == owner);
        _;
    }

    function isAuthorized(address src, bytes4 sig) internal view returns (bool) {
        if (src == owner) {
            return true;
        } else if (authority == IAuthority(0)) {
            return false;
        } else {
            return authority.canCall(src, this, sig);
        }
    }
}


<span class="marker" id="mapping-377"></span><span class="token add" data-title="source_file/comment">// Dependency file: @evolutionland/common/contracts/interfaces/IInterstellarEncoder.sol</span>

<span class="marker" id="mapping-378"></span><span class="token add" data-title="source_file/comment">// pragma solidity ^0.4.24;</span>

contract IInterstellarEncoder {
    uint256 constant CLEAR_HIGH =  0x00000000000000000000000000000000ffffffffffffffffffffffffffffffff;

    uint256 public constant MAGIC_NUMBER = 42;    // Interstellar Encoding Magic Number.
    uint256 public constant CHAIN_ID = 1; // Ethereum mainet.
    uint256 public constant CURRENT_LAND = 1; // 1 is Atlantis, 0 is NaN.

    enum ObjectClass { 
        NaN,
        LAND,
        APOSTLE,
        OBJECT_CLASS_COUNT
    }

    function registerNewObjectClass(address _objectContract, uint8 objectClass) public;

    function registerNewTokenContract(address _tokenAddress) public;

    function encodeTokenId(address _tokenAddress, uint8 _objectClass, uint128 _objectIndex) public view returns (uint256 _tokenId);

    function encodeTokenIdForObjectContract(
        address _tokenAddress, address _objectContract, uint128 _objectId) public view returns (uint256 _tokenId);

    function getContractAddress(uint256 _tokenId) public view returns (address);

    function getObjectId(uint256 _tokenId) public view returns (uint128 _objectId);

    function getObjectClass(uint256 _tokenId) public view returns (uint8);

    function getObjectAddress(uint256 _tokenId) public view returns (address);
}

<span class="marker" id="mapping-379"></span><span class="token add" data-title="source_file/comment">// Dependency file: @evolutionland/common/contracts/interfaces/ITokenUse.sol</span>

<span class="marker" id="mapping-380"></span><span class="token add" data-title="source_file/comment">// pragma solidity ^0.4.24;</span>

contract ITokenUse {
    uint48 public constant MAX_UINT48_TIME = 281474976710655;

    function isObjectInHireStage(uint256 _tokenId) public view returns (bool);

    function isObjectReadyToUse(uint256 _tokenId) public view returns (bool);

    function getTokenUser(uint256 _tokenId) public view returns (address);

    function createTokenUseOffer(uint256 _tokenId, uint256 _duration, uint256 _price, address _acceptedActivity) public;

    function cancelTokenUseOffer(uint256 _tokenId) public;

    function takeTokenUseOffer(uint256 _tokenId) public;

    function addActivity(uint256 _tokenId, address _user, uint256 _endTime) public;

    function removeActivity(uint256 _tokenId, address _user) public;
}

<span class="marker" id="mapping-381"></span><span class="token add" data-title="source_file/comment">// Dependency file: @evolutionland/common/contracts/interfaces/IActivity.sol</span>

<span class="marker" id="mapping-382"></span><span class="token add" data-title="source_file/comment">// pragma solidity ^0.4.24;</span>

<span class="marker" id="mapping-383"></span><span class="token add" data-title="source_file/comment">// import "openzeppelin-solidity/contracts/introspection/ERC165.sol";</span>

contract IActivity is ERC165 {
    bytes4 internal constant InterfaceId_IActivity = 0x6086e7f8; 
    /*
     * 0x6086e7f8 ===
     *   bytes4(keccak256('activityStopped(uint256)'))
     */

    function activityStopped(uint256 _tokenId) public;
}

<span class="marker" id="mapping-384"></span><span class="token add" data-title="source_file/comment">// Dependency file: @evolutionland/common/contracts/interfaces/IMinerObject.sol</span>

<span class="marker" id="mapping-385"></span><span class="token add" data-title="source_file/comment">// pragma solidity ^0.4.24;</span>

<span class="marker" id="mapping-386"></span><span class="token add" data-title="source_file/comment">// import "openzeppelin-solidity/contracts/introspection/ERC165.sol";</span>

contract IMinerObject is ERC165  {
    bytes4 internal constant InterfaceId_IMinerObject = 0x64272b75;
    
    /*
     * 0x64272b752 ===
     *   bytes4(keccak256('strengthOf(uint256,address)'))
     */

    function strengthOf(uint256 _tokenId, address _resourceToken, uint256 _landTokenId) public view returns (uint256);

}

<span class="marker" id="mapping-387"></span><span class="token add" data-title="source_file/comment">// Dependency file: contracts/interfaces/ILandBase.sol</span>

<span class="marker" id="mapping-388"></span><span class="token add" data-title="source_file/comment">// pragma solidity ^0.4.24;</span>

contract ILandBase {

    /*
     *  Event
     */
    event ModifiedResourceRate(uint indexed tokenId, address resourceToken, uint16 newResourceRate);
    event HasboxSetted(uint indexed tokenId, bool hasBox);

    event ChangedReourceRateAttr(uint indexed tokenId, uint256 attr);

    event ChangedFlagMask(uint indexed tokenId, uint256 newFlagMask);

    event CreatedNewLand(uint indexed tokenId, int x, int y, address beneficiary, uint256 resourceRateAttr, uint256 mask);

    function defineResouceTokenRateAttrId(address _resourceToken, uint8 _attrId) public;

    function setHasBox(uint _landTokenID, bool isHasBox) public;
    function isReserved(uint256 _tokenId) public view returns (bool);
    function isSpecial(uint256 _tokenId) public view returns (bool);
    function isHasBox(uint256 _tokenId) public view returns (bool);

    function getResourceRateAttr(uint _landTokenId) public view returns (uint256);
    function setResourceRateAttr(uint _landTokenId, uint256 _newResourceRateAttr) public;

    function getResourceRate(uint _landTokenId, address _resouceToken) public view returns (uint16);
    function setResourceRate(uint _landTokenID, address _resourceToken, uint16 _newResouceRate) public;

    function getFlagMask(uint _landTokenId) public view returns (uint256);

    function setFlagMask(uint _landTokenId, uint256 _newFlagMask) public;

    <span class="marker" id="mapping-389"></span><span class="token mv" id="move-dst-140" data-title="contract_body/function_definition">function <span class="marker" id="mapping-390"></span><span class="token upd" id="move-dst-141" data-title="function_definition/identifier">r<span class="cupd">e</span>sourceToken2Ra<span class="cupd">t</span><span class="cupd">e</span>Att<span class="cupd">r</span>Id</span>(address _resourceToken) <span class="marker" id="mapping-391"></span><span class="token add" data-title="function_definition/visibility">external</span> view returns (uint256);</span>
}


<span class="marker" id="mapping-392"></span><span class="token add" data-title="source_file/comment">// Dependency file: contracts/interfaces/IMetaDataTeller.sol</span>

<span class="marker" id="mapping-393"></span><span class="token add" data-title="source_file/comment">// pragma solidity ^0.4.24;</span>

<span class="marker" id="mapping-394"></span><span class="token add" data-title="source_file/interface_declaration">interface IMetaDataTeller {
	function addTokenMeta(
		address _token,
		uint16 _grade,
		uint112 _strengthRate
	) external;

	//0xf666196d
	function getMetaData(address _token, uint256 _id)
		external
		view
		returns (
			uint16,
			uint16,
			uint16
		);

	//0x7999a5cf
	function getPrefer(address _token) external view returns (uint256);

	//0x33281815
	function getRate(
		address _token,
		uint256 _id,
		uint256 _index
	) external view returns (uint256);
}</span>


<span class="marker" id="mapping-395"></span><span class="token add" data-title="source_file/comment">// Root file: contracts/LandResourceV5.sol</span>

pragma solidity ^0.4.24;

<span class="marker" id="mapping-396"></span><span class="token add" data-title="source_file/comment">// import "openzeppelin-solidity/contracts/math/SafeMath.sol";</span>
<span class="marker" id="mapping-397"></span><span class="token add" data-title="source_file/comment">// import "openzeppelin-solidity/contracts/token/ERC721/ERC721.sol";</span>
<span class="marker" id="mapping-398"></span><span class="token add" data-title="source_file/comment">// import "openzeppelin-solidity/contracts/introspection/SupportsInterfaceWithLookup.sol";</span>
<span class="marker" id="mapping-399"></span><span class="token add" data-title="source_file/comment">// import "@evolutionland/common/contracts/interfaces/IMintableERC20.sol";</span>
<span class="marker" id="mapping-400"></span><span class="token add" data-title="source_file/comment">// import "@evolutionland/common/contracts/interfaces/ISettingsRegistry.sol";</span>
<span class="marker" id="mapping-401"></span><span class="token add" data-title="source_file/comment">// import "@evolutionland/common/contracts/DSAuth.sol";</span>
<span class="marker" id="mapping-402"></span><span class="token add" data-title="source_file/comment">// import "@evolutionland/common/contracts/interfaces/IInterstellarEncoder.sol";</span>
<span class="marker" id="mapping-403"></span><span class="token add" data-title="source_file/comment">// import "@evolutionland/common/contracts/interfaces/ITokenUse.sol";</span>
<span class="marker" id="mapping-404"></span><span class="token add" data-title="source_file/comment">// import "@evolutionland/common/contracts/interfaces/IActivity.sol";</span>
<span class="marker" id="mapping-405"></span><span class="token add" data-title="source_file/comment">// import "@evolutionland/common/contracts/interfaces/IMinerObject.sol";</span>
<span class="marker" id="mapping-406"></span><span class="token add" data-title="source_file/comment">// import "contracts/interfaces/ILandBase.sol";</span>
<span class="marker" id="mapping-407"></span><span class="token add" data-title="source_file/comment">// import "contracts/interfaces/IMetaDataTeller.sol";</span>

contract <span class="marker" id="mapping-408"></span><span class="token upd" id="move-dst-71" data-title="contract_declaration/identifier"><span class="cupd">LandResourceV</span>5</span> is SupportsInterfaceWithLookup, DSAuth, IActivity {
	using SafeMath for *;

	// For every seconds, the speed will decrease by current speed multiplying (DENOMINATOR_in_seconds - seconds) / DENOMINATOR_in_seconds
	// resource will decrease 1/10000 every day.
	uint256 public constant DENOMINATOR = 10000;

	uint256 public constant TOTAL_SECONDS = DENOMINATOR * (1 days);

	bool private singletonLock = false;

	ISettingsRegistry public registry;

	uint256 public resourceReleaseStartTime;

	// TODO: move to global settings contract.
	uint256 public attenPerDay = 1;
	uint256 public recoverAttenPerDay = 20;

	// Struct for recording resouces on land which have already been pinged.
	// 金, Evolution Land Gold
	// 木, Evolution Land Wood
	// 水, Evolution Land Water
	// 火, Evolution Land fire
	// 土, Evolution Land Silicon
	struct ResourceMineState {
		mapping(address =&gt; uint256) mintedBalance;
		mapping(address =&gt; uint256[]) miners;
		mapping(address =&gt; uint256) totalMinerStrength;
		uint256 lastUpdateSpeedInSeconds;
		uint256 lastDestoryAttenInSeconds;
		uint256 industryIndex;
		uint128 lastUpdateTime;
		uint64 totalMiners;
		uint64 maxMiners;
	}

	struct MinerStatus {
		uint256 landTokenId;
		address resource;
		uint64 indexInResource;
	}

	mapping(uint256 =&gt; ResourceMineState) public land2ResourceMineState;
	mapping(uint256 =&gt; MinerStatus) public miner2Index;

	<span class="marker" id="mapping-409"></span><span class="token upd" id="move-dst-72" data-title="contract_body/comment"><span class="cupd">/*
	</span><span class="cupd"> *  Event
</span><span class="cupd">	 </span>*/</span>

	event StartMining(
		uint256 minerTokenId,
		uint256 <span class="marker" id="mapping-410"></span><span class="token upd" id="move-dst-73" data-title="event_paramater/identifier"><span class="cupd">land</span><span class="cupd">Id</span></span>,
		address _resource,
		uint256 strength
	);
	event StopMining(
		uint256 minerTokenId,
		uint256 <span class="marker" id="mapping-411"></span><span class="token upd" id="move-dst-74" data-title="event_paramater/identifier"><span class="cupd">land</span><span class="cupd">Id</span></span>,
		address _resource,
		uint256 strength
	);
	event ResourceClaimed(
		address owner,
		uint256 landTokenId,
		uint256 goldBalance,
		uint256 woodBalance,
		uint256 waterBalance,
		uint256 fireBalance,
		uint256 soilBalance
	);
	event UpdateMiningStrengthWhenStop(
		uint256 apostleTokenId,
		uint256 <span class="marker" id="mapping-412"></span><span class="token upd" id="move-dst-75" data-title="event_paramater/identifier"><span class="cupd">land</span><span class="cupd">Id</span></span>,
		uint256 strength
	);
	event UpdateMiningStrengthWhenStart(
		uint256 apostleTokenId,
		uint256 <span class="marker" id="mapping-413"></span><span class="token upd" id="move-dst-76" data-title="event_paramater/identifier"><span class="cupd">land</span><span class="cupd">Id</span></span>,
		uint256 strength
	);

	<span class="marker" id="mapping-414"></span><span class="token upd" id="move-dst-77" data-title="contract_body/comment"><span class="cupd">/</span>/<span class="cupd"> </span>v5<span class="cupd"> </span>add<span class="cupd"> </span>begin</span>
	<span class="marker" id="mapping-415"></span><span class="token add" data-title="contract_body/event_definition">event StartBarMining(
		uint256 barIndex,
		uint256 landId,
		address resource,
		uint256 rate
	);</span>
	<span class="marker" id="mapping-416"></span><span class="token add" data-title="contract_body/event_definition">event StopBarMining(uint256 barIndex, uint256 landId, address rate);</span>
	<span class="marker" id="mapping-417"></span><span class="token add" data-title="contract_body/event_definition">event LandResourceClaimed(
		address owner,
		uint256 landId,
		uint256 goldBalance,
		uint256 woodBalance,
		uint256 waterBalance,
		uint256 fireBalance,
		uint256 soilBalance
	);</span>
	<span class="marker" id="mapping-418"></span><span class="token add" data-title="contract_body/event_definition">event ItemResourceClaimed(
		address owner,
		address itemToken,
		uint256 itemTokenId,
		uint256 goldBalance,
		uint256 woodBalance,
		uint256 waterBalance,
		uint256 fireBalance,
		uint256 soilBalance
	);</span>

	<span class="marker" id="mapping-419"></span><span class="token mv" id="move-dst-96" data-title="contract_body/comment"><span class="marker" id="mapping-420"></span><span class="token upd" id="move-dst-96" data-title="contract_body/comment"><span class="cupd">/</span>/<span class="cupd"> </span>l<span class="cupd">and </span>i<span class="cupd">t</span><span class="cupd">e</span><span class="cupd">m</span><span class="cupd"> </span><span class="cupd">b</span><span class="cupd">a</span>r</span></span>
	<span class="marker" id="mapping-421"></span><span class="token add" data-title="contract_body/event_definition">event Equip(
		uint256 indexed tokenId,
		address resource,
		uint256 index,
		address staker,
		address token,
		uint256 id
	);</span>
	<span class="marker" id="mapping-422"></span><span class="token add" data-title="contract_body/event_definition">event Divest(
		uint256 indexed tokenId,
		address resource,
		uint256 index,
		address staker,
		address token,
		uint256 id
	);</span>

	<span class="marker" id="mapping-423"></span><span class="token add" data-title="contract_body/comment">// 0x434f4e54524143545f4c414e445f424153450000000000000000000000000000</span>
	<span class="marker" id="mapping-424"></span><span class="token mv" id="move-dst-34" data-title="contract_body/state_variable_declaration">bytes32 public constant CONTRACT_LAND_BASE = "CONTRACT_LAND_BASE";</span>

	<span class="marker" id="mapping-425"></span><span class="token add" data-title="contract_body/comment">// 0x434f4e54524143545f474f4c445f45524332305f544f4b454e00000000000000</span>
	<span class="marker" id="mapping-426"></span><span class="token mv" id="move-dst-26" data-title="contract_body/state_variable_declaration">bytes32 public constant CONTRACT_GOLD_ERC20_TOKEN =
		"CONTRACT_GOLD_ERC20_TOKEN";</span>

	<span class="marker" id="mapping-427"></span><span class="token add" data-title="contract_body/comment">// 0x434f4e54524143545f574f4f445f45524332305f544f4b454e00000000000000</span>
	<span class="marker" id="mapping-428"></span><span class="token mv" id="move-dst-27" data-title="contract_body/state_variable_declaration">bytes32 public constant CONTRACT_WOOD_ERC20_TOKEN =
		"CONTRACT_WOOD_ERC20_TOKEN";</span>

	<span class="marker" id="mapping-429"></span><span class="token add" data-title="contract_body/comment">// 0x434f4e54524143545f57415445525f45524332305f544f4b454e000000000000</span>
	<span class="marker" id="mapping-430"></span><span class="token mv" id="move-dst-28" data-title="contract_body/state_variable_declaration">bytes32 public constant CONTRACT_WATER_ERC20_TOKEN =
		"CONTRACT_WATER_ERC20_TOKEN";</span>

	<span class="marker" id="mapping-431"></span><span class="token add" data-title="contract_body/comment">// 0x434f4e54524143545f464952455f45524332305f544f4b454e00000000000000</span>
	<span class="marker" id="mapping-432"></span><span class="token mv" id="move-dst-29" data-title="contract_body/state_variable_declaration">bytes32 public constant CONTRACT_FIRE_ERC20_TOKEN =
		"CONTRACT_FIRE_ERC20_TOKEN";</span>

	<span class="marker" id="mapping-433"></span><span class="token add" data-title="contract_body/comment">// 0x434f4e54524143545f534f494c5f45524332305f544f4b454e00000000000000</span>
	<span class="marker" id="mapping-434"></span><span class="token mv" id="move-dst-30" data-title="contract_body/state_variable_declaration">bytes32 public constant CONTRACT_SOIL_ERC20_TOKEN =
		"CONTRACT_SOIL_ERC20_TOKEN";</span>

	<span class="marker" id="mapping-435"></span><span class="token add" data-title="contract_body/comment">// 0x434f4e54524143545f494e5445525354454c4c41525f454e434f444552000000</span>
	<span class="marker" id="mapping-436"></span><span class="token mv" id="move-dst-37" data-title="contract_body/state_variable_declaration">bytes32 public constant CONTRACT_INTERSTELLAR_ENCODER =
		"CONTRACT_INTERSTELLAR_ENCODER";</span>

	<span class="marker" id="mapping-437"></span><span class="token add" data-title="contract_body/comment">// 0x434f4e54524143545f4f424a4543545f4f574e45525348495000000000000000</span>
	<span class="marker" id="mapping-438"></span><span class="token mv" id="move-dst-31" data-title="contract_body/state_variable_declaration">bytes32 public constant CONTRACT_OBJECT_OWNERSHIP =
		"CONTRACT_OBJECT_OWNERSHIP";</span>

	<span class="marker" id="mapping-439"></span><span class="token add" data-title="contract_body/comment">// 0x434f4e54524143545f544f4b454e5f5553450000000000000000000000000000</span>
	<span class="marker" id="mapping-440"></span><span class="token mv" id="move-dst-40" data-title="contract_body/state_variable_declaration">bytes32 public constant CONTRACT_TOKEN_USE = "CONTRACT_TOKEN_USE";</span>

	<span class="marker" id="mapping-441"></span><span class="token add" data-title="contract_body/comment">//0x4655524e4143455f4954454d5f4d494e455f4645450000000000000000000000</span>
	<span class="marker" id="mapping-442"></span><span class="token mv" id="move-dst-53" data-title="contract_body/state_variable_declaration">bytes32 public constant <span class="marker" id="mapping-443"></span><span class="token upd" id="move-dst-54" data-title="state_variable_declaration/identifier">FUR<span class="cupd">N</span><span class="cupd">AC</span>E_I<span class="cupd">T</span>EM<span class="cupd">_</span>MI<span class="cupd">N</span>E<span class="cupd">_</span>F<span class="cupd">E</span>E</span> = "FURNACE_ITEM_MINE_FEE";</span>

	<span class="marker" id="mapping-444"></span><span class="token add" data-title="contract_body/comment">// 0x434f4e54524143545f4d455441444154415f54454c4c45520000000000000000</span>
	<span class="marker" id="mapping-445"></span><span class="token mv" id="move-dst-51" data-title="contract_body/state_variable_declaration">bytes32 public constant <span class="marker" id="mapping-446"></span><span class="token upd" id="move-dst-52" data-title="state_variable_declaration/identifier">CO<span class="cupd">NT</span>RACT<span class="cupd">_</span>M<span class="cupd">E</span>TADATA_T<span class="cupd">E</span>LL<span class="cupd">ER</span></span> =
		"CONTRACT_METADATA_TELLER";</span>

	<span class="marker" id="mapping-447"></span><span class="token add" data-title="contract_body/comment">// 0x55494e545f4954454d4241525f50524f544543545f504552494f440000000000</span>
	<span class="marker" id="mapping-448"></span><span class="token mv" id="move-dst-49" data-title="contract_body/state_variable_declaration">bytes32 public constant <span class="marker" id="mapping-449"></span><span class="token upd" id="move-dst-50" data-title="state_variable_declaration/identifier"><span class="cupd">UINT_</span>I<span class="cupd">T</span><span class="cupd">E</span>MBAR<span class="cupd">_</span>PR<span class="cupd">O</span>T<span class="cupd">E</span><span class="cupd">C</span>T_PERIOD</span> =
		"UINT_ITEMBAR_PROTECT_PERIOD";</span>

	<span class="marker" id="mapping-450"></span><span class="token add" data-title="contract_body/comment">// rate precision</span>
	<span class="marker" id="mapping-451"></span><span class="token add" data-title="contract_body/state_variable_declaration"><span class="marker" id="mapping-452"></span><span class="token add" data-title="state_variable_declaration/type_name"><span class="marker" id="mapping-453"></span><span class="token mv" id="move-dst-102" data-title="type_name/primitive_type">uint128</span></span> <span class="marker" id="mapping-454"></span><span class="token mv" id="move-dst-43" data-title="state_variable_declaration/visibility">public</span> constant RATE_PRECISION = <span class="marker" id="mapping-455"></span><span class="token add" data-title="state_variable_declaration/binary_expression">10**8</span>;</span>

	<span class="marker" id="mapping-456"></span><span class="token add" data-title="contract_body/comment">// max land miner amounts</span>
	<span class="marker" id="mapping-457"></span><span class="token add" data-title="contract_body/state_variable_declaration"><span class="marker" id="mapping-458"></span><span class="token add" data-title="state_variable_declaration/type_name">uint256</span> <span class="marker" id="mapping-459"></span><span class="token mv" id="move-dst-41" data-title="state_variable_declaration/visibility">public</span> maxMiners;</span>

	<span class="marker" id="mapping-460"></span><span class="token add" data-title="contract_body/comment">// (itemTokenAddress =&gt; (itemTokenId =&gt; (resourceAddress =&gt; mined balance)))</span>
	<span class="marker" id="mapping-461"></span><span class="token add" data-title="contract_body/state_variable_declaration"><span class="marker" id="mapping-462"></span><span class="token add" data-title="state_variable_declaration/type_name">mapping(address =&gt; mapping(uint256 =&gt; mapping(address =&gt; uint256)))</span>
		<span class="marker" id="mapping-463"></span><span class="token mv" id="move-dst-38" data-title="state_variable_declaration/visibility">public</span> itemMinedBalance;</span>

	<span class="marker" id="mapping-464"></span><span class="token add" data-title="contract_body/comment">// (landTokenId =&gt; (resourceAddress =&gt; (landBarIndex =&gt; itemEnhancedRate)))</span>
	<span class="marker" id="mapping-465"></span><span class="token add" data-title="contract_body/state_variable_declaration"><span class="marker" id="mapping-466"></span><span class="token add" data-title="state_variable_declaration/type_name">mapping(uint256 =&gt; mapping(address =&gt; mapping(uint256 =&gt; uint256)))</span>
		<span class="marker" id="mapping-467"></span><span class="token mv" id="move-dst-35" data-title="state_variable_declaration/visibility">public</span> land2BarRate;</span>

	<span class="marker" id="mapping-468"></span><span class="token add" data-title="contract_body/comment">// land item bar</span>
	<span class="marker" id="mapping-469"></span><span class="token add" data-title="contract_body/struct_declaration">struct Bar {
		address staker;    // staker who equip item to the land item bar
		address token;     // item token address of the item which equpped in the land item bar
		uint256 id;        // item token id
		address resource;  // which resource staker want to stake
	}</span>

	<span class="marker" id="mapping-470"></span><span class="token add" data-title="contract_body/comment">// land item bar status</span>
	<span class="marker" id="mapping-471"></span><span class="token add" data-title="contract_body/struct_declaration">struct Status {
		address staker;    // staker who equip item to the land item bar
		uint256 landTokenId; // land token id which the item equipped
		uint256 index;     // land item bar slot which the item equipped
	}</span>

	<span class="marker" id="mapping-472"></span><span class="token add" data-title="contract_body/comment">// max land bar amount</span>
	<span class="marker" id="mapping-473"></span><span class="token add" data-title="contract_body/state_variable_declaration"><span class="marker" id="mapping-474"></span><span class="token add" data-title="state_variable_declaration/type_name">uint256</span> <span class="marker" id="mapping-475"></span><span class="token mv" id="move-dst-32" data-title="state_variable_declaration/visibility">public</span> maxAmount;</span>
	<span class="marker" id="mapping-476"></span><span class="token add" data-title="contract_body/comment">// (landTokenId =&gt; (landBarIndex =&gt; BAR))</span>
	<span class="marker" id="mapping-477"></span><span class="token add" data-title="contract_body/state_variable_declaration"><span class="marker" id="mapping-478"></span><span class="token add" data-title="state_variable_declaration/type_name">mapping(uint256 =&gt; mapping(uint256 =&gt; Bar))</span> <span class="marker" id="mapping-479"></span><span class="token mv" id="move-dst-24" data-title="state_variable_declaration/visibility">public</span> landId2Bars;</span>
	<span class="marker" id="mapping-480"></span><span class="token add" data-title="contract_body/comment">// (itemTokenAddress =&gt; (itemTokenId =&gt; STATUS))</span>
	<span class="marker" id="mapping-481"></span><span class="token add" data-title="contract_body/state_variable_declaration"><span class="marker" id="mapping-482"></span><span class="token add" data-title="state_variable_declaration/type_name">mapping(address =&gt; mapping(uint256 =&gt; Status))</span> <span class="marker" id="mapping-483"></span><span class="token mv" id="move-dst-22" data-title="state_variable_declaration/visibility">public</span> itemId2Status;</span>
	<span class="marker" id="mapping-484"></span><span class="token add" data-title="contract_body/comment">// (itemTokenAddress =&gt; (itemTokenId =&gt; itemProtectPeriod))</span>
	<span class="marker" id="mapping-485"></span><span class="token add" data-title="contract_body/state_variable_declaration">mapping(address =&gt; mapping(uint256 =&gt; uint256)) public protectPeriod;</span>
	<span class="marker" id="mapping-486"></span><span class="token add" data-title="contract_body/comment">// v5 add end</span>

	<span class="marker" id="mapping-487"></span><span class="token add" data-title="contract_body/comment">/*
	 *  Modifiers
	 */</span>
	modifier singletonLockCall() {
		require(!singletonLock, "Only can call once");
		_;
		singletonLock = true;
	}

	function initializeContract(
		address _registry,
		uint256 _resourceReleaseStartTime
	) public singletonLockCall {
		// Ownable constructor
		owner = msg.sender;
		emit LogSetOwner(msg.sender);

		registry = ISettingsRegistry(_registry);

		resourceReleaseStartTime = _resourceReleaseStartTime;

		_registerInterface(InterfaceId_IActivity);
	}

	// get amount of speed uint at this moment
	function _getReleaseSpeedInSeconds(uint256 _tokenId, uint256 _time)
		internal
		view
		returns (uint256 currentSpeed)
	{
		require(_time &gt;= resourceReleaseStartTime, "Should after release time");
		require(
			_time &gt;= land2ResourceMineState[_tokenId].lastUpdateTime,
			"Should after release last update time"
		);

		// after 10000 days from start
		// the resource release speed decreases to 0
		if (TOTAL_SECONDS &lt; _time - resourceReleaseStartTime) {
			return 0;
		}

		// max amount of speed unit of _tokenId for now
		// suppose that speed_uint = 1 in this function
		uint256 availableSpeedInSeconds =
			TOTAL_SECONDS.sub(_time - resourceReleaseStartTime);
		<span class="marker" id="mapping-488"></span><span class="token mv" id="move-dst-88" data-title="function_body/return_statement">return <span class="marker" id="mapping-489"></span><span class="token upd" id="move-dst-89" data-title="return_statement/identifier">availabl<span class="cupd">e</span><span class="cupd">SpeedInSeconds</span></span>;</span>
		<span class="marker" id="mapping-490"></span><span class="token upd" id="move-dst-78" data-title="function_body/comment"><span class="cupd">// </span>// <span class="cupd">time from last update</span></span>
		<span class="marker" id="mapping-491"></span><span class="token upd" id="move-dst-81" data-title="function_body/comment"><span class="cupd">// </span>uin<span class="cupd">t</span>256<span class="cupd"> </span>tim<span class="cupd">e</span>B<span class="cupd">e</span>tw<span class="cupd">ee</span>n =</span>
		<span class="marker" id="mapping-492"></span><span class="token upd" id="move-dst-82" data-title="function_body/comment"><span class="cupd">// </span>	_<span class="cupd">t</span>im<span class="cupd">e </span>-<span class="cupd"> </span><span class="cupd">la</span>n<span class="cupd">d</span>2R<span class="cupd">e</span>sourceM<span class="cupd">i</span>n<span class="cupd">e</span>S<span class="cupd">t</span><span class="cupd">a</span><span class="cupd">t</span>e[_t<span class="cupd">o</span>k<span class="cupd">e</span>nI<span class="cupd">d</span>].<span class="cupd">lastUpdateTime</span>;</span>

		<span class="marker" id="mapping-493"></span><span class="token upd" id="move-dst-85" data-title="function_body/comment"><span class="cupd">// </span>// th<span class="cupd">e</span> <span class="cupd">r</span><span class="cupd">e</span>c<span class="cupd">over</span><span class="cupd"> </span><span class="cupd">s</span><span class="cupd">p</span><span class="cupd">e</span><span class="cupd">e</span>d<span class="cupd"> </span><span class="cupd">i</span><span class="cupd">s</span><span class="cupd"> </span>20/10000,<span class="cupd"> </span>20<span class="cupd"> </span><span class="cupd">t</span><span class="cupd">ime</span>s.</span>
		<span class="marker" id="mapping-494"></span><span class="token add" data-title="function_body/comment">// // recoveryRate overall from lasUpdateTime til now + amount of speed uint at lastUpdateTime</span>
		<span class="marker" id="mapping-495"></span><span class="token add" data-title="function_body/comment">// uint256 nextSpeedInSeconds =</span>
		<span class="marker" id="mapping-496"></span><span class="token add" data-title="function_body/comment">// 	land2ResourceMineState[_tokenId].lastUpdateSpeedInSeconds +</span>
		<span class="marker" id="mapping-497"></span><span class="token add" data-title="function_body/comment">// 		timeBetween *</span>
		<span class="marker" id="mapping-498"></span><span class="token add" data-title="function_body/comment">// 		recoverAttenPerDay;</span>
		<span class="marker" id="mapping-499"></span><span class="token add" data-title="function_body/comment">// // destroyRate overall from lasUpdateTime til now amount of speed uint at lastUpdateTime</span>
		<span class="marker" id="mapping-500"></span><span class="token add" data-title="function_body/comment">// uint256 destroyedSpeedInSeconds =</span>
		<span class="marker" id="mapping-501"></span><span class="token add" data-title="function_body/comment">// 	timeBetween *</span>
		<span class="marker" id="mapping-502"></span><span class="token add" data-title="function_body/comment">// 		land2ResourceMineState[_tokenId].lastDestoryAttenInSeconds;</span>

		<span class="marker" id="mapping-503"></span><span class="token add" data-title="function_body/comment">// if (nextSpeedInSeconds &lt; destroyedSpeedInSeconds) {</span>
		<span class="marker" id="mapping-504"></span><span class="token add" data-title="function_body/comment">// 	nextSpeedInSeconds = 0;</span>
		<span class="marker" id="mapping-505"></span><span class="token add" data-title="function_body/comment">// } else {</span>
		<span class="marker" id="mapping-506"></span><span class="token add" data-title="function_body/comment">// 	nextSpeedInSeconds = nextSpeedInSeconds - destroyedSpeedInSeconds;</span>
		<span class="marker" id="mapping-507"></span><span class="token add" data-title="function_body/comment">// }</span>

		<span class="marker" id="mapping-508"></span><span class="token add" data-title="function_body/comment">// if (nextSpeedInSeconds &gt; availableSpeedInSeconds) {</span>
		<span class="marker" id="mapping-509"></span><span class="token add" data-title="function_body/comment">// 	nextSpeedInSeconds = availableSpeedInSeconds;</span>
		<span class="marker" id="mapping-510"></span><span class="token add" data-title="function_body/comment">// }</span>

		<span class="marker" id="mapping-511"></span><span class="token add" data-title="function_body/comment">// return nextSpeedInSeconds;</span>
	}

	function getReleaseSpeed(
		uint256 _tokenId,
		address <span class="marker" id="mapping-512"></span><span class="token upd" id="move-dst-90" data-title="parameter/identifier"><span class="cupd">_resource</span></span>,
		uint256 _time
	) public view returns (uint256 currentSpeed) {
		return
			<span class="marker" id="mapping-513"></span><span class="token add" data-title="return_statement/call_expression"><span class="marker" id="mapping-514"></span><span class="token add" data-title="call_expression/member_expression"><span class="marker" id="mapping-515"></span><span class="token mv" id="move-dst-91" data-title="member_expression/call_expression">ILandBase(registry.addressOf(CONTRACT_LAND_BASE))
				.getResourceRate(_tokenId, <span class="marker" id="mapping-516"></span><span class="token upd" id="move-dst-92" data-title="call_argument/identifier"><span class="cupd">_resource</span></span>)
				.mul(_getReleaseSpeedInSeconds(_tokenId, _time))
				.<span class="marker" id="mapping-517"></span><span class="token upd" id="move-dst-93" data-title="member_expression/identifier">mul</span>(<span class="marker" id="mapping-518"></span><span class="token add" data-title="call_expression/call_argument">1 ether</span>)</span>
				.div</span>(<span class="marker" id="mapping-519"></span><span class="token mv" id="move-dst-94" data-title="call_expression/call_argument">TOTAL_SECONDS</span>)</span>;
	}

	function _getMinableBalance(
		uint256 _tokenId,
		address <span class="marker" id="mapping-520"></span><span class="token upd" id="move-dst-97" data-title="parameter/identifier"><span class="cupd">_resource</span></span>,
		uint256 _currentTime,
		uint256 _lastUpdateTime
	) public view returns (uint256 minableBalance) {
		uint256 speed_in_current_period =
			ILandBase(registry.addressOf(CONTRACT_LAND_BASE))
				.getResourceRate(_tokenId, <span class="marker" id="mapping-521"></span><span class="token upd" id="move-dst-98" data-title="call_argument/identifier"><span class="cupd">_resource</span></span>)
				.mul(
				_getReleaseSpeedInSeconds(
					_tokenId,
					((_currentTime + _lastUpdateTime) / 2)
				)
			)
				.mul(1 ether)
				.div(1 days)
				.div(TOTAL_SECONDS);

		// calculate the area of trapezoid
		minableBalance = speed_in_current_period.mul(
			_currentTime - _lastUpdateTime
		);
	}

	function _getMaxMineBalance(
		uint256 _tokenId,
		address <span class="marker" id="mapping-522"></span><span class="token upd" id="move-dst-99" data-title="parameter/identifier"><span class="cupd">_resource</span></span>,
		uint256 _currentTime,
		uint256 _lastUpdateTime
	) internal view returns (uint256) {
		// totalMinerStrength is in wei
		return
			<span class="marker" id="mapping-523"></span><span class="token add" data-title="member_expression/call_expression">getTotalMiningStrength(_tokenId, _resource)</span>
				.mul(_currentTime - _lastUpdateTime)
				.div(1 days);
	}

	<span class="marker" id="mapping-524"></span><span class="token add" data-title="contract_body/function_definition">function setMaxMiners(<span class="marker" id="mapping-525"></span><span class="token add" data-title="function_definition/parameter">uint256 _maxMiners</span>) <span class="marker" id="mapping-526"></span><span class="token mv" id="move-dst-45" data-title="function_definition/visibility">public</span> <span class="marker" id="mapping-527"></span><span class="token add" data-title="function_definition/modifier_invocation">auth</span> <span class="marker" id="mapping-528"></span><span class="token add" data-title="function_definition/function_body">{
		<span class="marker" id="mapping-529"></span><span class="token add" data-title="function_body/expression_statement"><span class="marker" id="mapping-530"></span><span class="token add" data-title="expression_statement/call_expression">require(<span class="marker" id="mapping-531"></span><span class="token add" data-title="call_expression/call_argument">_maxMiners &gt; maxMiners</span>, <span class="marker" id="mapping-532"></span><span class="token add" data-title="call_expression/call_argument"><span class="marker" id="mapping-533"></span><span class="token mv" id="move-dst-46" data-title="call_argument/string_literal">"Land: INVALID_MAXMINERS"</span></span>)</span>;</span>
		<span class="marker" id="mapping-534"></span><span class="token add" data-title="function_body/expression_statement">maxMiners = _maxMiners;</span>
	}</span></span>

	function mine(uint256 _landTokenId) public {
		_mineAllResource(
			_landTokenId,
			registry.addressOf(CONTRACT_GOLD_ERC20_TOKEN),
			registry.addressOf(CONTRACT_WOOD_ERC20_TOKEN),
			registry.addressOf(CONTRACT_WATER_ERC20_TOKEN),
			registry.addressOf(CONTRACT_FIRE_ERC20_TOKEN),
			registry.addressOf(CONTRACT_SOIL_ERC20_TOKEN)
		);
	}

	function _mineAllResource(
		uint256 _landTokenId,
		address _gold,
		address _wood,
		address _water,
		address _fire,
		address _soil
	) internal {
		require(
			IInterstellarEncoder(
				registry.addressOf(CONTRACT_INTERSTELLAR_ENCODER)
			)
				.getObjectClass(_landTokenId) == 1,
			"Token must be land."
		);

		<span class="marker" id="mapping-535"></span><span class="token add" data-title="function_body/comment">// v5 remove</span>
		<span class="marker" id="mapping-536"></span><span class="token add" data-title="function_body/comment">// if (land2ResourceMineState[_landTokenId].lastUpdateTime == 0) {</span>
		<span class="marker" id="mapping-537"></span><span class="token add" data-title="function_body/comment">// 	land2ResourceMineState[_landTokenId].lastUpdateTime = uint128(</span>
		<span class="marker" id="mapping-538"></span><span class="token add" data-title="function_body/comment">// 		resourceReleaseStartTime</span>
		<span class="marker" id="mapping-539"></span><span class="token add" data-title="function_body/comment">// 	);</span>
		<span class="marker" id="mapping-540"></span><span class="token add" data-title="function_body/comment">// 	land2ResourceMineState[_landTokenId]</span>
		<span class="marker" id="mapping-541"></span><span class="token add" data-title="function_body/comment">// 		.lastUpdateSpeedInSeconds = TOTAL_SECONDS;</span>
		<span class="marker" id="mapping-542"></span><span class="token add" data-title="function_body/comment">// }</span>

		_mineResource(_landTokenId, _gold);
		_mineResource(_landTokenId, _wood);
		_mineResource(_landTokenId, _water);
		_mineResource(_landTokenId, _fire);
		_mineResource(_landTokenId, _soil);

		<span class="marker" id="mapping-543"></span><span class="token add" data-title="function_body/comment">// v5 remove</span>
		<span class="marker" id="mapping-544"></span><span class="token add" data-title="function_body/comment">// land2ResourceMineState[_landTokenId]</span>
		<span class="marker" id="mapping-545"></span><span class="token add" data-title="function_body/comment">// 	.lastUpdateSpeedInSeconds = _getReleaseSpeedInSeconds(</span>
		<span class="marker" id="mapping-546"></span><span class="token add" data-title="function_body/comment">// 	_landTokenId,</span>
		<span class="marker" id="mapping-547"></span><span class="token add" data-title="function_body/comment">// 	now</span>
		<span class="marker" id="mapping-548"></span><span class="token add" data-title="function_body/comment">// );</span>

		land2ResourceMineState[_landTokenId].lastUpdateTime = uint128(now);
	}

	<span class="marker" id="mapping-549"></span><span class="token add" data-title="contract_body/function_definition">function _distribution(
		<span class="marker" id="mapping-550"></span><span class="token add" data-title="function_definition/parameter">uint256 _landId</span>,
		<span class="marker" id="mapping-551"></span><span class="token add" data-title="function_definition/parameter">address _resource</span>,
		<span class="marker" id="mapping-552"></span><span class="token add" data-title="function_definition/parameter">uint256 minedBalance</span>,
		<span class="marker" id="mapping-553"></span><span class="token add" data-title="function_definition/parameter">uint256 barsRate</span>
	) <span class="marker" id="mapping-554"></span><span class="token add" data-title="function_definition/visibility">internal</span> <span class="marker" id="mapping-555"></span><span class="token mv" id="move-dst-164" data-title="function_definition/return_type_definition">returns (uint256)</span> <span class="marker" id="mapping-556"></span><span class="token add" data-title="function_definition/function_body">{
		<span class="marker" id="mapping-557"></span><span class="token add" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-558"></span><span class="token mv" id="move-dst-79" data-title="variable_declaration_statement/variable_declaration">uint256 <span class="marker" id="mapping-559"></span><span class="token upd" id="move-dst-80" data-title="variable_declaration/identifier">land<span class="cupd">B</span>alance</span></span> =
			<span class="marker" id="mapping-560"></span><span class="token add" data-title="variable_declaration_statement/call_expression">minedBalance.mul(RATE_PRECISION).div(barsRate.add(RATE_PRECISION))</span>;</span>
		<span class="marker" id="mapping-561"></span><span class="token mv" id="move-dst-100" data-title="function_body/variable_declaration_statement">uint256 <span class="marker" id="mapping-562"></span><span class="token upd" id="move-dst-101" data-title="variable_declaration/identifier">barsBala<span class="cupd">n</span>ce</span> = <span class="marker" id="mapping-563"></span><span class="token add" data-title="variable_declaration_statement/call_expression">minedBalance.sub(landBalance)</span>;</span>
		<span class="marker" id="mapping-564"></span><span class="token add" data-title="function_body/for_statement">for (uint256 i = 0; i &lt; maxAmount; i++) {
			(address itemToken, uint256 itemId, address resouce) =
				getBarItem(_landId, i);
			if (itemToken != address(0) &amp;&amp; resouce == _resource) {
				uint256 barBalance =
					barsBalance.mul(getBarRate(_landId, _resource, i)).div(
						barsRate
					);
				(barBalance, landBalance) = _payFee(barBalance, landBalance);
				itemMinedBalance[itemToken][itemId][
					_resource
				] = getItemMinedBalance(itemToken, itemId, _resource).add(
					barBalance
				);
			}
		}</span>
		<span class="marker" id="mapping-565"></span><span class="token add" data-title="function_body/return_statement">return landBalance;</span>
	}</span></span>

	<span class="marker" id="mapping-566"></span><span class="token add" data-title="contract_body/function_definition">function _payFee(<span class="marker" id="mapping-567"></span><span class="token add" data-title="function_definition/parameter">uint256 barBalance</span>, <span class="marker" id="mapping-568"></span><span class="token add" data-title="function_definition/parameter">uint256 landBalance</span>)
		<span class="marker" id="mapping-569"></span><span class="token add" data-title="function_definition/visibility">internal</span>
		<span class="marker" id="mapping-570"></span><span class="token mv" id="move-dst-154" data-title="function_definition/state_mutability">view</span>
		<span class="marker" id="mapping-571"></span><span class="token mv" id="move-dst-155" data-title="function_definition/return_type_definition">returns (uint256, uint256)</span>
	<span class="marker" id="mapping-572"></span><span class="token add" data-title="function_definition/function_body">{
		<span class="marker" id="mapping-573"></span><span class="token add" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-574"></span><span class="token mv" id="move-dst-83" data-title="variable_declaration_statement/variable_declaration">uint256 <span class="marker" id="mapping-575"></span><span class="token upd" id="move-dst-84" data-title="variable_declaration/identifier">f<span class="cupd">e</span>e</span></span> =
			<span class="marker" id="mapping-576"></span><span class="token add" data-title="variable_declaration_statement/call_expression">barBalance.mul(registry.uintOf(FURNACE_ITEM_MINE_FEE)).div(
				RATE_PRECISION
			)</span>;</span>
		<span class="marker" id="mapping-577"></span><span class="token add" data-title="function_body/expression_statement">barBalance = barBalance.sub(fee);</span>
		<span class="marker" id="mapping-578"></span><span class="token add" data-title="function_body/expression_statement">landBalance = landBalance.add(fee);</span>
		<span class="marker" id="mapping-579"></span><span class="token add" data-title="function_body/return_statement">return (barBalance, landBalance);</span>
	}</span></span>

	<span class="marker" id="mapping-580"></span><span class="token add" data-title="contract_body/function_definition">function _mineResource(<span class="marker" id="mapping-581"></span><span class="token add" data-title="function_definition/parameter">uint256 _landId</span>, <span class="marker" id="mapping-582"></span><span class="token add" data-title="function_definition/parameter">address _resource</span>) <span class="marker" id="mapping-583"></span><span class="token add" data-title="function_definition/visibility">internal</span> <span class="marker" id="mapping-584"></span><span class="token add" data-title="function_definition/function_body">{
		// the longest seconds to zero speed.
		<span class="marker" id="mapping-585"></span><span class="token add" data-title="function_body/if_statement">if (getLandMiningStrength(_landId, _resource) == 0) {
			return;
		}</span>
		<span class="marker" id="mapping-586"></span><span class="token add" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-587"></span><span class="token add" data-title="variable_declaration_statement/variable_declaration">uint256 minedBalance</span> = <span class="marker" id="mapping-588"></span><span class="token add" data-title="variable_declaration_statement/call_expression">_calculateMinedBalance(<span class="marker" id="mapping-589"></span><span class="token add" data-title="call_expression/call_argument">_landId</span>, <span class="marker" id="mapping-590"></span><span class="token add" data-title="call_expression/call_argument">_resource</span>, <span class="marker" id="mapping-591"></span><span class="token mv" id="move-dst-107" data-title="call_expression/call_argument">now</span>)</span>;</span>
		<span class="marker" id="mapping-592"></span><span class="token add" data-title="function_body/if_statement">if (minedBalance == 0) {
			return;
		}</span>

		<span class="marker" id="mapping-593"></span><span class="token add" data-title="function_body/variable_declaration_statement">uint256 barsRate = getBarsRate(_landId, _resource);</span>
		<span class="marker" id="mapping-594"></span><span class="token mv" id="move-dst-86" data-title="function_body/variable_declaration_statement">uint256 <span class="marker" id="mapping-595"></span><span class="token upd" id="move-dst-87" data-title="variable_declaration/identifier">lan<span class="cupd">d</span>Bala<span class="cupd">n</span>ce</span> = <span class="marker" id="mapping-596"></span><span class="token add" data-title="variable_declaration_statement/identifier">minedBalance</span>;</span>
		<span class="marker" id="mapping-597"></span><span class="token add" data-title="function_body/if_statement">if (barsRate &gt; 0) {
			// V5 yeild distribution
			landBalance = _distribution(
				_landId,
				_resource,
				minedBalance,
				barsRate
			);
		}</span>
		<span class="marker" id="mapping-598"></span><span class="token add" data-title="function_body/expression_statement">land2ResourceMineState[_landId].mintedBalance[
			_resource
		] = getLandMinedBalance(_landId, _resource).add(landBalance);</span>
	}</span></span>

	function _calculateMinedBalance(
		uint256 _landTokenId,
		address _resourceToken,
		uint256 _currentTime
	) internal <span class="marker" id="mapping-599"></span><span class="token add" data-title="function_definition/state_mutability">view</span> returns (uint256) {
		uint256 currentTime = _currentTime;

		uint256 minedBalance;
		uint256 minableBalance;
		if (currentTime &gt; (resourceReleaseStartTime + TOTAL_SECONDS)) {
			currentTime = (resourceReleaseStartTime + TOTAL_SECONDS);
		}

		uint256 lastUpdateTime =
			land2ResourceMineState[_landTokenId].lastUpdateTime;
		require(currentTime &gt;= lastUpdateTime);

		if (lastUpdateTime &gt;= (resourceReleaseStartTime + TOTAL_SECONDS)) {
			minedBalance = 0;
			minableBalance = 0;
		} else {
			minedBalance = _getMaxMineBalance(
				_landTokenId,
				_resourceToken,
				currentTime,
				lastUpdateTime
			);
			minableBalance = _getMinableBalance(
				_landTokenId,
				_resourceToken,
				currentTime,
				lastUpdateTime
			);
		}

		if (minedBalance &gt; minableBalance) {
			minedBalance = minableBalance;
		}

		return minedBalance;
	}

	<span class="marker" id="mapping-600"></span><span class="token add" data-title="contract_body/comment">// v5 remove</span>
	<span class="marker" id="mapping-601"></span><span class="token add" data-title="contract_body/comment">// function claimAllResource(uint256 _landTokenId) public {</span>
	<span class="marker" id="mapping-602"></span><span class="token add" data-title="contract_body/comment">// 	require(</span>
	<span class="marker" id="mapping-603"></span><span class="token add" data-title="contract_body/comment">// 		msg.sender == ownership.ownerOf(_landTokenId),</span>
	<span class="marker" id="mapping-604"></span><span class="token add" data-title="contract_body/comment">// 		"Must be the owner of the land"</span>
	<span class="marker" id="mapping-605"></span><span class="token add" data-title="contract_body/comment">// 	);</span>

	<span class="marker" id="mapping-606"></span><span class="token add" data-title="contract_body/comment">// 	_mineAllResource(_landTokenId, gold, wood, water, fire, soil);</span>

	<span class="marker" id="mapping-607"></span><span class="token add" data-title="contract_body/comment">// 	uint256 goldBalance;</span>
	<span class="marker" id="mapping-608"></span><span class="token add" data-title="contract_body/comment">// 	uint256 woodBalance;</span>
	<span class="marker" id="mapping-609"></span><span class="token add" data-title="contract_body/comment">// 	uint256 waterBalance;</span>
	<span class="marker" id="mapping-610"></span><span class="token add" data-title="contract_body/comment">// 	uint256 fireBalance;</span>
	<span class="marker" id="mapping-611"></span><span class="token add" data-title="contract_body/comment">// 	uint256 soilBalance;</span>

	<span class="marker" id="mapping-612"></span><span class="token add" data-title="contract_body/comment">// 	if (land2ResourceMineState[_landTokenId].mintedBalance[gold] &gt; 0) {</span>
	<span class="marker" id="mapping-613"></span><span class="token add" data-title="contract_body/comment">// 		goldBalance = land2ResourceMineState[_landTokenId].mintedBalance[</span>
	<span class="marker" id="mapping-614"></span><span class="token add" data-title="contract_body/comment">// 			gold</span>
	<span class="marker" id="mapping-615"></span><span class="token add" data-title="contract_body/comment">// 		];</span>
	<span class="marker" id="mapping-616"></span><span class="token add" data-title="contract_body/comment">// 		IMintableERC20(gold).mint(msg.sender, goldBalance);</span>
	<span class="marker" id="mapping-617"></span><span class="token add" data-title="contract_body/comment">// 		land2ResourceMineState[_landTokenId].mintedBalance[gold] = 0;</span>
	<span class="marker" id="mapping-618"></span><span class="token add" data-title="contract_body/comment">// 	}</span>

	<span class="marker" id="mapping-619"></span><span class="token add" data-title="contract_body/comment">// 	if (land2ResourceMineState[_landTokenId].mintedBalance[wood] &gt; 0) {</span>
	<span class="marker" id="mapping-620"></span><span class="token add" data-title="contract_body/comment">// 		woodBalance = land2ResourceMineState[_landTokenId].mintedBalance[</span>
	<span class="marker" id="mapping-621"></span><span class="token add" data-title="contract_body/comment">// 			wood</span>
	<span class="marker" id="mapping-622"></span><span class="token add" data-title="contract_body/comment">// 		];</span>
	<span class="marker" id="mapping-623"></span><span class="token add" data-title="contract_body/comment">// 		IMintableERC20(wood).mint(msg.sender, woodBalance);</span>
	<span class="marker" id="mapping-624"></span><span class="token add" data-title="contract_body/comment">// 		land2ResourceMineState[_landTokenId].mintedBalance[wood] = 0;</span>
	<span class="marker" id="mapping-625"></span><span class="token add" data-title="contract_body/comment">// 	}</span>

	<span class="marker" id="mapping-626"></span><span class="token add" data-title="contract_body/comment">// 	if (land2ResourceMineState[_landTokenId].mintedBalance[water] &gt; 0) {</span>
	<span class="marker" id="mapping-627"></span><span class="token add" data-title="contract_body/comment">// 		waterBalance = land2ResourceMineState[_landTokenId].mintedBalance[</span>
	<span class="marker" id="mapping-628"></span><span class="token add" data-title="contract_body/comment">// 			water</span>
	<span class="marker" id="mapping-629"></span><span class="token add" data-title="contract_body/comment">// 		];</span>
	<span class="marker" id="mapping-630"></span><span class="token add" data-title="contract_body/comment">// 		IMintableERC20(water).mint(msg.sender, waterBalance);</span>
	<span class="marker" id="mapping-631"></span><span class="token add" data-title="contract_body/comment">// 		land2ResourceMineState[_landTokenId].mintedBalance[water] = 0;</span>
	<span class="marker" id="mapping-632"></span><span class="token add" data-title="contract_body/comment">// 	}</span>

	<span class="marker" id="mapping-633"></span><span class="token add" data-title="contract_body/comment">// 	if (land2ResourceMineState[_landTokenId].mintedBalance[fire] &gt; 0) {</span>
	<span class="marker" id="mapping-634"></span><span class="token add" data-title="contract_body/comment">// 		fireBalance = land2ResourceMineState[_landTokenId].mintedBalance[</span>
	<span class="marker" id="mapping-635"></span><span class="token add" data-title="contract_body/comment">// 			fire</span>
	<span class="marker" id="mapping-636"></span><span class="token add" data-title="contract_body/comment">// 		];</span>
	<span class="marker" id="mapping-637"></span><span class="token add" data-title="contract_body/comment">// 		IMintableERC20(fire).mint(msg.sender, fireBalance);</span>
	<span class="marker" id="mapping-638"></span><span class="token add" data-title="contract_body/comment">// 		land2ResourceMineState[_landTokenId].mintedBalance[fire] = 0;</span>
	<span class="marker" id="mapping-639"></span><span class="token add" data-title="contract_body/comment">// 	}</span>

	<span class="marker" id="mapping-640"></span><span class="token add" data-title="contract_body/comment">// 	if (land2ResourceMineState[_landTokenId].mintedBalance[soil] &gt; 0) {</span>
	<span class="marker" id="mapping-641"></span><span class="token add" data-title="contract_body/comment">// 		soilBalance = land2ResourceMineState[_landTokenId].mintedBalance[</span>
	<span class="marker" id="mapping-642"></span><span class="token add" data-title="contract_body/comment">// 			soil</span>
	<span class="marker" id="mapping-643"></span><span class="token add" data-title="contract_body/comment">// 		];</span>
	<span class="marker" id="mapping-644"></span><span class="token add" data-title="contract_body/comment">// 		IMintableERC20(soil).mint(msg.sender, soilBalance);</span>
	<span class="marker" id="mapping-645"></span><span class="token add" data-title="contract_body/comment">// 		land2ResourceMineState[_landTokenId].mintedBalance[soil] = 0;</span>
	<span class="marker" id="mapping-646"></span><span class="token add" data-title="contract_body/comment">// 	}</span>

	<span class="marker" id="mapping-647"></span><span class="token add" data-title="contract_body/comment">// 	emit ResourceClaimed(</span>
	<span class="marker" id="mapping-648"></span><span class="token add" data-title="contract_body/comment">// 		msg.sender,</span>
	<span class="marker" id="mapping-649"></span><span class="token add" data-title="contract_body/comment">// 		_landTokenId,</span>
	<span class="marker" id="mapping-650"></span><span class="token add" data-title="contract_body/comment">// 		goldBalance,</span>
	<span class="marker" id="mapping-651"></span><span class="token add" data-title="contract_body/comment">// 		woodBalance,</span>
	<span class="marker" id="mapping-652"></span><span class="token add" data-title="contract_body/comment">// 		waterBalance,</span>
	<span class="marker" id="mapping-653"></span><span class="token add" data-title="contract_body/comment">// 		fireBalance,</span>
	<span class="marker" id="mapping-654"></span><span class="token add" data-title="contract_body/comment">// 		soilBalance</span>
	<span class="marker" id="mapping-655"></span><span class="token add" data-title="contract_body/comment">// 	);</span>
	<span class="marker" id="mapping-656"></span><span class="token add" data-title="contract_body/comment">// }</span>

	// both for own _tokenId or hired one
	function startMining(
		uint256 _tokenId,
		uint256 _landTokenId,
		address _resource
	) public {
		<span class="marker" id="mapping-657"></span><span class="token mv" id="move-dst-135" data-title="member_expression/call_expression">ITokenUse(registry.addressOf(CONTRACT_TOKEN_USE))</span>.addActivity(
			_tokenId,
			msg.sender,
			0
		);

		// require the permission from land owner;
		require(
			msg.sender ==
				ERC721(registry.addressOf(CONTRACT_OBJECT_OWNERSHIP)).ownerOf(
					_landTokenId
				),
			"Must be the owner of the land"
		);

		// make sure that _tokenId won't be used repeatedly
		require(miner2Index[_tokenId].landTokenId == 0);

		// update status!
		mine(_landTokenId);

		uint256 _index =
			land2ResourceMineState[_landTokenId].miners[_resource].length;

		land2ResourceMineState[_landTokenId].totalMiners += 1;

		<span class="marker" id="mapping-658"></span><span class="token add" data-title="function_body/comment">// v5 remove</span>
		<span class="marker" id="mapping-659"></span><span class="token add" data-title="function_body/comment">// if (land2ResourceMineState[_landTokenId].maxMiners == 0) {</span>
		<span class="marker" id="mapping-660"></span><span class="token add" data-title="function_body/comment">// 	land2ResourceMineState[_landTokenId].maxMiners = 5;</span>
		<span class="marker" id="mapping-661"></span><span class="token add" data-title="function_body/comment">// }</span>

		require(
			<span class="marker" id="mapping-662"></span><span class="token mv" id="move-dst-136" data-title="call_argument/binary_expression">land2ResourceMineState[_landTokenId].totalMiners &lt;= <span class="marker" id="mapping-663"></span><span class="token upd" id="move-dst-137" data-title="binary_expression/identifier">m<span class="cupd">a</span>x<span class="cupd">Mine</span>rs</span></span><span class="marker" id="mapping-664"></span><span class="token add" data-title="call_expression/,">,</span>
			<span class="marker" id="mapping-665"></span><span class="token add" data-title="call_expression/call_argument"><span class="marker" id="mapping-666"></span><span class="token mv" id="move-dst-25" data-title="call_argument/string_literal">"Land: EXCEED_MAXAMOUNT"</span></span>
		);

		address miner =
			IInterstellarEncoder(
				registry.addressOf(CONTRACT_INTERSTELLAR_ENCODER)
			)
				.getObjectAddress(_tokenId);
		uint256 strength =
			IMinerObject(miner).strengthOf(_tokenId, _resource, _landTokenId);

		land2ResourceMineState[_landTokenId].miners[_resource].push(_tokenId);
		land2ResourceMineState[_landTokenId].totalMinerStrength[
			_resource
		] += strength;

		miner2Index[_tokenId] = MinerStatus({
			landTokenId: _landTokenId,
			resource: _resource,
			indexInResource: uint64(_index)
		});

		emit StartMining(_tokenId, _landTokenId, _resource, strength);
	}

	function batchStartMining(
		uint256[] _tokenIds,
		uint256[] _landTokenIds,
		address[] _resources
	) public {
		require(
			_tokenIds.length == _landTokenIds.length &amp;&amp;
				_landTokenIds.length == _resources.length,
			"input error"
		);
		<span class="marker" id="mapping-667"></span><span class="token add" data-title="primitive_type/uint256">uint256</span> length = _tokenIds.length;

		for (<span class="marker" id="mapping-668"></span><span class="token add" data-title="primitive_type/uint256">uint256</span> i = 0; i &lt; length; i++) {
			startMining(_tokenIds[i], _landTokenIds[i], _resources[i]);
		}
	}

	function <span class="marker" id="mapping-669"></span><span class="token upd" id="move-dst-138" data-title="function_definition/identifier"><span class="cupd">batchClaim</span>Land<span class="cupd">Resource</span></span>(uint256[] _landTokenIds) public {
		<span class="marker" id="mapping-670"></span><span class="token add" data-title="primitive_type/uint256">uint256</span> length = _landTokenIds.length;

		for (<span class="marker" id="mapping-671"></span><span class="token add" data-title="primitive_type/uint256">uint256</span> i = 0; i &lt; length; i++) {
			<span class="marker" id="mapping-672"></span><span class="token upd" id="move-dst-139" data-title="call_expression/identifier"><span class="cupd">claim</span>Land<span class="cupd">Resource</span></span>(_landTokenIds[i]);
		}
	}

	// Only trigger from Token Activity.
	function activityStopped(uint256 _tokenId) public auth {
		_stopMining(_tokenId);
	}

	function stopMining(uint256 _tokenId) public {
		ITokenUse(registry.addressOf(CONTRACT_TOKEN_USE)).removeActivity(
			_tokenId,
			msg.sender
		);
	}

	function _stopMining(uint256 _tokenId) internal {
		// remove the miner from land2ResourceMineState;
		uint64 minerIndex = miner2Index[_tokenId].indexInResource;
		address resource = miner2Index[_tokenId].resource;
		uint256 landTokenId = miner2Index[_tokenId].landTokenId;

		// update status!
		mine(landTokenId);

		uint64 lastMinerIndex =
			uint64(
				land2ResourceMineState[landTokenId].miners[resource].length.sub(
					1
				)
			);
		uint256 lastMiner =
			land2ResourceMineState[landTokenId].miners[resource][
				lastMinerIndex
			];

		land2ResourceMineState[landTokenId].miners[resource][
			minerIndex
		] = lastMiner;
		land2ResourceMineState[landTokenId].miners[resource][
			lastMinerIndex
		] = 0;

		land2ResourceMineState[landTokenId].miners[resource].length -= 1;
		miner2Index[lastMiner].indexInResource = minerIndex;

		land2ResourceMineState[landTokenId].totalMiners -= 1;

		address miner =
			IInterstellarEncoder(
				registry.addressOf(CONTRACT_INTERSTELLAR_ENCODER)
			)
				.getObjectAddress(_tokenId);
		uint256 strength =
			IMinerObject(miner).strengthOf(_tokenId, resource, landTokenId);

		// for backward compatibility
		// if strength can fluctuate some time in the future
		if (
			land2ResourceMineState[landTokenId].totalMinerStrength[resource] !=
			0
		) {
			if (
				land2ResourceMineState[landTokenId].totalMinerStrength[
					resource
				] &gt; strength
			) {
				land2ResourceMineState[landTokenId].totalMinerStrength[
					resource
				] = land2ResourceMineState[landTokenId].totalMinerStrength[
					resource
				]
					.sub(strength);
			} else {
				land2ResourceMineState[landTokenId].totalMinerStrength[
					resource
				] = 0;
			}
		}

		if (land2ResourceMineState[landTokenId].totalMiners == 0) {
			land2ResourceMineState[landTokenId].totalMinerStrength[
				resource
			] = 0;
		}

		delete miner2Index[_tokenId];

		emit StopMining(_tokenId, landTokenId, resource, strength);
	}

	<span class="marker" id="mapping-673"></span><span class="token add" data-title="contract_body/comment">// v5 remove</span>
	<span class="marker" id="mapping-674"></span><span class="token add" data-title="contract_body/comment">// function getMinerOnLand(</span>
	<span class="marker" id="mapping-675"></span><span class="token add" data-title="contract_body/comment">// 	uint256 _landTokenId,</span>
	<span class="marker" id="mapping-676"></span><span class="token add" data-title="contract_body/comment">// 	address _resourceToken,</span>
	<span class="marker" id="mapping-677"></span><span class="token add" data-title="contract_body/comment">// 	uint256 _index</span>
	<span class="marker" id="mapping-678"></span><span class="token add" data-title="contract_body/comment">// ) public view returns (uint256) {</span>
	<span class="marker" id="mapping-679"></span><span class="token add" data-title="contract_body/comment">// 	return</span>
	<span class="marker" id="mapping-680"></span><span class="token add" data-title="contract_body/comment">// 		land2ResourceMineState[_landTokenId].miners[_resourceToken][_index];</span>
	<span class="marker" id="mapping-681"></span><span class="token add" data-title="contract_body/comment">// }</span>

	<span class="marker" id="mapping-682"></span><span class="token add" data-title="contract_body/comment">// function getTotalMiningStrength(</span>
	<span class="marker" id="mapping-683"></span><span class="token add" data-title="contract_body/comment">// 	uint256 _landTokenId,</span>
	<span class="marker" id="mapping-684"></span><span class="token add" data-title="contract_body/comment">// 	address _resourceToken</span>
	<span class="marker" id="mapping-685"></span><span class="token add" data-title="contract_body/comment">// ) public view returns (uint256) {</span>
	<span class="marker" id="mapping-686"></span><span class="token add" data-title="contract_body/comment">// 	return</span>
	<span class="marker" id="mapping-687"></span><span class="token add" data-title="contract_body/comment">// 		land2ResourceMineState[_landTokenId].totalMinerStrength[</span>
	<span class="marker" id="mapping-688"></span><span class="token add" data-title="contract_body/comment">// 			_resourceToken</span>
	<span class="marker" id="mapping-689"></span><span class="token add" data-title="contract_body/comment">// 		];</span>
	<span class="marker" id="mapping-690"></span><span class="token add" data-title="contract_body/comment">// }</span>

	<span class="marker" id="mapping-691"></span><span class="token add" data-title="contract_body/comment">// function availableResources(</span>
	<span class="marker" id="mapping-692"></span><span class="token add" data-title="contract_body/comment">// 	uint256 _landTokenId,</span>
	<span class="marker" id="mapping-693"></span><span class="token add" data-title="contract_body/comment">// 	address[5] _resourceTokens</span>
	<span class="marker" id="mapping-694"></span><span class="token add" data-title="contract_body/comment">// )</span>
	<span class="marker" id="mapping-695"></span><span class="token add" data-title="contract_body/comment">// 	public</span>
	<span class="marker" id="mapping-696"></span><span class="token add" data-title="contract_body/comment">// 	view</span>
	<span class="marker" id="mapping-697"></span><span class="token add" data-title="contract_body/comment">// 	returns (</span>
	<span class="marker" id="mapping-698"></span><span class="token add" data-title="contract_body/comment">// 		uint256,</span>
	<span class="marker" id="mapping-699"></span><span class="token add" data-title="contract_body/comment">// 		uint256,</span>
	<span class="marker" id="mapping-700"></span><span class="token add" data-title="contract_body/comment">// 		uint256,</span>
	<span class="marker" id="mapping-701"></span><span class="token add" data-title="contract_body/comment">// 		uint256,</span>
	<span class="marker" id="mapping-702"></span><span class="token add" data-title="contract_body/comment">// 		uint256</span>
	<span class="marker" id="mapping-703"></span><span class="token add" data-title="contract_body/comment">// 	)</span>
	<span class="marker" id="mapping-704"></span><span class="token add" data-title="contract_body/comment">// {</span>
	<span class="marker" id="mapping-705"></span><span class="token add" data-title="contract_body/comment">// 	uint256 availableGold =</span>
	<span class="marker" id="mapping-706"></span><span class="token add" data-title="contract_body/comment">// 		_calculateMinedBalance(_landTokenId, _resourceTokens[0], now) +</span>
	<span class="marker" id="mapping-707"></span><span class="token add" data-title="contract_body/comment">// 			land2ResourceMineState[_landTokenId].mintedBalance[</span>
	<span class="marker" id="mapping-708"></span><span class="token add" data-title="contract_body/comment">// 				_resourceTokens[0]</span>
	<span class="marker" id="mapping-709"></span><span class="token add" data-title="contract_body/comment">// 			];</span>
	<span class="marker" id="mapping-710"></span><span class="token add" data-title="contract_body/comment">// 	uint256 availableWood =</span>
	<span class="marker" id="mapping-711"></span><span class="token add" data-title="contract_body/comment">// 		_calculateMinedBalance(_landTokenId, _resourceTokens[1], now) +</span>
	<span class="marker" id="mapping-712"></span><span class="token add" data-title="contract_body/comment">// 			land2ResourceMineState[_landTokenId].mintedBalance[</span>
	<span class="marker" id="mapping-713"></span><span class="token add" data-title="contract_body/comment">// 				_resourceTokens[1]</span>
	<span class="marker" id="mapping-714"></span><span class="token add" data-title="contract_body/comment">// 			];</span>
	<span class="marker" id="mapping-715"></span><span class="token add" data-title="contract_body/comment">// 	uint256 availableWater =</span>
	<span class="marker" id="mapping-716"></span><span class="token add" data-title="contract_body/comment">// 		_calculateMinedBalance(_landTokenId, _resourceTokens[2], now) +</span>
	<span class="marker" id="mapping-717"></span><span class="token add" data-title="contract_body/comment">// 			land2ResourceMineState[_landTokenId].mintedBalance[</span>
	<span class="marker" id="mapping-718"></span><span class="token add" data-title="contract_body/comment">// 				_resourceTokens[2]</span>
	<span class="marker" id="mapping-719"></span><span class="token add" data-title="contract_body/comment">// 			];</span>
	<span class="marker" id="mapping-720"></span><span class="token add" data-title="contract_body/comment">// 	uint256 availableFire =</span>
	<span class="marker" id="mapping-721"></span><span class="token add" data-title="contract_body/comment">// 		_calculateMinedBalance(_landTokenId, _resourceTokens[3], now) +</span>
	<span class="marker" id="mapping-722"></span><span class="token add" data-title="contract_body/comment">// 			land2ResourceMineState[_landTokenId].mintedBalance[</span>
	<span class="marker" id="mapping-723"></span><span class="token add" data-title="contract_body/comment">// 				_resourceTokens[3]</span>
	<span class="marker" id="mapping-724"></span><span class="token add" data-title="contract_body/comment">// 			];</span>
	<span class="marker" id="mapping-725"></span><span class="token add" data-title="contract_body/comment">// 	uint256 availableSoil =</span>
	<span class="marker" id="mapping-726"></span><span class="token add" data-title="contract_body/comment">// 		_calculateMinedBalance(_landTokenId, _resourceTokens[4], now) +</span>
	<span class="marker" id="mapping-727"></span><span class="token add" data-title="contract_body/comment">// 			land2ResourceMineState[_landTokenId].mintedBalance[</span>
	<span class="marker" id="mapping-728"></span><span class="token add" data-title="contract_body/comment">// 				_resourceTokens[4]</span>
	<span class="marker" id="mapping-729"></span><span class="token add" data-title="contract_body/comment">// 			];</span>

	<span class="marker" id="mapping-730"></span><span class="token add" data-title="contract_body/comment">// 	return (</span>
	<span class="marker" id="mapping-731"></span><span class="token add" data-title="contract_body/comment">// 		availableGold,</span>
	<span class="marker" id="mapping-732"></span><span class="token add" data-title="contract_body/comment">// 		availableWood,</span>
	<span class="marker" id="mapping-733"></span><span class="token add" data-title="contract_body/comment">// 		availableWater,</span>
	<span class="marker" id="mapping-734"></span><span class="token add" data-title="contract_body/comment">// 		availableFire,</span>
	<span class="marker" id="mapping-735"></span><span class="token add" data-title="contract_body/comment">// 		availableSoil</span>
	<span class="marker" id="mapping-736"></span><span class="token add" data-title="contract_body/comment">// 	);</span>
	<span class="marker" id="mapping-737"></span><span class="token add" data-title="contract_body/comment">// }</span>

	<span class="marker" id="mapping-738"></span><span class="token add" data-title="contract_body/comment">// V5 remove</span>
	<span class="marker" id="mapping-739"></span><span class="token add" data-title="contract_body/comment">// function mintedBalanceOnLand(uint256 _landTokenId, address _resourceToken) public view returns (uint256) {</span>
	<span class="marker" id="mapping-740"></span><span class="token add" data-title="contract_body/comment">//     return land2ResourceMineState[_landTokenId].mintedBalance[_resourceToken];</span>
	<span class="marker" id="mapping-741"></span><span class="token add" data-title="contract_body/comment">// }</span>

	<span class="marker" id="mapping-742"></span><span class="token add" data-title="contract_body/comment">// function landWorkingOn(uint256 _apostleTokenId) public view returns (uint256 landTokenId) {</span>
	<span class="marker" id="mapping-743"></span><span class="token add" data-title="contract_body/comment">//     landTokenId = miner2Index[_apostleTokenId].landTokenId;</span>
	<span class="marker" id="mapping-744"></span><span class="token add" data-title="contract_body/comment">// }</span>

	function _updateMinerStrength(uint256 _apostleTokenId, bool _isStop)
		internal
		returns (uint256, uint256)
	{
		// require that this apostle
		uint256 landTokenId = landWorkingOn(_apostleTokenId);
		require(landTokenId != 0, "this apostle is not mining.");

		address resource = miner2Index[_apostleTokenId].resource;

		address miner =
			IInterstellarEncoder(
				registry.addressOf(CONTRACT_INTERSTELLAR_ENCODER)
			)
				.getObjectAddress(_apostleTokenId);
		uint256 strength =
			IMinerObject(miner).strengthOf(
				_apostleTokenId,
				resource,
				landTokenId
			);

		mine(landTokenId);

		if (_isStop) {
			land2ResourceMineState[landTokenId].totalMinerStrength[
				resource
			] = land2ResourceMineState[landTokenId].totalMinerStrength[resource]
				.sub(strength);
		} else {
			land2ResourceMineState[landTokenId].totalMinerStrength[
				resource
			] += strength;
		}

		return (landTokenId, strength);
	}

	// when a mirrorToken or a pet has tied to apostle
	// we need to update status and remove this apostle from mining list first
	// open authority to PetBase
	// can only be called by PetBase
	function updateMinerStrengthWhenStop(uint256 _apostleTokenId) public auth {
		uint256 landTokenId;
		uint256 strength;
		(landTokenId, strength) = _updateMinerStrength(_apostleTokenId, true);
		// _isStop == true - minus strength
		// _isStop == false - add strength
		emit UpdateMiningStrengthWhenStop(
			_apostleTokenId,
			landTokenId,
			strength
		);
	}

	function updateMinerStrengthWhenStart(uint256 _apostleTokenId) public auth {
		uint256 landTokenId;
		uint256 strength;
		(landTokenId, strength) = _updateMinerStrength(_apostleTokenId, false);
		// _isStop == true - minus strength
		// _isStop == false - add strength
		emit UpdateMiningStrengthWhenStart(
			_apostleTokenId,
			landTokenId,
			strength
		);
	}

	<span class="marker" id="mapping-745"></span><span class="token add" data-title="contract_body/comment">// V5 add</span>
	<span class="marker" id="mapping-746"></span><span class="token mv" id="move-dst-143" data-title="contract_body/function_definition">function <span class="marker" id="mapping-747"></span><span class="token upd" id="move-dst-144" data-title="function_definition/identifier"><span class="cupd">get</span>L<span class="cupd">a</span>nd<span class="cupd">Min</span>edBala<span class="cupd">n</span>ce</span>(<span class="marker" id="mapping-748"></span><span class="token add" data-title="primitive_type/uint256">uint256</span> <span class="marker" id="mapping-749"></span><span class="token upd" id="move-dst-145" data-title="parameter/identifier"><span class="cupd">_land</span><span class="cupd">Id</span></span>, address <span class="marker" id="mapping-750"></span><span class="token upd" id="move-dst-146" data-title="parameter/identifier"><span class="cupd">_resource</span></span>)
		public
		view
		returns (uint256)
	{
		return land2ResourceMineState[<span class="marker" id="mapping-751"></span><span class="token upd" id="move-dst-147" data-title="array_access/identifier"><span class="cupd">_land</span><span class="cupd">Id</span></span>].<span class="marker" id="mapping-752"></span><span class="token upd" id="move-dst-148" data-title="member_expression/identifier">min<span class="cupd">t</span>edB<span class="cupd">al</span>a<span class="cupd">n</span>ce</span>[<span class="marker" id="mapping-753"></span><span class="token upd" id="move-dst-149" data-title="array_access/identifier"><span class="cupd">_resource</span></span>];
	}</span>

	<span class="marker" id="mapping-754"></span><span class="token add" data-title="contract_body/function_definition">function getItemMinedBalance(
		<span class="marker" id="mapping-755"></span><span class="token add" data-title="function_definition/parameter">address _itemToken</span>,
		<span class="marker" id="mapping-756"></span><span class="token add" data-title="function_definition/parameter">uint256 _itemId</span>,
		<span class="marker" id="mapping-757"></span><span class="token add" data-title="function_definition/parameter">address _resource</span>
	) <span class="marker" id="mapping-758"></span><span class="token mv" id="move-dst-162" data-title="function_definition/visibility">public</span> <span class="marker" id="mapping-759"></span><span class="token mv" id="move-dst-163" data-title="function_definition/state_mutability">view</span> <span class="marker" id="mapping-760"></span><span class="token add" data-title="function_definition/return_type_definition">returns (uint256)</span> <span class="marker" id="mapping-761"></span><span class="token add" data-title="function_definition/function_body">{
		return itemMinedBalance[_itemToken][_itemId][_resource];
	}</span></span>

	<span class="marker" id="mapping-762"></span><span class="token add" data-title="contract_body/function_definition">function getLandMiningStrength(<span class="marker" id="mapping-763"></span><span class="token add" data-title="function_definition/parameter">uint256 _landId</span>, <span class="marker" id="mapping-764"></span><span class="token add" data-title="function_definition/parameter">address _resource</span>)
		<span class="marker" id="mapping-765"></span><span class="token mv" id="move-dst-142" data-title="function_definition/visibility">public</span>
		<span class="marker" id="mapping-766"></span><span class="token add" data-title="function_definition/state_mutability">view</span>
		<span class="marker" id="mapping-767"></span><span class="token add" data-title="function_definition/return_type_definition">returns (uint256)</span>
	<span class="marker" id="mapping-768"></span><span class="token add" data-title="function_definition/function_body">{
		return land2ResourceMineState[_landId].totalMinerStrength[_resource];
	}</span></span>

	<span class="marker" id="mapping-769"></span><span class="token add" data-title="contract_body/function_definition">function getBarMiningStrength(
		uint256 _landId,
		address _resource,
		uint256 _index
	) public view returns (uint256) {
		return
			getLandMiningStrength(_landId, _resource)
				.mul(getBarRate(_landId, _resource, _index))
				.div(RATE_PRECISION);
	}</span>

	<span class="marker" id="mapping-770"></span><span class="token add" data-title="contract_body/function_definition">function getBarRate(
		uint256 _landId,
		address _resource,
		uint256 _index
	) public view returns (uint256) {
		return land2BarRate[_landId][_resource][_index];
	}</span>

	<span class="marker" id="mapping-771"></span><span class="token add" data-title="contract_body/function_definition">function getBarsRate(<span class="marker" id="mapping-772"></span><span class="token add" data-title="function_definition/parameter">uint256 _landId</span>, <span class="marker" id="mapping-773"></span><span class="token add" data-title="function_definition/parameter">address _resource</span>)
		<span class="marker" id="mapping-774"></span><span class="token add" data-title="function_definition/visibility">public</span>
		<span class="marker" id="mapping-775"></span><span class="token add" data-title="function_definition/state_mutability">view</span>
		<span class="marker" id="mapping-776"></span><span class="token mv" id="move-dst-166" data-title="function_definition/return_type_definition">returns (uint256 <span class="marker" id="mapping-777"></span><span class="token upd" id="move-dst-167" data-title="parameter/identifier">b<span class="cupd">a</span>rsRate</span>)</span>
	<span class="marker" id="mapping-778"></span><span class="token add" data-title="function_definition/function_body">{
		for (uint256 i = 0; i &lt; maxAmount; i++) {
			barsRate = barsRate.add(getBarRate(_landId, _resource, i));
		}
	}</span></span>

	<span class="marker" id="mapping-779"></span><span class="token add" data-title="contract_body/function_definition">function getBarsMiningStrength(uint256 _landId, address _resource)
		public
		view
		returns (uint256 barsMiningStrength)
	{
		return
			getLandMiningStrength(_landId, _resource)
				.mul(getBarsRate(_landId, _resource))
				.div(RATE_PRECISION);
	}</span>

	<span class="marker" id="mapping-780"></span><span class="token add" data-title="contract_body/function_definition">function getTotalMiningStrength(uint256 _landId, address _resource)
		public
		view
		returns (uint256)
	{
		return
			getLandMiningStrength(_landId, _resource).add(
				getBarsMiningStrength(_landId, _resource)
			);
	}</span>

	<span class="marker" id="mapping-781"></span><span class="token add" data-title="contract_body/function_definition">function getMinerOnLand(
		uint256 _landId,
		address _resource,
		uint256 _index
	) public view returns (uint256) {
		return land2ResourceMineState[_landId].miners[_resource][_index];
	}</span>

	<span class="marker" id="mapping-782"></span><span class="token mv" id="move-dst-165" data-title="contract_body/function_definition">function landWorkingOn(uint256 _apostleTokenId)
		public
		view
		<span class="marker" id="mapping-783"></span><span class="token add" data-title="function_definition/return_type_definition">returns (uint256 landId)</span>
	{
		<span class="marker" id="mapping-784"></span><span class="token upd" id="move-dst-168" data-title="assignment_expression/identifier"><span class="cupd">land</span><span class="cupd">Id</span></span> = miner2Index[_apostleTokenId].landTokenId;
	}</span>

	<span class="marker" id="mapping-785"></span><span class="token add" data-title="contract_body/function_definition">function _getBarRateByIndex(
		uint256 _landId,
		address _resource,
		uint256 _index
	) internal view returns (uint256) {
		return enhanceStrengthRateByIndex(_resource, _landId, _index);
	}</span>

	<span class="marker" id="mapping-786"></span><span class="token add" data-title="contract_body/function_definition">function _startBarMining(
		uint256 _index,
		uint256 _landId,
		address _resource
	) internal {
		uint256 rate = _getBarRateByIndex(_landId, _resource, _index);
		land2BarRate[_landId][_resource][_index] = rate;
		emit StartBarMining(_index, _landId, _resource, rate);
	}</span>

	<span class="marker" id="mapping-787"></span><span class="token add" data-title="contract_body/function_definition">function _stopBarMinig(
		uint256 _index,
		uint256 _landId,
		address _resource
	) internal {
		delete land2BarRate[_landId][_resource][_index];
		emit StopBarMining(_index, _landId, _resource);
	}</span>

	<span class="marker" id="mapping-788"></span><span class="token add" data-title="contract_body/function_definition">function _claimItemResource(
		<span class="marker" id="mapping-789"></span><span class="token add" data-title="function_definition/parameter">address _itemToken</span>,
		<span class="marker" id="mapping-790"></span><span class="token add" data-title="function_definition/parameter">uint256 _itemId</span>,
		<span class="marker" id="mapping-791"></span><span class="token add" data-title="function_definition/parameter">address _resource</span>
	) <span class="marker" id="mapping-792"></span><span class="token add" data-title="function_definition/visibility">internal</span> <span class="marker" id="mapping-793"></span><span class="token add" data-title="function_definition/return_type_definition">returns (uint256)</span> <span class="marker" id="mapping-794"></span><span class="token add" data-title="function_definition/function_body">{
		<span class="marker" id="mapping-795"></span><span class="token add" data-title="function_body/variable_declaration_statement">uint256 balance = getItemMinedBalance(_itemToken, _itemId, _resource);</span>
		<span class="marker" id="mapping-796"></span><span class="token mv" id="move-dst-113" data-title="function_body/if_statement">if (<span class="marker" id="mapping-797"></span><span class="token add" data-title="binary_expression/identifier">balance</span> &gt; 0) {
			IMintableERC20(<span class="marker" id="mapping-798"></span><span class="token add" data-title="call_expression/call_argument">_resource</span>).mint(msg.sender, <span class="marker" id="mapping-799"></span><span class="token add" data-title="call_expression/call_argument">balance</span>);
			<span class="marker" id="mapping-800"></span><span class="token add" data-title="block_statement/expression_statement">itemMinedBalance[_itemToken][_itemId][_resource] = 0;</span>
			<span class="marker" id="mapping-801"></span><span class="token add" data-title="block_statement/return_statement">return balance;</span>
		} <span class="marker" id="mapping-802"></span><span class="token add" data-title="if_statement/else">else</span> <span class="marker" id="mapping-803"></span><span class="token add" data-title="if_statement/block_statement">{
			return 0;
		}</span></span>
	}</span></span>

	<span class="marker" id="mapping-804"></span><span class="token mv" id="move-dst-108" data-title="contract_body/function_definition">function <span class="marker" id="mapping-805"></span><span class="token upd" id="move-dst-109" data-title="function_definition/identifier"><span class="cupd">claim</span>Item<span class="cupd">Resource</span></span>(<span class="marker" id="mapping-806"></span><span class="token add" data-title="function_definition/parameter">address _itemToken</span><span class="marker" id="mapping-807"></span><span class="token add" data-title="function_definition/,">,</span> <span class="marker" id="mapping-808"></span><span class="token add" data-title="function_definition/parameter">uint256 _itemId</span>) public {
		<span class="marker" id="mapping-809"></span><span class="token add" data-title="function_body/variable_declaration_statement">(address staker, uint256 landId) = getLandIdByItem(_itemToken, _itemId);</span>
		<span class="marker" id="mapping-810"></span><span class="token add" data-title="function_body/if_statement">if (staker == address(0) &amp;&amp; landId == 0) {
			require(
				ERC721(_itemToken).ownerOf(_itemId) == msg.sender,
				"Land: ONLY_ITEM_ONWER"
			);
		} else {
			require(staker == msg.sender, "Land: ONLY_ITEM_STAKER");
			mine(landId);
		}</span>

		address gold = registry.addressOf(CONTRACT_GOLD_ERC20_TOKEN);
		address wood = registry.addressOf(CONTRACT_WOOD_ERC20_TOKEN);
		address water = registry.addressOf(CONTRACT_WATER_ERC20_TOKEN);
		address fire = registry.addressOf(CONTRACT_FIRE_ERC20_TOKEN);
		address soil = registry.addressOf(CONTRACT_SOIL_ERC20_TOKEN);
		<span class="marker" id="mapping-811"></span><span class="token add" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-812"></span><span class="token add" data-title="variable_declaration_statement/variable_declaration">uint256 goldBalance</span> = <span class="marker" id="mapping-813"></span><span class="token add" data-title="variable_declaration_statement/call_expression">_claimItemResource(<span class="marker" id="mapping-814"></span><span class="token add" data-title="call_expression/call_argument">_itemToken</span>, <span class="marker" id="mapping-815"></span><span class="token add" data-title="call_expression/call_argument">_itemId</span>, <span class="marker" id="mapping-816"></span><span class="token mv" id="move-dst-114" data-title="call_expression/call_argument">gold</span>)</span>;</span>
		<span class="marker" id="mapping-817"></span><span class="token add" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-818"></span><span class="token add" data-title="variable_declaration_statement/variable_declaration">uint256 woodBalance</span> = <span class="marker" id="mapping-819"></span><span class="token add" data-title="variable_declaration_statement/call_expression">_claimItemResource(<span class="marker" id="mapping-820"></span><span class="token add" data-title="call_expression/call_argument">_itemToken</span>, <span class="marker" id="mapping-821"></span><span class="token add" data-title="call_expression/call_argument">_itemId</span>, <span class="marker" id="mapping-822"></span><span class="token mv" id="move-dst-117" data-title="call_expression/call_argument">wood</span>)</span>;</span>
		<span class="marker" id="mapping-823"></span><span class="token add" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-824"></span><span class="token add" data-title="variable_declaration_statement/variable_declaration">uint256 waterBalance</span> = <span class="marker" id="mapping-825"></span><span class="token add" data-title="variable_declaration_statement/call_expression">_claimItemResource(<span class="marker" id="mapping-826"></span><span class="token add" data-title="call_expression/call_argument">_itemToken</span>, <span class="marker" id="mapping-827"></span><span class="token add" data-title="call_expression/call_argument">_itemId</span>, <span class="marker" id="mapping-828"></span><span class="token mv" id="move-dst-121" data-title="call_expression/call_argument">water</span>)</span>;</span>
		<span class="marker" id="mapping-829"></span><span class="token add" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-830"></span><span class="token add" data-title="variable_declaration_statement/variable_declaration">uint256 fireBalance</span> = <span class="marker" id="mapping-831"></span><span class="token add" data-title="variable_declaration_statement/call_expression">_claimItemResource(<span class="marker" id="mapping-832"></span><span class="token add" data-title="call_expression/call_argument">_itemToken</span>, <span class="marker" id="mapping-833"></span><span class="token add" data-title="call_expression/call_argument">_itemId</span>, <span class="marker" id="mapping-834"></span><span class="token mv" id="move-dst-124" data-title="call_expression/call_argument">fire</span>)</span>;</span>
		<span class="marker" id="mapping-835"></span><span class="token add" data-title="function_body/variable_declaration_statement"><span class="marker" id="mapping-836"></span><span class="token add" data-title="variable_declaration_statement/variable_declaration">uint256 soilBalance</span> = <span class="marker" id="mapping-837"></span><span class="token add" data-title="variable_declaration_statement/call_expression">_claimItemResource(<span class="marker" id="mapping-838"></span><span class="token add" data-title="call_expression/call_argument">_itemToken</span>, <span class="marker" id="mapping-839"></span><span class="token add" data-title="call_expression/call_argument">_itemId</span>, <span class="marker" id="mapping-840"></span><span class="token mv" id="move-dst-126" data-title="call_expression/call_argument">soil</span>)</span>;</span>

		emit <span class="marker" id="mapping-841"></span><span class="token upd" id="move-dst-129" data-title="emit_statement/identifier">Item<span class="cupd">ResourceClaimed</span></span>(
			msg.sender,
			<span class="marker" id="mapping-842"></span><span class="token upd" id="move-dst-130" data-title="call_argument/identifier"><span class="cupd">_</span>item<span class="cupd">Token</span></span>,
			<span class="marker" id="mapping-843"></span><span class="token add" data-title="emit_statement/call_argument">_itemId</span>,
			<span class="marker" id="mapping-844"></span><span class="token mv" id="move-dst-131" data-title="emit_statement/call_argument">goldBalance</span>,
			<span class="marker" id="mapping-845"></span><span class="token mv" id="move-dst-132" data-title="emit_statement/call_argument">woodBalance</span>,
			<span class="marker" id="mapping-846"></span><span class="token mv" id="move-dst-133" data-title="emit_statement/call_argument">waterBalance</span>,
			<span class="marker" id="mapping-847"></span><span class="token mv" id="move-dst-134" data-title="emit_statement/call_argument">fireBalance</span><span class="marker" id="mapping-848"></span><span class="token add" data-title="emit_statement/,">,</span>
			soilBalance
		);
	}</span>

	<span class="marker" id="mapping-849"></span><span class="token add" data-title="contract_body/function_definition">function _claimLandResource(<span class="marker" id="mapping-850"></span><span class="token add" data-title="function_definition/parameter">uint256 _landId</span>, <span class="marker" id="mapping-851"></span><span class="token add" data-title="function_definition/parameter">address _resource</span>)
		<span class="marker" id="mapping-852"></span><span class="token add" data-title="function_definition/visibility">internal</span>
		<span class="marker" id="mapping-853"></span><span class="token add" data-title="function_definition/return_type_definition">returns (uint256)</span>
	<span class="marker" id="mapping-854"></span><span class="token add" data-title="function_definition/function_body">{
		<span class="marker" id="mapping-855"></span><span class="token add" data-title="function_body/variable_declaration_statement">uint256 balance = getLandMinedBalance(_landId, _resource);</span>
		<span class="marker" id="mapping-856"></span><span class="token mv" id="move-dst-116" data-title="function_body/if_statement">if (<span class="marker" id="mapping-857"></span><span class="token add" data-title="binary_expression/identifier">balance</span> &gt; 0) {
			IMintableERC20(<span class="marker" id="mapping-858"></span><span class="token add" data-title="call_expression/call_argument">_resource</span>).mint(msg.sender, <span class="marker" id="mapping-859"></span><span class="token add" data-title="call_expression/call_argument">balance</span>);
			land2ResourceMineState[<span class="marker" id="mapping-860"></span><span class="token upd" id="move-dst-119" data-title="array_access/identifier"><span class="cupd">_land</span><span class="cupd">Id</span></span>].mintedBalance[<span class="marker" id="mapping-861"></span><span class="token upd" id="move-dst-120" data-title="array_access/identifier">_resource</span>] = 0;
			<span class="marker" id="mapping-862"></span><span class="token add" data-title="block_statement/return_statement">return balance;</span>
		} <span class="marker" id="mapping-863"></span><span class="token add" data-title="if_statement/else">else</span> <span class="marker" id="mapping-864"></span><span class="token add" data-title="if_statement/block_statement">{
			return 0;
		}</span></span>
	}</span></span>

	<span class="marker" id="mapping-865"></span><span class="token add" data-title="contract_body/function_definition">function claimLandResource(<span class="marker" id="mapping-866"></span><span class="token add" data-title="function_definition/parameter">uint256 _landId</span>) <span class="marker" id="mapping-867"></span><span class="token mv" id="move-dst-47" data-title="function_definition/visibility">public</span> <span class="marker" id="mapping-868"></span><span class="token add" data-title="function_definition/function_body">{
		<span class="marker" id="mapping-869"></span><span class="token add" data-title="function_body/expression_statement"><span class="marker" id="mapping-870"></span><span class="token add" data-title="expression_statement/call_expression">require(
			<span class="marker" id="mapping-871"></span><span class="token add" data-title="call_expression/call_argument">msg.sender ==
				ERC721(registry.addressOf(CONTRACT_OBJECT_OWNERSHIP)).ownerOf(
					_landId
				)</span>,
			<span class="marker" id="mapping-872"></span><span class="token add" data-title="call_expression/call_argument"><span class="marker" id="mapping-873"></span><span class="token mv" id="move-dst-48" data-title="call_argument/string_literal">"Land: ONLY_LANDER"</span></span>
		)</span>;</span>

		<span class="marker" id="mapping-874"></span><span class="token add" data-title="function_body/variable_declaration_statement">address gold = registry.addressOf(CONTRACT_GOLD_ERC20_TOKEN);</span>
		<span class="marker" id="mapping-875"></span><span class="token add" data-title="function_body/variable_declaration_statement">address wood = registry.addressOf(CONTRACT_WOOD_ERC20_TOKEN);</span>
		<span class="marker" id="mapping-876"></span><span class="token add" data-title="function_body/variable_declaration_statement">address water = registry.addressOf(CONTRACT_WATER_ERC20_TOKEN);</span>
		<span class="marker" id="mapping-877"></span><span class="token add" data-title="function_body/variable_declaration_statement">address fire = registry.addressOf(CONTRACT_FIRE_ERC20_TOKEN);</span>
		<span class="marker" id="mapping-878"></span><span class="token add" data-title="function_body/variable_declaration_statement">address soil = registry.addressOf(CONTRACT_SOIL_ERC20_TOKEN);</span>
		<span class="marker" id="mapping-879"></span><span class="token mv" id="move-dst-111" data-title="function_body/expression_statement">_mineAllResource(<span class="marker" id="mapping-880"></span><span class="token add" data-title="call_expression/call_argument">_landId</span>, gold, wood, water, fire, soil);</span>

		<span class="marker" id="mapping-881"></span><span class="token add" data-title="function_body/variable_declaration_statement">uint256 goldBalance = _claimLandResource(_landId, gold);</span>
		<span class="marker" id="mapping-882"></span><span class="token add" data-title="function_body/variable_declaration_statement">uint256 woodBalance = _claimLandResource(_landId, wood);</span>
		<span class="marker" id="mapping-883"></span><span class="token add" data-title="function_body/variable_declaration_statement">uint256 waterBalance = _claimLandResource(_landId, water);</span>
		<span class="marker" id="mapping-884"></span><span class="token add" data-title="function_body/variable_declaration_statement">uint256 fireBalance = _claimLandResource(_landId, fire);</span>
		<span class="marker" id="mapping-885"></span><span class="token add" data-title="function_body/variable_declaration_statement">uint256 soilBalance = _claimLandResource(_landId, soil);</span>

		<span class="marker" id="mapping-886"></span><span class="token add" data-title="function_body/emit_statement">emit LandResourceClaimed(
			<span class="marker" id="mapping-887"></span><span class="token mv" id="move-dst-122" data-title="emit_statement/call_argument">msg.sender</span>,
			<span class="marker" id="mapping-888"></span><span class="token add" data-title="emit_statement/call_argument">_landId</span>,
			<span class="marker" id="mapping-889"></span><span class="token mv" id="move-dst-115" data-title="emit_statement/call_argument">goldBalance</span>,
			<span class="marker" id="mapping-890"></span><span class="token mv" id="move-dst-118" data-title="emit_statement/call_argument">woodBalance</span>,
			<span class="marker" id="mapping-891"></span><span class="token mv" id="move-dst-123" data-title="emit_statement/call_argument">waterBalance</span>,
			<span class="marker" id="mapping-892"></span><span class="token mv" id="move-dst-125" data-title="emit_statement/call_argument">fireBalance</span>,
			<span class="marker" id="mapping-893"></span><span class="token mv" id="move-dst-128" data-title="emit_statement/call_argument">soilBalance</span>
		);</span>
	}</span></span>

	<span class="marker" id="mapping-894"></span><span class="token add" data-title="contract_body/function_definition">function _calculateResources(
		address _itemToken,
		uint256 _itemId,
		uint256 _landId,
		address _resource,
		uint256 _minedBalance
	) internal view returns (uint256 landBalance, uint256 barResource) {
		uint256 barsRate = getBarsRate(_landId, _resource);
		// V5 yeild distribution
		landBalance = _minedBalance.mul(RATE_PRECISION).div(
			barsRate.add(RATE_PRECISION)
		);
		if (barsRate &gt; 0) {
			uint256 barsBalance = _minedBalance.sub(landBalance);
			for (uint256 i = 0; i &lt; maxAmount; i++) {
				(address itemToken, uint256 itemId, address resource) = getBarItem(_landId, i);
				if (_itemId == itemId &amp;&amp; _itemToken == itemToken &amp;&amp; _resource == resource) {
					uint256 barBalance =
						barsBalance.mul(getBarRate(_landId, _resource, i)).div(
							barsRate
						);
					(barBalance, landBalance) = _payFee(barBalance, landBalance);
					barResource = barResource.add(barBalance);
				}
			}
		}
	}</span>

	<span class="marker" id="mapping-895"></span><span class="token add" data-title="contract_body/function_definition">function availableLandResources(
		<span class="marker" id="mapping-896"></span><span class="token add" data-title="function_definition/parameter">uint256 _landId</span>,
		<span class="marker" id="mapping-897"></span><span class="token mv" id="move-dst-151" data-title="function_definition/parameter">address[] <span class="marker" id="mapping-898"></span><span class="token add" data-title="parameter/memory">memory</span> <span class="marker" id="mapping-899"></span><span class="token upd" id="move-dst-152" data-title="parameter/identifier"><span class="cupd">_resource</span>s</span></span>
	) <span class="marker" id="mapping-900"></span><span class="token add" data-title="function_definition/visibility">public</span> <span class="marker" id="mapping-901"></span><span class="token add" data-title="function_definition/state_mutability">view</span> <span class="marker" id="mapping-902"></span><span class="token add" data-title="function_definition/return_type_definition">returns (uint256[] memory)</span> <span class="marker" id="mapping-903"></span><span class="token add" data-title="function_definition/function_body">{
		<span class="marker" id="mapping-904"></span><span class="token add" data-title="function_body/variable_declaration_statement">uint256[] memory availables = new uint256[](_resources.length);</span>
		<span class="marker" id="mapping-905"></span><span class="token add" data-title="function_body/for_statement">for (<span class="marker" id="mapping-906"></span><span class="token add" data-title="for_statement/variable_declaration_statement">uint256 i = 0;</span> <span class="marker" id="mapping-907"></span><span class="token add" data-title="for_statement/expression_statement">i &lt; _resources.length;</span> <span class="marker" id="mapping-908"></span><span class="token add" data-title="for_statement/update_expression">i++</span>) <span class="marker" id="mapping-909"></span><span class="token add" data-title="for_statement/block_statement">{
			<span class="marker" id="mapping-910"></span><span class="token add" data-title="block_statement/if_statement">if (<span class="marker" id="mapping-911"></span><span class="token add" data-title="if_statement/binary_expression">getLandMiningStrength(_landId, _resources[i]) &gt; 0</span>) <span class="marker" id="mapping-912"></span><span class="token add" data-title="if_statement/block_statement">{
				<span class="marker" id="mapping-913"></span><span class="token add" data-title="block_statement/variable_declaration_statement"><span class="marker" id="mapping-914"></span><span class="token add" data-title="variable_declaration_statement/variable_declaration">uint256 mined</span> = <span class="marker" id="mapping-915"></span><span class="token add" data-title="variable_declaration_statement/call_expression">_calculateMinedBalance(<span class="marker" id="mapping-916"></span><span class="token add" data-title="call_expression/call_argument">_landId</span>, <span class="marker" id="mapping-917"></span><span class="token add" data-title="call_expression/call_argument">_resources[i]</span>, <span class="marker" id="mapping-918"></span><span class="token mv" id="move-dst-158" data-title="call_expression/call_argument">now</span>)</span>;</span>
				<span class="marker" id="mapping-919"></span><span class="token add" data-title="block_statement/variable_declaration_statement">(uint256 available, ) =
					_calculateResources(
						address(0),
						0,
						_landId,
						_resources[i],
						mined
					);</span>
				<span class="marker" id="mapping-920"></span><span class="token add" data-title="block_statement/expression_statement">availables[i] = available.add(
					getLandMinedBalance(_landId, _resources[i])
				);</span>
			}</span></span>
		}</span></span>
		<span class="marker" id="mapping-921"></span><span class="token add" data-title="function_body/return_statement">return availables;</span>
	}</span></span>

	<span class="marker" id="mapping-922"></span><span class="token add" data-title="contract_body/function_definition">function availableItemResources(
		<span class="marker" id="mapping-923"></span><span class="token add" data-title="function_definition/parameter">address _itemToken</span>,
		<span class="marker" id="mapping-924"></span><span class="token add" data-title="function_definition/parameter">uint256 _itemId</span>,
		<span class="marker" id="mapping-925"></span><span class="token add" data-title="function_definition/parameter">address[] memory _resources</span>
	) <span class="marker" id="mapping-926"></span><span class="token add" data-title="function_definition/visibility">public</span> <span class="marker" id="mapping-927"></span><span class="token add" data-title="function_definition/state_mutability">view</span> <span class="marker" id="mapping-928"></span><span class="token add" data-title="function_definition/return_type_definition">returns (uint256[] memory)</span> <span class="marker" id="mapping-929"></span><span class="token add" data-title="function_definition/function_body">{
		<span class="marker" id="mapping-930"></span><span class="token add" data-title="function_body/variable_declaration_statement">uint256[] memory availables = new uint256[](_resources.length);</span>
		<span class="marker" id="mapping-931"></span><span class="token add" data-title="function_body/for_statement">for (<span class="marker" id="mapping-932"></span><span class="token add" data-title="for_statement/variable_declaration_statement">uint256 i = 0;</span> <span class="marker" id="mapping-933"></span><span class="token add" data-title="for_statement/expression_statement">i &lt; _resources.length;</span> <span class="marker" id="mapping-934"></span><span class="token add" data-title="for_statement/update_expression">i++</span>) <span class="marker" id="mapping-935"></span><span class="token add" data-title="for_statement/block_statement">{
			<span class="marker" id="mapping-936"></span><span class="token add" data-title="block_statement/variable_declaration_statement">(address staker, uint256 landId) =
				getLandIdByItem(_itemToken, _itemId);</span>
			<span class="marker" id="mapping-937"></span><span class="token add" data-title="block_statement/if_statement">if (<span class="marker" id="mapping-938"></span><span class="token add" data-title="if_statement/binary_expression">getLandMiningStrength(landId, _resources[i]) &gt; 0</span>) <span class="marker" id="mapping-939"></span><span class="token add" data-title="if_statement/block_statement">{
				<span class="marker" id="mapping-940"></span><span class="token add" data-title="block_statement/variable_declaration_statement">uint256 available = 0;</span>
				<span class="marker" id="mapping-941"></span><span class="token add" data-title="block_statement/if_statement">if (<span class="marker" id="mapping-942"></span><span class="token add" data-title="if_statement/binary_expression">staker != address(0) &amp;&amp; landId != 0</span>) <span class="marker" id="mapping-943"></span><span class="token add" data-title="if_statement/block_statement">{
					<span class="marker" id="mapping-944"></span><span class="token add" data-title="block_statement/variable_declaration_statement"><span class="marker" id="mapping-945"></span><span class="token add" data-title="variable_declaration_statement/variable_declaration">uint256 mined</span> =
						<span class="marker" id="mapping-946"></span><span class="token add" data-title="variable_declaration_statement/call_expression">_calculateMinedBalance(<span class="marker" id="mapping-947"></span><span class="token add" data-title="call_expression/call_argument">landId</span>, <span class="marker" id="mapping-948"></span><span class="token add" data-title="call_expression/call_argument">_resources[i]</span>, <span class="marker" id="mapping-949"></span><span class="token mv" id="move-dst-159" data-title="call_expression/call_argument">now</span>)</span>;</span>
					<span class="marker" id="mapping-950"></span><span class="token add" data-title="block_statement/variable_declaration_statement">(, uint256 availableItem) =
						_calculateResources(
							_itemToken,
							_itemId,
							landId,
							_resources[i],
							mined
						);</span>
					<span class="marker" id="mapping-951"></span><span class="token add" data-title="block_statement/expression_statement">available = available.add(availableItem);</span>
				}</span></span>
				<span class="marker" id="mapping-952"></span><span class="token add" data-title="block_statement/expression_statement">available = available.add(
					getItemMinedBalance(_itemToken, _itemId, _resources[i])
				);</span>
				<span class="marker" id="mapping-953"></span><span class="token add" data-title="block_statement/expression_statement">availables[i] = available;</span>
			}</span></span>
		}</span></span>
		<span class="marker" id="mapping-954"></span><span class="token add" data-title="function_body/return_statement">return availables;</span>
	}</span></span>

	<span class="marker" id="mapping-955"></span><span class="token add" data-title="contract_body/function_definition">function isNotProtect(address _token, uint256 _id)
		public
		view
		returns (bool)
	{
		return protectPeriod[_token][_id] &lt; now;
	}</span>

	<span class="marker" id="mapping-956"></span><span class="token add" data-title="contract_body/function_definition">function getBarItem(<span class="marker" id="mapping-957"></span><span class="token add" data-title="function_definition/parameter">uint256 _tokenId</span>, <span class="marker" id="mapping-958"></span><span class="token add" data-title="function_definition/parameter">uint256 _index</span>)
		<span class="marker" id="mapping-959"></span><span class="token add" data-title="function_definition/visibility">public</span>
		<span class="marker" id="mapping-960"></span><span class="token add" data-title="function_definition/state_mutability">view</span>
		<span class="marker" id="mapping-961"></span><span class="token add" data-title="function_definition/return_type_definition">returns (
			<span class="marker" id="mapping-962"></span><span class="token add" data-title="return_type_definition/parameter">address</span>,
			<span class="marker" id="mapping-963"></span><span class="token mv" id="move-dst-156" data-title="return_type_definition/parameter">uint256</span>,
			<span class="marker" id="mapping-964"></span><span class="token add" data-title="return_type_definition/parameter">address</span>
		)</span>
	<span class="marker" id="mapping-965"></span><span class="token add" data-title="function_definition/function_body">{
		require(_index &lt; maxAmount, "Furnace: INDEX_FORBIDDEN.");
		return (
			landId2Bars[_tokenId][_index].token,
			landId2Bars[_tokenId][_index].id,
			landId2Bars[_tokenId][_index].resource
		);
	}</span></span>

	<span class="marker" id="mapping-966"></span><span class="token add" data-title="contract_body/function_definition">function getLandIdByItem(<span class="marker" id="mapping-967"></span><span class="token add" data-title="function_definition/parameter">address _item</span>, <span class="marker" id="mapping-968"></span><span class="token add" data-title="function_definition/parameter">uint256 _itemId</span>)
		<span class="marker" id="mapping-969"></span><span class="token mv" id="move-dst-153" data-title="function_definition/visibility">public</span>
		<span class="marker" id="mapping-970"></span><span class="token add" data-title="function_definition/state_mutability">view</span>
		<span class="marker" id="mapping-971"></span><span class="token add" data-title="function_definition/return_type_definition">returns (<span class="marker" id="mapping-972"></span><span class="token add" data-title="return_type_definition/parameter">address</span>, <span class="marker" id="mapping-973"></span><span class="token mv" id="move-dst-157" data-title="return_type_definition/parameter">uint256</span>)</span>
	<span class="marker" id="mapping-974"></span><span class="token add" data-title="function_definition/function_body">{
		return (
			itemId2Status[_item][_itemId].staker,
			itemId2Status[_item][_itemId].landTokenId
		);
	}</span></span>

	<span class="marker" id="mapping-975"></span><span class="token add" data-title="contract_body/comment">/**
        @dev Equip function, A NFT can equip to EVO Bar (LandBar or ApostleBar).
        @param _tokenId  Token Id which to be quiped.
        @param _resource Which resouce appply to.
        @param _index    Index of the Bar.
        @param _token    Token address which to quip.
        @param _id       Token Id which to quip.
    */</span>
	<span class="marker" id="mapping-976"></span><span class="token add" data-title="contract_body/function_definition">function equip(
		uint256 _tokenId,
		address _resource,
		uint256 _index,
		address _token,
		uint256 _id
	) public {
		_equip(_tokenId, _resource, _index, _token, _id);
	}</span>

	<span class="marker" id="mapping-977"></span><span class="token add" data-title="contract_body/comment">/// equip rules:</span>
	<span class="marker" id="mapping-978"></span><span class="token add" data-title="contract_body/comment">/// 1. land owner could replace item which is not in protected period.</span>
	<span class="marker" id="mapping-979"></span><span class="token add" data-title="contract_body/comment">/// 2. all user could replace low-class items with high-class item. </span>
	<span class="marker" id="mapping-980"></span><span class="token add" data-title="contract_body/comment">///    if the classes is the same, high-grade can replace low-grade items.</span>
	<span class="marker" id="mapping-981"></span><span class="token add" data-title="contract_body/function_definition">function _equip(
		<span class="marker" id="mapping-982"></span><span class="token add" data-title="function_definition/parameter">uint256 _tokenId</span>,
		<span class="marker" id="mapping-983"></span><span class="token add" data-title="function_definition/parameter">address _resource</span>,
		<span class="marker" id="mapping-984"></span><span class="token add" data-title="function_definition/parameter">uint256 _index</span>,
		<span class="marker" id="mapping-985"></span><span class="token add" data-title="function_definition/parameter">address _token</span>,
		<span class="marker" id="mapping-986"></span><span class="token add" data-title="function_definition/parameter">uint256 _id</span>
	) <span class="marker" id="mapping-987"></span><span class="token add" data-title="function_definition/visibility">internal</span> <span class="marker" id="mapping-988"></span><span class="token add" data-title="function_definition/function_body">{
		<span class="marker" id="mapping-989"></span><span class="token add" data-title="function_body/expression_statement">beforeEquip(_tokenId, _resource);</span>
		<span class="marker" id="mapping-990"></span><span class="token add" data-title="function_body/variable_declaration_statement">IMetaDataTeller teller =
			IMetaDataTeller(registry.addressOf(CONTRACT_METADATA_TELLER));</span>
		<span class="marker" id="mapping-991"></span><span class="token add" data-title="function_body/variable_declaration_statement">uint256 resourceId =
			ILandBase(registry.addressOf(CONTRACT_LAND_BASE))
				.resourceToken2RateAttrId(_resource);</span>
		<span class="marker" id="mapping-992"></span><span class="token add" data-title="function_body/expression_statement"><span class="marker" id="mapping-993"></span><span class="token add" data-title="expression_statement/call_expression">require(<span class="marker" id="mapping-994"></span><span class="token add" data-title="call_expression/call_argument">resourceId &gt; 0 &amp;&amp; resourceId &lt; 6</span>, <span class="marker" id="mapping-995"></span><span class="token add" data-title="call_expression/call_argument"><span class="marker" id="mapping-996"></span><span class="token mv" id="move-dst-39" data-title="call_argument/string_literal">"Furnace: INVALID_RESOURCE"</span></span>)</span>;</span>
		<span class="marker" id="mapping-997"></span><span class="token add" data-title="function_body/expression_statement"><span class="marker" id="mapping-998"></span><span class="token add" data-title="expression_statement/call_expression">require(
			<span class="marker" id="mapping-999"></span><span class="token add" data-title="call_expression/call_argument">IInterstellarEncoder(
				registry.addressOf(CONTRACT_INTERSTELLAR_ENCODER)
			)
				.getObjectClass(_tokenId) == 1</span>,
			<span class="marker" id="mapping-1000"></span><span class="token add" data-title="call_expression/call_argument"><span class="marker" id="mapping-1001"></span><span class="token mv" id="move-dst-36" data-title="call_argument/string_literal">"Funace: ONLY_LAND"</span></span>
		)</span>;</span>
		<span class="marker" id="mapping-1002"></span><span class="token add" data-title="function_body/variable_declaration_statement">(uint16 objClassExt, uint16 class, uint16 grade) =
			teller.getMetaData(_token, _id);</span>
		<span class="marker" id="mapping-1003"></span><span class="token add" data-title="function_body/expression_statement"><span class="marker" id="mapping-1004"></span><span class="token add" data-title="expression_statement/call_expression">require(<span class="marker" id="mapping-1005"></span><span class="token add" data-title="call_expression/call_argument">objClassExt &gt; 0</span>, <span class="marker" id="mapping-1006"></span><span class="token add" data-title="call_expression/call_argument"><span class="marker" id="mapping-1007"></span><span class="token mv" id="move-dst-33" data-title="call_argument/string_literal">"Furnace: PERMISSION"</span></span>)</span>;</span>
		<span class="marker" id="mapping-1008"></span><span class="token add" data-title="function_body/expression_statement"><span class="marker" id="mapping-1009"></span><span class="token add" data-title="expression_statement/call_expression">require(<span class="marker" id="mapping-1010"></span><span class="token add" data-title="call_expression/call_argument">_index &lt; maxAmount</span>, <span class="marker" id="mapping-1011"></span><span class="token add" data-title="call_expression/call_argument"><span class="marker" id="mapping-1012"></span><span class="token mv" id="move-dst-23" data-title="call_argument/string_literal">"Furnace: INDEX_FORBIDDEN"</span></span>)</span>;</span>
		<span class="marker" id="mapping-1013"></span><span class="token add" data-title="function_body/variable_declaration_statement">Bar storage bar = landId2Bars[_tokenId][_index];</span>
		<span class="marker" id="mapping-1014"></span><span class="token add" data-title="function_body/if_statement">if (bar.token != address(0)) {
			require(isNotProtect(bar.token, bar.id), "Furnace: PROTECT_PERIOD");
			(, uint16 originClass, uint16 originGrade) =
				teller.getMetaData(bar.token, bar.id);
			require(
				class &gt; originClass ||
					(class == originClass &amp;&amp; grade &gt; originGrade) ||
					ERC721(registry.addressOf(CONTRACT_OBJECT_OWNERSHIP))
						.ownerOf(_tokenId) ==
					msg.sender,
				"Furnace: FORBIDDEN"
			);
			//TODO:: safe transfer
			ERC721(bar.token).transferFrom(address(this), bar.staker, bar.id);
			emit Divest(
				_tokenId,
				bar.resource,
				_index,
				bar.staker,
				bar.token,
				bar.id
			);
		}</span>
		<span class="marker" id="mapping-1015"></span><span class="token add" data-title="function_body/expression_statement"><span class="marker" id="mapping-1016"></span><span class="token add" data-title="expression_statement/call_expression"><span class="marker" id="mapping-1017"></span><span class="token add" data-title="call_expression/member_expression">ERC721(_token).transferFrom</span>(<span class="marker" id="mapping-1018"></span><span class="token mv" id="move-dst-127" data-title="call_expression/call_argument">msg.sender</span>, <span class="marker" id="mapping-1019"></span><span class="token add" data-title="call_expression/call_argument">address(this)</span>, <span class="marker" id="mapping-1020"></span><span class="token add" data-title="call_expression/call_argument">_id</span>)</span>;</span>
		<span class="marker" id="mapping-1021"></span><span class="token add" data-title="function_body/expression_statement">bar.staker = msg.sender;</span>
		<span class="marker" id="mapping-1022"></span><span class="token add" data-title="function_body/expression_statement">bar.token = _token;</span>
		<span class="marker" id="mapping-1023"></span><span class="token add" data-title="function_body/expression_statement">bar.id = _id;</span>
		<span class="marker" id="mapping-1024"></span><span class="token add" data-title="function_body/expression_statement">bar.resource = _resource;</span>
		<span class="marker" id="mapping-1025"></span><span class="token add" data-title="function_body/expression_statement">itemId2Status[bar.token][bar.id] = Status({
			staker: bar.staker,
			landTokenId: _tokenId,
			index: _index
		});</span>
		<span class="marker" id="mapping-1026"></span><span class="token add" data-title="function_body/if_statement">if (<span class="marker" id="mapping-1027"></span><span class="token add" data-title="if_statement/call_expression">isNotProtect(bar.token, bar.id)</span>) <span class="marker" id="mapping-1028"></span><span class="token add" data-title="if_statement/block_statement">{
			<span class="marker" id="mapping-1029"></span><span class="token add" data-title="block_statement/expression_statement"><span class="marker" id="mapping-1030"></span><span class="token add" data-title="expression_statement/assignment_expression"><span class="marker" id="mapping-1031"></span><span class="token add" data-title="assignment_expression/array_access">protectPeriod[bar.token][bar.id]</span> = <span class="marker" id="mapping-1032"></span><span class="token add" data-title="assignment_expression/call_expression"><span class="marker" id="mapping-1033"></span><span class="token add" data-title="call_expression/member_expression">_calculateProtectPeriod(class).add</span>(<span class="marker" id="mapping-1034"></span><span class="token mv" id="move-dst-104" data-title="call_expression/call_argument">now</span>)</span></span>;</span>
		}</span></span>
		<span class="marker" id="mapping-1035"></span><span class="token add" data-title="function_body/expression_statement">afterEquiped(_index, _tokenId, _resource);</span>
		<span class="marker" id="mapping-1036"></span><span class="token add" data-title="function_body/emit_statement">emit Equip(_tokenId, _resource, _index, bar.staker, bar.token, bar.id);</span>
	}</span></span>

	<span class="marker" id="mapping-1037"></span><span class="token add" data-title="contract_body/function_definition">function _calculateProtectPeriod(
		uint16 _class
	) internal view returns (uint256) {
		uint256 baseProtectPeriod =
			registry.uintOf(UINT_ITEMBAR_PROTECT_PERIOD);
		return baseProtectPeriod.add(uint256(_class).mul(baseProtectPeriod));
	}</span>

	<span class="marker" id="mapping-1038"></span><span class="token add" data-title="contract_body/function_definition">function beforeEquip(<span class="marker" id="mapping-1039"></span><span class="token mv" id="move-dst-161" data-title="function_definition/parameter">uint256 _landTokenId</span>, <span class="marker" id="mapping-1040"></span><span class="token add" data-title="function_definition/parameter">address _resource</span>) <span class="marker" id="mapping-1041"></span><span class="token mv" id="move-dst-105" data-title="function_definition/visibility">internal</span> <span class="marker" id="mapping-1042"></span><span class="token add" data-title="function_definition/function_body">{
		<span class="marker" id="mapping-1043"></span><span class="token add" data-title="function_body/if_statement">if (<span class="marker" id="mapping-1044"></span><span class="token add" data-title="if_statement/binary_expression"><span class="marker" id="mapping-1045"></span><span class="token add" data-title="binary_expression/call_expression">getLandMiningStrength(<span class="marker" id="mapping-1046"></span><span class="token mv" id="move-dst-106" data-title="call_expression/call_argument">_landTokenId</span>, <span class="marker" id="mapping-1047"></span><span class="token add" data-title="call_expression/call_argument">_resource</span>)</span> &gt; 0</span>) <span class="marker" id="mapping-1048"></span><span class="token add" data-title="if_statement/block_statement">{
			mine(_landTokenId);
		}</span></span>
	}</span></span>

	<span class="marker" id="mapping-1049"></span><span class="token add" data-title="contract_body/function_definition">function afterEquiped(
		<span class="marker" id="mapping-1050"></span><span class="token add" data-title="function_definition/parameter">uint256 _index</span>,
		<span class="marker" id="mapping-1051"></span><span class="token mv" id="move-dst-150" data-title="function_definition/parameter">uint256 _landTokenId</span>,
		<span class="marker" id="mapping-1052"></span><span class="token add" data-title="function_definition/parameter">address _resource</span>
	) <span class="marker" id="mapping-1053"></span><span class="token add" data-title="function_definition/visibility">internal</span> <span class="marker" id="mapping-1054"></span><span class="token add" data-title="function_definition/function_body">{
		<span class="marker" id="mapping-1055"></span><span class="token add" data-title="function_body/expression_statement"><span class="marker" id="mapping-1056"></span><span class="token add" data-title="expression_statement/call_expression">_startBarMining(<span class="marker" id="mapping-1057"></span><span class="token add" data-title="call_expression/call_argument">_index</span>, <span class="marker" id="mapping-1058"></span><span class="token mv" id="move-dst-112" data-title="call_expression/call_argument">_landTokenId</span>, <span class="marker" id="mapping-1059"></span><span class="token add" data-title="call_expression/call_argument">_resource</span>)</span>;</span>
	}</span></span>

	<span class="marker" id="mapping-1060"></span><span class="token add" data-title="contract_body/function_definition">function afterDivested(
		<span class="marker" id="mapping-1061"></span><span class="token add" data-title="function_definition/parameter">uint256 _index</span>,
		<span class="marker" id="mapping-1062"></span><span class="token mv" id="move-dst-110" data-title="function_definition/parameter">uint256 _landTokenId</span>,
		<span class="marker" id="mapping-1063"></span><span class="token add" data-title="function_definition/parameter">address _resource</span>
	) <span class="marker" id="mapping-1064"></span><span class="token add" data-title="function_definition/visibility">internal</span> <span class="marker" id="mapping-1065"></span><span class="token add" data-title="function_definition/function_body">{
		<span class="marker" id="mapping-1066"></span><span class="token add" data-title="function_body/if_statement">if (<span class="marker" id="mapping-1067"></span><span class="token add" data-title="if_statement/binary_expression"><span class="marker" id="mapping-1068"></span><span class="token add" data-title="binary_expression/call_expression">getLandMiningStrength(<span class="marker" id="mapping-1069"></span><span class="token mv" id="move-dst-160" data-title="call_expression/call_argument">_landTokenId</span>, <span class="marker" id="mapping-1070"></span><span class="token add" data-title="call_expression/call_argument">_resource</span>)</span> &gt; 0</span>) <span class="marker" id="mapping-1071"></span><span class="token add" data-title="if_statement/block_statement">{
			mine(_landTokenId);
		}</span></span>
		<span class="marker" id="mapping-1072"></span><span class="token add" data-title="function_body/expression_statement"><span class="marker" id="mapping-1073"></span><span class="token add" data-title="expression_statement/call_expression">_stopBarMinig(<span class="marker" id="mapping-1074"></span><span class="token add" data-title="call_expression/call_argument">_index</span>, <span class="marker" id="mapping-1075"></span><span class="token mv" id="move-dst-103" data-title="call_expression/call_argument">_landTokenId</span>, <span class="marker" id="mapping-1076"></span><span class="token add" data-title="call_expression/call_argument">_resource</span>)</span>;</span>
	}</span></span>

	<span class="marker" id="mapping-1077"></span><span class="token add" data-title="contract_body/comment">/**
        @dev Divest function, A NFT can Divest from EVO Bar (LandBar or ApostleBar).
        @param _tokenId Token Id which to be unquiped.
        @param _index   Index of the Bar.
    */</span>
	<span class="marker" id="mapping-1078"></span><span class="token add" data-title="contract_body/function_definition">function divest(uint256 _tokenId, uint256 _index) public {
		_divest(_tokenId, _index);
	}</span>

	<span class="marker" id="mapping-1079"></span><span class="token add" data-title="contract_body/function_definition">function _divest(<span class="marker" id="mapping-1080"></span><span class="token add" data-title="function_definition/parameter">uint256 _tokenId</span>, <span class="marker" id="mapping-1081"></span><span class="token add" data-title="function_definition/parameter">uint256 _index</span>) <span class="marker" id="mapping-1082"></span><span class="token add" data-title="function_definition/visibility">internal</span> <span class="marker" id="mapping-1083"></span><span class="token add" data-title="function_definition/function_body">{
		<span class="marker" id="mapping-1084"></span><span class="token add" data-title="function_body/variable_declaration_statement">Bar memory bar = landId2Bars[_tokenId][_index];</span>
		<span class="marker" id="mapping-1085"></span><span class="token add" data-title="function_body/expression_statement"><span class="marker" id="mapping-1086"></span><span class="token add" data-title="expression_statement/call_expression">require(<span class="marker" id="mapping-1087"></span><span class="token add" data-title="call_expression/call_argument">bar.token != address(0)</span>, <span class="marker" id="mapping-1088"></span><span class="token add" data-title="call_expression/call_argument"><span class="marker" id="mapping-1089"></span><span class="token mv" id="move-dst-44" data-title="call_argument/string_literal">"Furnace: EMPTY"</span></span>)</span>;</span>
		<span class="marker" id="mapping-1090"></span><span class="token add" data-title="function_body/expression_statement"><span class="marker" id="mapping-1091"></span><span class="token add" data-title="expression_statement/call_expression">require(<span class="marker" id="mapping-1092"></span><span class="token add" data-title="call_expression/call_argument">bar.staker == msg.sender</span>, <span class="marker" id="mapping-1093"></span><span class="token add" data-title="call_expression/call_argument"><span class="marker" id="mapping-1094"></span><span class="token mv" id="move-dst-42" data-title="call_argument/string_literal">"Furnace: FORBIDDEN"</span></span>)</span>;</span>
		<span class="marker" id="mapping-1095"></span><span class="token add" data-title="function_body/expression_statement">ERC721(bar.token).transferFrom(address(this), bar.staker, bar.id);</span>
		<span class="marker" id="mapping-1096"></span><span class="token add" data-title="function_body/expression_statement">afterDivested(_index, _tokenId, bar.resource);</span>
		//clean
		<span class="marker" id="mapping-1097"></span><span class="token add" data-title="function_body/expression_statement">delete itemId2Status[bar.token][bar.id];</span>
		<span class="marker" id="mapping-1098"></span><span class="token add" data-title="function_body/expression_statement">delete landId2Bars[_tokenId][_index];</span>
		<span class="marker" id="mapping-1099"></span><span class="token add" data-title="function_body/emit_statement">emit Divest(
			_tokenId,
			bar.resource,
			_index,
			bar.staker,
			bar.token,
			bar.id
		);</span>
	}</span></span>

	<span class="marker" id="mapping-1100"></span><span class="token add" data-title="contract_body/function_definition">function setMaxAmount(uint256 _maxAmount) public auth {
		require(_maxAmount &gt; maxAmount, "Furnace: INVALID_MAXAMOUNT");
		maxAmount = _maxAmount;
	}</span>

	<span class="marker" id="mapping-1101"></span><span class="token add" data-title="contract_body/function_definition">function enhanceStrengthRateByIndex(
		address _resource,
		uint256 _tokenId,
		uint256 _index
	) public view returns (uint256) {
		Bar storage bar = landId2Bars[_tokenId][_index];
		if (bar.token == address(0)) {
			return 0;
		}
		IMetaDataTeller teller =
			IMetaDataTeller(registry.addressOf(CONTRACT_METADATA_TELLER));
		uint256 resourceId =
			ILandBase(registry.addressOf(CONTRACT_LAND_BASE))
				.resourceToken2RateAttrId(_resource);
		return teller.getRate(bar.token, bar.id, resourceId);
	}</span>

	<span class="marker" id="mapping-1102"></span><span class="token add" data-title="contract_body/function_definition">function enhanceStrengthRateOf(address _resource, uint256 _tokenId)
		external
		view
		returns (uint256)
	{
		uint256 rate;
		for (uint256 i = 0; i &lt; maxAmount; i++) {
			rate = rate.add(enhanceStrengthRateByIndex(_resource, _tokenId, i));
		}
		return rate;
	}</span>
}</pre></div></div></div></body></html>